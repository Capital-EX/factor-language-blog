<!DOCTYPE html>
<html dir='ltr'>
<head>
<link href='https://www.blogger.com/static/v1/widgets/55013136-widget_css_bundle.css' rel='stylesheet' type='text/css'/>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'/>
<meta content='blogger' name='generator'/>
<link href='../favicon.ico' rel='icon' type='image/x-icon'/>
<link href='index.html' rel='canonical'/>
<link rel="alternate" type="application/atom+xml" title="Factor: a practical stack language - Atom" href="http://factor-language.blogspot.com/feeds/posts/default" />
<link rel="alternate" type="application/rss+xml" title="Factor: a practical stack language - RSS" href="http://factor-language.blogspot.com/feeds/posts/default?alt=rss" />
<link rel="service.post" type="application/atom+xml" title="Factor: a practical stack language - Atom" href="https://www.blogger.com/feeds/17087850/posts/default" />
<!--Can't find substitution for tag [blog.ieCssRetrofitLinks]-->
<meta content='http://factor-language.blogspot.com/2008/' property='og:url'/>
<meta content='Factor: a practical stack language' property='og:title'/>
<meta content='&lt;a href=&quot;http://factorcode.org/slava&quot;&gt;Slava Pestov&lt;/a&gt;&#39;s weblog, primarily about &lt;a href=&quot;http://factorcode.org&quot;&gt;Factor&lt;/a&gt;.' property='og:description'/>
<title>Factor: a practical stack language: 2008</title>
<style id='page-skin-1' type='text/css'><!--
/*
-----------------------------------------------
Blogger Template Style
Name:     Stretch Denim Light
Designer: Darren Delaye
URL:      www.DarrenDelaye.com
Date:     11 Jul 2006
-----------------------------------------------
*/
body {
background: #ffffff;
margin: 0;
padding: 0px;
font: x-small Verdana, Arial;
text-align: center;
color: #333333;
font-size/* */:/**/small;
font-size: /**/small;
}
a:link {
color: #336699;
}
a:visited {
color: #336699;
}
a img {
border-width: 0;
}
#outer-wrapper {
font: normal normal 100% Verdana, Arial, Sans-serif;;
}
/* Header
----------------------------------------------- */
#header-wrapper {
margin:0;
padding: 0;
background-color: #c4e1ff;
text-align: left;
}
#header {
margin: 0 2%;
background-color: #c4e1ff;
color: #003366;
padding: 0;
font: normal normal 210% Verdana, Arial, Sans-serif;;
position: relative;
}
h1.title {
padding-top: 38px;
margin: 0 1% .1em;
line-height: 1.2em;
font-size: 100%;
}
h1.title a, h1.title a:visited {
color: #003366;
text-decoration: none;
}
#header .description {
display: block;
margin: 0 1%;
padding: 0 0 40px;
line-height: 1.4em;
font-size: 50%;
}
/* Content
----------------------------------------------- */
.clear {
clear: both;
}
#content-wrapper {
margin: 0 2%;
padding: 0 0 15px;
text-align: left;
background-color: #ffffff;
border: 1px solid #ffffff;
border-top: 0;
}
#main-wrapper {
margin-left: 1%;
width: 64%;
float: left;
background-color: #ffffff;
display: inline;       /* fix for doubling margin in IE */
word-wrap: break-word; /* fix for long text breaking sidebar float in IE */
overflow: hidden;      /* fix for long non-text content breaking IE sidebar float */
}
#sidebar-wrapper {
margin-right: 1%;
width: 29%;
float: right;
background-color: #ffffff;
display: inline;       /* fix for doubling margin in IE */
word-wrap: break-word; /* fix for long text breaking sidebar float in IE */
overflow: hidden;      /* fix for long non-text content breaking IE sidebar float */
}
/* Headings
----------------------------------------------- */
h2, h3 {
margin: 0;
}
/* Posts
----------------------------------------------- */
.date-header {
margin: 1.5em 0 0;
font-weight: normal;
color: #999999;
font-size: 100%;
}
.post {
margin: 0 0 1.5em;
padding-bottom: 1.5em;
}
.post-title {
margin: 0;
padding: 0;
font-size: 125%;
font-weight: bold;
line-height: 1.1em;
}
.post-title a, .post-title a:visited, .post-title strong {
text-decoration: none;
color: #333333;
font-weight: bold;
}
.post div {
margin: 0 0 .75em;
line-height: 1.3em;
}
.post-footer {
margin: -.25em 0 0;
color: #333333;
font-size: 87%;
}
.post-footer .span {
margin-right: .3em;
}
.post img, table.tr-caption-container {
padding: 4px;
border: 1px solid #ffffff;
}
.tr-caption-container img {
border: none;
padding: 0;
}
.post blockquote {
margin: 1em 20px;
}
.post blockquote p {
margin: .75em 0;
}
/* Comments
----------------------------------------------- */
#comments h4 {
margin: 1em 0;
color: #999999;
}
#comments h4 strong {
font-size: 110%;
}
#comments-block {
margin: 1em 0 1.5em;
line-height: 1.3em;
}
#comments-block dt {
margin: .5em 0;
}
#comments-block dd {
margin: .25em 0 0;
}
#comments-block dd.comment-footer {
margin: -.25em 0 2em;
line-height: 1.4em;
font-size: 78%;
}
#comments-block dd p {
margin: 0 0 .75em;
}
.deleted-comment {
font-style:italic;
color:gray;
}
.feed-links {
clear: both;
line-height: 2.5em;
}
#blog-pager-newer-link {
float: left;
}
#blog-pager-older-link {
float: right;
}
#blog-pager {
text-align: center;
}
/* Sidebar Content
----------------------------------------------- */
.sidebar h2 {
margin: 1.6em 0 .5em;
padding: 4px 5px;
background-color: #ffffff;
font-size: 100%;
color: #333333;
}
.sidebar ul {
margin: 0;
padding: 0;
list-style: none;
}
.sidebar li {
margin: 0;
padding-top: 0;
padding-right: 0;
padding-bottom: .5em;
padding-left: 15px;
text-indent: -15px;
line-height: 1.5em;
}
.sidebar {
color: #333333;
line-height:1.3em;
}
.sidebar .widget {
margin-bottom: 1em;
}
.sidebar .widget-content {
margin: 0 5px;
}
/* Profile
----------------------------------------------- */
.profile-img {
float: left;
margin-top: 0;
margin-right: 5px;
margin-bottom: 5px;
margin-left: 0;
padding: 4px;
border: 1px solid #ffffff;
}
.profile-data {
margin:0;
text-transform:uppercase;
letter-spacing:.1em;
font-weight: bold;
line-height: 1.6em;
font-size: 78%;
}
.profile-datablock {
margin:.5em 0 .5em;
}
.profile-textblock {
margin: 0.5em 0;
line-height: 1.6em;
}
/* Footer
----------------------------------------------- */
#footer {
clear: both;
text-align: center;
color: #333333;
}
#footer .widget {
margin:.5em;
padding-top: 20px;
font-size: 85%;
line-height: 1.5em;
text-align: left;
}
/** Page structure tweaks for layout editor wireframe */
body#layout #header {
width: 750px;
}

--></style>
<link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=17087850&amp;zx=107902e8-e226-40c6-bb3f-e93edf539d65' media='none' onload='if(media!=&#39;all&#39;)media=&#39;all&#39;' rel='stylesheet'/><noscript><link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=17087850&amp;zx=107902e8-e226-40c6-bb3f-e93edf539d65' rel='stylesheet'/></noscript>
<meta name='google-adsense-platform-account' content='ca-host-pub-1556223355139109'/>
<meta name='google-adsense-platform-domain' content='blogspot.com'/>

</head>
<body>
<div class='navbar section' id='navbar'><div class='widget Navbar' data-version='1' id='Navbar1'><script type="text/javascript">
    function setAttributeOnload(object, attribute, val) {
      if(window.addEventListener) {
        window.addEventListener('load',
          function(){ object[attribute] = val; }, false);
      } else {
        window.attachEvent('onload', function(){ object[attribute] = val; });
      }
    }
  </script>
<div id="navbar-iframe-container"></div>
<script type="text/javascript" src="https://apis.google.com/js/platform.js"></script>
<script type="text/javascript">
      gapi.load("gapi.iframes:gapi.iframes.style.bubble", function() {
        if (gapi.iframes && gapi.iframes.getContext) {
          gapi.iframes.getContext().openChild({
              url: 'https://www.blogger.com/navbar.g?targetBlogID\x3d17087850\x26blogName\x3dFactor:+a+practical+stack+language\x26publishMode\x3dPUBLISH_MODE_BLOGSPOT\x26navbarType\x3dBLUE\x26layoutType\x3dLAYOUTS\x26searchRoot\x3dhttps://factor-language.blogspot.com/search\x26blogLocale\x3den_US\x26v\x3d2\x26homepageUrl\x3dhttp://factor-language.blogspot.com/\x26vt\x3d1910212838315471456',
              where: document.getElementById("navbar-iframe-container"),
              id: "navbar-iframe"
          });
        }
      });
    </script><script type="text/javascript">
(function() {
var script = document.createElement('script');
script.type = 'text/javascript';
script.src = '//pagead2.googlesyndication.com/pagead/js/google_top_exp.js';
var head = document.getElementsByTagName('head')[0];
if (head) {
head.appendChild(script);
}})();
</script>
</div></div>
<div id='outer-wrapper'><div id='wrap2'>
<!-- skip links for text browsers -->
<span id='skiplinks' style='display:none;'>
<a href='index.html#main'>skip to main </a> |
      <a href='index.html#sidebar'>skip to sidebar</a>
</span>
<div id='header-wrapper'>
<div class='header section' id='header'><div class='widget Header' data-version='1' id='Header1'>
<div id='header-inner'>
<div class='titlewrapper'>
<h1 class='title'>
<a href='../index.html'>
Factor: a practical stack language
</a>
</h1>
</div>
<div class='descriptionwrapper'>
<p class='description'><span><a href="http://factorcode.org/slava">Slava Pestov</a>'s weblog, primarily about <a href="http://factorcode.org">Factor</a>.</span></p>
</div>
</div>
</div></div>
</div>
<div id='content-wrapper'>
<div id='crosscol-wrapper' style='text-align:center'>
<div class='crosscol no-items section' id='crosscol'></div>
</div>
<div id='main-wrapper'>
<div class='main section' id='main'><div class='widget Blog' data-version='1' id='Blog1'>
<div class='blog-posts hfeed'>

          <div class="date-outer">
        
<h2 class='date-header'><span>Friday, December 19, 2008</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='8259971192556026555' itemprop='postId'/>
<a name='8259971192556026555'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='12/discussion-of-concatenative-languages.html'>Discussion of concatenative languages on various blogs</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-8259971192556026555' itemprop='description articleBody'>
A couple of bloggers are exploring concatenative languages and have posted interesting articles, with more depth than the usual "<code>dup *</code> squares an integer" cursory glance:<br /><ul><li>Ruminations of a Programmer - <a href="http://debasishg.blogspot.com/2008/12/enjoy.html">enJOY</a></li><li>Ruminations of a Programmer - <a href="http://debasishg.blogspot.com/2008/12/combinators-for-fun-and-profit.html">Combinators for fun and profit</a></li><li>Code Commit - <a href="http://www.codecommit.com/blog/cat/the-joy-of-concatenative-languages-part-1">The joy of concatenative languages - part 1</a></li></li><li>Code Commit - <a href="http://www.codecommit.com/blog/cat/the-joy-of-concatenative-languages-part-2">The joy of concatenative languages - part 2</a></li></ul><br /><a href="http://elasticdog.com/">Aaron Schaefer</a> (elasticdog in <code>#concatenative</code>; he's been contributing to our math library and writing project euler solutions) has written a couple of introductory Factor articles too, and is working on a third installment.<br /><br />Things have also been picking up in the <code>#concatenative</code> IRC channel on FreeNode, and usually there are 60-70 people online. Lots of interesting discussion going on there.<br /><br />Finally, I'll take this opportunity to plug the <a href="http://concatenative.org/wiki/view/Front%20Page">concatenative languages wiki</a>, and remind everyone that it running on a web framework and server written in a concatenative language. Other than an issue with our O/R mapper that we fixed recently, it has been running without any problems. It has been serving between 10,000 and 24,000 hits a day; I'd like to see it hit 10 or 20 times that number and see how it holds up.
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2008/12/discussion-of-concatenative-languages.html' itemprop='url'/>
<a class='timestamp-link' href='12/discussion-of-concatenative-languages.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2008-12-19T06:15:00-05:00'>6:15 AM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=8259971192556026555' onclick=''>
No comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=8259971192556026555' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=8259971192556026555&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8259971192556026555&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8259971192556026555&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8259971192556026555&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8259971192556026555&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8259971192556026555&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Monday, December 15, 2008</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='http://factorcode.org/chart1.png' itemprop='image_url'/>
<meta content='17087850' itemprop='blogId'/>
<meta content='8730663294961200084' itemprop='postId'/>
<a name='8730663294961200084'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='12/prevalence-of-shuffle-words-and.html'>Prevalence of shuffle words and dataflow combinators</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-8730663294961200084' itemprop='description articleBody'>
Today on IRC, <code>binarybandit</code> wrote this word:<br /><pre><font color="#000000"><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>pie-chart</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>keys</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>values</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>url</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#006633">[</font> <font color="#006666">&quot;</font><font color="#006666">|</font><font color="#006666">&quot;</font> join <font color="#006633">]</font> <font color="#006633">[</font> <font color="#006633">[</font> number&gt;string <font color="#006633">]</font> map <font color="#006666">&quot;</font><font color="#006666">,</font><font color="#006666">&quot;</font> join <font color="#006633">]</font> bi*<br />    <font color="#006666">&quot;</font><font color="#006666">http://chart.apis.google.com/chart?cht=p&amp;chs=500x250&amp;chl=%s&amp;chd=t:%s</font><font color="#006666">&quot;</font> sprintf <font color="#000000"><strong>;</strong></font><br /></font></pre><br />(Side note: it uses the recently-contributed <code>printf</code> vocabulary, which is a nice piece of work: it parses the format string uses PEGs and compiles to quotations at compile time).<br /><br />This inspired me to make some pie charts showing the frequency of usages of <a href="http://docs.factorcode.org/content/article-shuffle-words.html">shuffle words</a> and <a href="http://docs.factorcode.org/content/article-dataflow.html">dataflow combinators</a> in the Factor library. So first, we need a word which takes a sequence of words and counts the number of usages of each, normalizing the results so that their sum is 1:<br /><pre><font color="#000000"><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>usage-histogram</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>words</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>keys</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>values</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#006633">[</font> <font color="#006633">[</font> name&gt;&gt; <font color="#006633">]</font> <font color="#006633">[</font> usage length <font color="#006633">]</font> bi <font color="#006633">]</font> <font color="#006633">{</font> <font color="#006633">}</font> map&gt;assoc<br />    dup values sum '<font color="#006633">[</font> _ /f <font color="#006633">]</font> assoc-map<br />    sort-values unzip <font color="#000000"><strong>;</strong></font><br /></font></pre><br />Now we can use a meta-programming trick to extract the list of shufflers from the shuffle words help article:<br /><pre><font color="#000000"><font color="#006666">&quot;</font><font color="#006666">shuffle-words</font><font color="#006666">&quot;</font> &gt;link uses <font color="#006633">[</font> word? <font color="#006633">]</font> filter usage-histogram pie-chart print<br /></font></pre><br />Here is the resulting chart:<br /><img src="http://factorcode.org/chart1.png"><br />Note that it counts the number of usages of each shuffler, so a word that calls a shuffler more than once is not counted, and a word which uses two distinct shufflers is counted twice. You can see that dup, drop and swap are by far the most popular, and the more complex patterns are rarely used. It is interesting that when beginners first start writing Factor they tend to write code which is heavily biased towards the less frequently-used shufflers. I think teaching dataflow combinators before shufflers can help here, because they make it easier to structure your code in a clean way.<br /><br />For cleave/spread/apply combinators, we have to do a bit more work to get a list of them programatically, since they're spread over several help articles:<br /><pre><font color="#000000"><font color="#006633">[</font> <font color="#006666">&quot;</font><font color="#006666">cleave-combinators</font><font color="#006666">&quot;</font> <font color="#006666">&quot;</font><font color="#006666">spread-combinators</font><font color="#006666">&quot;</font> <font color="#006666">&quot;</font><font color="#006666">apply-combinators</font><font color="#006666">&quot;</font> <font color="#006633">]</font><br /><font color="#006633">[</font> &gt;link uses <font color="#006633">]</font> map concat <font color="#006633">{</font> either? both? <font color="#006633">}</font> diff<br /><font color="#006633">[</font> word? <font color="#006633">]</font> filter<br /></font></pre><br />Now we can make the pie chart as before. Here is the result:<br /><img src="http://factorcode.org/chart2.png"><br />Again, <code>bi</code> completely dominates.<br /><br />I'm not sure what to make of these results, other than that the Google Charts API is pretty nifty, and that there is untapped potential for "code data mining" in Factor's reflection capabilities. We could use this to discover potential abstractions and patterns.
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2008/12/prevalence-of-shuffle-words-and.html' itemprop='url'/>
<a class='timestamp-link' href='12/prevalence-of-shuffle-words-and.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2008-12-15T18:27:00-05:00'>6:27 PM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=8730663294961200084' onclick=''>
No comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=8730663294961200084' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=8730663294961200084&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8730663294961200084&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8730663294961200084&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8730663294961200084&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8730663294961200084&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8730663294961200084&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Thursday, December 04, 2008</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='6405874209088924172' itemprop='postId'/>
<a name='6405874209088924172'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='12/arrays-of-unboxed-primitive-values-and.html'>Arrays of unboxed primitive values, and a faster Mersenne Twister</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-6405874209088924172' itemprop='description articleBody'>
I added efficient arrays of integers and floats to Factor. We've had <a href="http://docs.factorcode.org/content/vocab-byte-arrays.html">byte-arrays</a> and <a href="http://docs.factorcode.org/content/vocab-float-arrays.html">float-arrays</a> for a while; this code is essentially a generalization of these to every primitive C type: chars, shorts, ints, longs, long longs, unsigned version of all of these, as well as floats and doubles.<br /><h3>Specialized arrays</h3><br />For each primitive C type, there is a vocabulary named <code>specialized-arrays.<i>type</i></code>, which defines a class named <code><i>type</i>-array</code>, and several related words: a constructor, and a conversion word for converting existing sequences to specialized arrays of this type. As with all sequence types, the class implements methods for <code>length</code>, <code>nth</code> and <code>set-nth</code>; there is also a literal syntax for parsing and printing specialized arrays. An example:<br /><pre><font color="#000000"><font color="#000000"><strong>USE:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>specialized-arrays.int</strong></font><br />int-array<font color="#006633">{</font> <font color="#ff0000">584</font> <font color="#ff0000">-13</font> <font color="#ff0000">11</font> <font color="#006633">}</font> <font color="#006633">[</font> <font color="#ff0000">10</font> + <font color="#006633">]</font> map<br /></font></pre><br /><h3>Specialized vectors</h3><br />There are also resizeable versions of all of these, in <code>specialized-vectors.<i>type</i></code>. These work like ordinary vectors; you can use words such as <code>push</code> and <code>pop</code>, accumulating a stream of values in a vector.<br /><h3>Direct arrays</h3><br />A third variant is also provided. These are the "direct specialized arrays". Sometimes when working with a C library, the library hands you a pointer to some data which is to be viewed as an array of primitive values. Direct arrays accomplish this. For every primitive C type, the <code>specialized-arrays.direct.<i>type</i></code> vocabulary provides a word named <code>&lt;direct-<i>type</i>-array&gt;</code> which takes an alien pointer and a length. It wraps them in a tuple which responds to the sequence protocol by reading from memory.<br /><h3>Memory-mapped files</h3><br />Direct arrays are useful in another context, and that is when working with memory-mapped files. Again, for every primitive C type, there is a vocabulary, <code>io.mmap.<i>type</i></code>. It defines two words, <code>&lt;mapped-<i>type</i>-array&gt;</code> and <code>with-mapped-<i>type</i>-file</code>. Here is an example usage of the latter: we're mapping in a file of floating point numbers and adding them up:<pre><font color="#000000"><font color="#006633">[</font> <font color="#ff0000">0.0</font> <font color="#006633">[</font> + <font color="#006633">]</font> reduce <font color="#006633">]</font> with-mapped-float-file<br /></font></pre>We've had <code>io.mmap</code> for a while, but specialized arrays make this library a lot more useful.<br /><br />This is all really powerful stuff, because on one hand, we have these high-level data types that behave like any other Factor sequence and can be used interchangeably with sequence utility words, but on the other hand, not only do they offer a space savings over heterogeneous <a href="http://docs.factorcode.org/content/vocab-arrays.html">arrays</a> by avoiding boxing, they also have the potential to improve performance -- the low-level primitives they're built on are already optimized by the compiler, and it is possible to write code which operates on specialized float and integer arrays without any boxing at all.<br /><h3>Mersenne Twister</h3><br />A good example of an algorithm which benefits from specialized arrays is the <a href="http://en.wikipedia.org/wiki/Mersenne_Twister">Mersenne Twister random number generator</a>. The <a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=basis/random/mersenne-twister/mersenne-twister.factor;hb=HEAD">Factor implementation</a> is very straightforward, and shorter than the <a href="http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/CODES/mt19937ar.c">C version</a>. I changed it to use a <code>uint-array</code> instead of a normal <code>array</code> to store the random generator state. After making a few more tweaks, the time taken to generate a 100,000,000-element byte array of random bytes on my Mac Book Pro went down to 5 seconds, from 37 seconds!<br /><br />Here is the main method of the Mersenne Twister, <code>random-32*</code>, and its surrounding utility words:<br /><pre><font color="#000000"><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>mt-n</strong></font> <font color="#ff0000">624</font> <font color="#000000"><strong>;</strong></font> inline<br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>mt-m</strong></font> <font color="#ff0000">397</font> <font color="#000000"><strong>;</strong></font> inline<br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>mt-a</strong></font> <font color="#003333">HEX:</font><font color="#003333"> </font><font color="#003333">9908b0df</font> <font color="#000000"><strong>;</strong></font> inline<br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>mersenne-wrap</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>n</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>n</strong></font><font color="#793b1c"><strong>'</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    dup mt-n &gt; <font color="#006633">[</font> mt-n - <font color="#006633">]</font> when <font color="#000000"><strong>;</strong></font> inline<br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>wrap-nth</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>n</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>seq</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>obj</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#006633">[</font> mersenne-wrap <font color="#006633">]</font> dip nth-unsafe <font color="#000000"><strong>;</strong></font> inline<br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>set-wrap-nth</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>obj</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>n</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>seq</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#006633">[</font> mersenne-wrap <font color="#006633">]</font> dip set-nth-unsafe <font color="#000000"><strong>;</strong></font> inline<br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>calculate-y</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>n</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>seq</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>y</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#006633">[</font> wrap-nth <font color="#ff0000">31</font> mask-bit <font color="#006633">]</font><br />    <font color="#006633">[</font> <font color="#006633">[</font> 1+ <font color="#006633">]</font> <font color="#006633">[</font> wrap-nth <font color="#006633">]</font> bi* <font color="#ff0000">31</font> bits <font color="#006633">]</font> 2bi bitor <font color="#000000"><strong>;</strong></font> inline<br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>(mt-generate)</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>n</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>seq</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>next</strong></font><font color="#793b1c"><strong>-</strong></font><font color="#793b1c"><strong>mt</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#006633">[</font><br />        calculate-y<br />        <font color="#006633">[</font> 2/ <font color="#006633">]</font> <font color="#006633">[</font> odd? mt-a <font color="#ff0000">0</font> ? <font color="#006633">]</font> bi bitxor<br />    <font color="#006633">]</font> <font color="#006633">[</font><br />        <font color="#006633">[</font> mt-m + <font color="#006633">]</font> <font color="#006633">[</font> wrap-nth <font color="#006633">]</font> bi*<br />    <font color="#006633">]</font> 2bi bitxor <font color="#000000"><strong>;</strong></font> inline<br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>mt-generate</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>mt</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#006633">[</font><br />        mt-n swap seq&gt;&gt; '<font color="#006633">[</font><br />            _ <font color="#006633">[</font> (mt-generate) <font color="#006633">]</font> <font color="#006633">[</font> set-wrap-nth <font color="#006633">]</font> 2bi<br />        <font color="#006633">]</font> each<br />    <font color="#006633">]</font> <font color="#006633">[</font> <font color="#ff0000">0</font> &gt;&gt;i drop <font color="#006633">]</font> bi <font color="#000000"><strong>;</strong></font> inline<br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>mt-temper</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>y</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>yt</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    dup <font color="#ff0000">-11</font> shift bitxor<br />    dup <font color="#ff0000">7</font> shift <font color="#003333">HEX:</font><font color="#003333"> </font><font color="#003333">9d2c5680</font> bitand bitxor<br />    dup <font color="#ff0000">15</font> shift <font color="#003333">HEX:</font><font color="#003333"> </font><font color="#003333">efc60000</font> bitand bitxor<br />    dup <font color="#ff0000">-18</font> shift bitxor <font color="#000000"><strong>;</strong></font> inline<br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>next-index</strong></font>  <font color="#6600cc">( </font><font color="#793b1c"><strong>mt</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>i</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    dup i&gt;&gt; dup mt-n &lt; <font color="#006633">[</font> nip <font color="#006633">]</font> <font color="#006633">[</font> drop mt-generate <font color="#ff0000">0</font> <font color="#006633">]</font> if <font color="#000000"><strong>;</strong></font> inline<br /><br />M: mersenne-twister random-32* <font color="#6600cc">( </font><font color="#793b1c"><strong>mt</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>r</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#006633">[</font> next-index <font color="#006633">]</font><br />    <font color="#006633">[</font> seq&gt;&gt; wrap-nth mt-temper <font color="#006633">]</font><br />    <font color="#006633">[</font> <font color="#006633">[</font> 1+ <font color="#006633">]</font> change-i drop <font color="#006633">]</font> tri <font color="#000000"><strong>;</strong></font><br /></font></pre><br />A naive implementation of Factor would struggle with this code because of method dispatch overhead (all arithmetic and sequence access is generic), and because of overflow checks on integer arithmetic (integers have arbitrary precision in Factor). Thankfully, the Factor implementation is not naive. The high-level optimizer, applied to the above code, produces the following output -- note that the translation from high-level IR back to Factor code is imprecise, and some IR nodes cannot be expressed, hence the <code>"COMPLEX SHUFFLE"</code> strings that appear here:<br /><pre><font color="#000000"><font color="#006633">[</font><br />    dup <font color="#999999">&gt;r</font> dup <font color="#ff0000">3</font> slot dup <font color="#ff0000">624</font> fixnum&lt;<br />    <font color="#006633">[</font> nip <font color="#006633">]</font> <font color="#006633">[</font><br />        drop dup <font color="#999999">&gt;r</font> <font color="#ff0000">624</font> swap <font color="#ff0000">2</font> slot<br />        <font color="#999999">&gt;r</font> <font color="#999999">r&gt;</font> <font color="#999999">&gt;r</font> <font color="#999999">r&gt;</font> <font color="#ff0000">0</font> -rot <font color="#000000"><strong>\</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>(</strong></font> gensym ) <font color="#006633">[</font><br />            pick pick fixnum&lt; <font color="#006633">[</font><br />                swap <font color="#999999">&gt;r</font> 2dup <font color="#006666">&quot;</font><font color="#006666">COMPLEX</font><font color="#006666"> </font><font color="#006666">SHUFFLE</font><font color="#006666">&quot;</font> <font color="#999999">&gt;r</font> <font color="#999999">r&gt;</font> 2dup<br />                <font color="#006666">&quot;</font><font color="#006666">COMPLEX</font><font color="#006666"> </font><font color="#006666">SHUFFLE</font><font color="#006666">&quot;</font> 2dup <font color="#006666">&quot;</font><font color="#006666">COMPLEX</font><font color="#006666"> </font><font color="#006666">SHUFFLE</font><font color="#006666">&quot;</font> 2dup<br />                <font color="#006666">&quot;</font><font color="#006666">COMPLEX</font><font color="#006666"> </font><font color="#006666">SHUFFLE</font><font color="#006666">&quot;</font> <font color="#999999">&gt;r</font> <font color="#999999">r&gt;</font> <font color="#ff0000">3</font> slot<br />                swap <font color="#ff0000">4</font> fixnum*fast<br />                alien-unsigned-4 <font color="#ff0000">2147483648</font> fixnum-bitand<br />                <font color="#006666">&quot;</font><font color="#006666">COMPLEX</font><font color="#006666"> </font><font color="#006666">SHUFFLE</font><font color="#006666">&quot;</font> <font color="#999999">&gt;r</font> <font color="#ff0000">1</font> fixnum+fast<br />                <font color="#999999">r&gt;</font> <font color="#999999">&gt;r</font> <font color="#999999">r&gt;</font> <font color="#ff0000">3</font> slot swap <font color="#ff0000">4</font> fixnum*fast<br />                alien-unsigned-4 <font color="#ff0000">2147483647</font> fixnum-bitand<br />                fixnum-bitor dup <font color="#999999">&gt;r</font> <font color="#ff0000">-1</font> fixnum-shift-fast<br />                <font color="#999999">r&gt;</font> <font color="#ff0000">1</font> fixnum-bitand <font color="#ff0000">1</font> eq? <font color="#ff0000">2567483615</font> <font color="#ff0000">0</font> rot<br />                <font color="#006633">[</font> drop <font color="#006633">]</font> <font color="#006633">[</font> nip <font color="#006633">]</font> if fixnum-bitxor<br />                <font color="#006666">&quot;</font><font color="#006666">COMPLEX</font><font color="#006666"> </font><font color="#006666">SHUFFLE</font><font color="#006666">&quot;</font> <font color="#999999">&gt;r</font> <font color="#ff0000">397</font> fixnum+fast<br />                <font color="#999999">r&gt;</font> <font color="#999999">&gt;r</font> dup <font color="#ff0000">624</font> fixnum&gt;<br />                <font color="#006633">[</font> <font color="#ff0000">624</font> fixnum-fast <font color="#006633">]</font> <font color="#006633">[</font> <font color="#006633">]</font> if <font color="#999999">r&gt;</font> <font color="#ff0000">3</font> slot<br />                swap <font color="#ff0000">4</font> fixnum*fast<br />                alien-unsigned-4 fixnum-bitxor<br />                <font color="#006666">&quot;</font><font color="#006666">COMPLEX</font><font color="#006666"> </font><font color="#006666">SHUFFLE</font><font color="#006666">&quot;</font> <font color="#999999">&gt;r</font> <font color="#999999">r&gt;</font> <font color="#ff0000">3</font> slot<br />                swap <font color="#ff0000">4</font> fixnum*fast<br />                set-alien-unsigned-4 <font color="#006666">&quot;</font><font color="#006666">COMPLEX</font><font color="#006666"> </font><font color="#006666">SHUFFLE</font><font color="#006666">&quot;</font> <font color="#999999">r&gt;</font> swap<br />                <font color="#006666">&quot;</font><font color="#006666">COMPLEX</font><font color="#006666"> </font><font color="#006666">SHUFFLE</font><font color="#006666">&quot;</font> <font color="#ff0000">1</font> fixnum+fast<br />                <font color="#006666">&quot;</font><font color="#006666">COMPLEX</font><font color="#006666"> </font><font color="#006666">SHUFFLE</font><font color="#006666">&quot;</font> <font color="#6600cc">( </font><font color="#793b1c"><strong>gensym</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />            <font color="#006633">]</font> <font color="#006633">[</font> 3drop <font color="#006633">]</font> if<br />        <font color="#006633">]</font> label <font color="#999999">r&gt;</font> <font color="#999999">&gt;r</font> <font color="#ff0000">0</font> <font color="#999999">r&gt;</font> <font color="#ff0000">3</font> set-slot <font color="#ff0000">0</font><br />    <font color="#006633">]</font> if <font color="#999999">r&gt;</font> dup <font color="#999999">&gt;r</font> <font color="#ff0000">2</font> slot <font color="#999999">&gt;r</font> <font color="#999999">r&gt;</font> <font color="#ff0000">3</font> slot swap <font color="#ff0000">4</font> fixnum*fast<br />    alien-unsigned-4 dup <font color="#ff0000">-11</font> fixnum-shift-fast fixnum-bitxor<br />    dup <font color="#ff0000">7</font> fixnum-shift-fast <font color="#ff0000">2636928640</font> fixnum-bitand<br />    fixnum-bitxor dup <font color="#ff0000">15</font> fixnum-shift-fast<br />    <font color="#ff0000">4022730752</font> fixnum-bitand fixnum-bitxor<br />    dup <font color="#ff0000">-18</font> fixnum-shift-fast fixnum-bitxor <font color="#999999">r&gt;</font> dup <font color="#999999">&gt;r</font> <font color="#ff0000">3</font> slot<br />    <font color="#ff0000">1</font> fixnum+fast <font color="#999999">r&gt;</font> swap swap <font color="#999999">&gt;r</font> <font color="#999999">r&gt;</font> <font color="#ff0000">3</font> set-slot<br /><font color="#006633">]</font><br /></font></pre><br />Only primitive calls remain; everything else has evaporated after 11 distinct optimization passes. A lot of redundant stack shuffling still remains; the low-level optimizer eliminates that and produces a sequence of low-level IR instructions:<br /><pre><font color="#000000">=== word: mersenne-twister=&gt;random-32*, label: mersenne-twister=&gt;random-32*<br /><br />_label <font color="#ff0000">0</font> <br />##prologue <br />_label <font color="#ff0000">1</font> <br />##inc-r <font color="#ff0000">1</font> <br />##inc-d <font color="#ff0000">1</font> <br />##peek V int-regs <font color="#ff0000">1368412</font> D <font color="#ff0000">1</font> <br />##replace V int-regs <font color="#ff0000">1368412</font> R <font color="#ff0000">0</font> <br />##slot-imm V int-regs <font color="#ff0000">1368417</font> V int-regs <font color="#ff0000">1368412</font> <font color="#ff0000">3</font> <font color="#ff0000">2</font> <br />##replace V int-regs <font color="#ff0000">1368417</font> D <font color="#ff0000">0</font> <br />_compare-imm-branch <font color="#ff0000">3</font> V int-regs <font color="#ff0000">1368417</font> <font color="#ff0000">4992</font> cc&gt;= <br />_label <font color="#ff0000">2</font> <br />##inc-d <font color="#ff0000">-1</font> <br />##peek V int-regs <font color="#ff0000">1368425</font> D <font color="#ff0000">-1</font> <br />##replace V int-regs <font color="#ff0000">1368425</font> D <font color="#ff0000">0</font> <br />_branch <font color="#ff0000">13</font> <br />_label <font color="#ff0000">3</font> <br />##inc-r <font color="#ff0000">1</font> <br />##inc-d <font color="#ff0000">1</font> <br />##peek V int-regs <font color="#ff0000">1368427</font> D <font color="#ff0000">2</font> <br />##replace V int-regs <font color="#ff0000">1368427</font> R <font color="#ff0000">0</font> <br />##load-immediate V int-regs <font color="#ff0000">1368429</font> <font color="#ff0000">4992</font> <br />##slot-imm V int-regs <font color="#ff0000">1368434</font> V int-regs <font color="#ff0000">1368427</font> <font color="#ff0000">2</font> <font color="#ff0000">2</font> <br />##load-immediate V int-regs <font color="#ff0000">1368439</font> <font color="#ff0000">0</font> <br />##replace V int-regs <font color="#ff0000">1368434</font> D <font color="#ff0000">0</font> <br />##replace V int-regs <font color="#ff0000">1368429</font> D <font color="#ff0000">1</font> <br />##replace V int-regs <font color="#ff0000">1368439</font> D <font color="#ff0000">2</font> <br />##loop-entry <br />_label <font color="#ff0000">4</font> <br />##peek V int-regs <font color="#ff0000">1368443</font> D <font color="#ff0000">2</font> <br />_compare-imm-branch <font color="#ff0000">11</font> V int-regs <font color="#ff0000">1368443</font> <font color="#ff0000">4992</font> cc&gt;= <br />_label <font color="#ff0000">5</font> <br />##inc-r <font color="#ff0000">7</font> <br />##peek V int-regs <font color="#ff0000">1368453</font> D <font color="#ff0000">1</font> <br />##peek V int-regs <font color="#ff0000">1368454</font> D <font color="#ff0000">0</font> <br />##replace V int-regs <font color="#ff0000">1368453</font> R <font color="#ff0000">6</font> <br />##peek V int-regs <font color="#ff0000">1368456</font> D <font color="#ff0000">2</font> <br />##replace V int-regs <font color="#ff0000">1368454</font> R <font color="#ff0000">4</font> <br />##replace V int-regs <font color="#ff0000">1368456</font> R <font color="#ff0000">5</font> <br />##replace V int-regs <font color="#ff0000">1368454</font> R <font color="#ff0000">2</font> <br />##replace V int-regs <font color="#ff0000">1368456</font> R <font color="#ff0000">3</font> <br />##replace V int-regs <font color="#ff0000">1368454</font> R <font color="#ff0000">0</font> <br />##replace V int-regs <font color="#ff0000">1368456</font> R <font color="#ff0000">1</font> <br />##slot-imm V int-regs <font color="#ff0000">1368478</font> V int-regs <font color="#ff0000">1368454</font> <font color="#ff0000">3</font> <font color="#ff0000">2</font> <br />##copy V int-regs <font color="#ff0000">1368483</font> V int-regs <font color="#ff0000">1368456</font> <br />##shl-imm V int-regs <font color="#ff0000">1368483</font> V int-regs <font color="#ff0000">1368483</font> <font color="#ff0000">2</font> <br />##copy V int-regs <font color="#ff0000">1368486</font> V int-regs <font color="#ff0000">1368483</font> <br />##sar-imm V int-regs <font color="#ff0000">1368486</font> V int-regs <font color="#ff0000">1368486</font> <font color="#ff0000">3</font> <br />##add-imm V int-regs <font color="#ff0000">1368487</font> V int-regs <font color="#ff0000">1368478</font> <font color="#ff0000">13</font> <br />##add V int-regs <font color="#ff0000">1368489</font> V int-regs <font color="#ff0000">1368486</font> V int-regs <font color="#ff0000">1368487</font> <br />##alien-unsigned-4 V int-regs <font color="#ff0000">1368490</font> V int-regs <font color="#ff0000">1368489</font> <br />##copy V int-regs <font color="#ff0000">1368491</font> V int-regs <font color="#ff0000">1368490</font> <br />##shl-imm V int-regs <font color="#ff0000">1368491</font> V int-regs <font color="#ff0000">1368491</font> <font color="#ff0000">3</font> <br />##load-immediate V int-regs <font color="#ff0000">1368492</font> <font color="#ff0000">17179869184</font> <br />##copy V int-regs <font color="#ff0000">1368495</font> V int-regs <font color="#ff0000">1368491</font> <br />##and V int-regs <font color="#ff0000">1368495</font> V int-regs <font color="#ff0000">1368495</font> V int-regs <font color="#ff0000">1368492</font> <br />##add-imm V int-regs <font color="#ff0000">1368501</font> V int-regs <font color="#ff0000">1368456</font> <font color="#ff0000">8</font> <br />##copy V int-regs <font color="#ff0000">1368512</font> V int-regs <font color="#ff0000">1368501</font> <br />##shl-imm V int-regs <font color="#ff0000">1368512</font> V int-regs <font color="#ff0000">1368512</font> <font color="#ff0000">2</font> <br />##copy V int-regs <font color="#ff0000">1368515</font> V int-regs <font color="#ff0000">1368512</font> <br />##sar-imm V int-regs <font color="#ff0000">1368515</font> V int-regs <font color="#ff0000">1368515</font> <font color="#ff0000">3</font> <br />##add V int-regs <font color="#ff0000">1368518</font> V int-regs <font color="#ff0000">1368515</font> V int-regs <font color="#ff0000">1368487</font> <br />##alien-unsigned-4 V int-regs <font color="#ff0000">1368519</font> V int-regs <font color="#ff0000">1368518</font> <br />##copy V int-regs <font color="#ff0000">1368520</font> V int-regs <font color="#ff0000">1368519</font> <br />##shl-imm V int-regs <font color="#ff0000">1368520</font> V int-regs <font color="#ff0000">1368520</font> <font color="#ff0000">3</font> <br />##load-immediate V int-regs <font color="#ff0000">1368521</font> <font color="#ff0000">17179869176</font> <br />##copy V int-regs <font color="#ff0000">1368524</font> V int-regs <font color="#ff0000">1368520</font> <br />##and V int-regs <font color="#ff0000">1368524</font> V int-regs <font color="#ff0000">1368524</font> V int-regs <font color="#ff0000">1368521</font> <br />##copy V int-regs <font color="#ff0000">1368527</font> V int-regs <font color="#ff0000">1368495</font> <br />##or V int-regs <font color="#ff0000">1368527</font> V int-regs <font color="#ff0000">1368527</font> V int-regs <font color="#ff0000">1368524</font> <br />##copy V int-regs <font color="#ff0000">1368532</font> V int-regs <font color="#ff0000">1368527</font> <br />##sar-imm V int-regs <font color="#ff0000">1368532</font> V int-regs <font color="#ff0000">1368532</font> <font color="#ff0000">4</font> <br />##copy V int-regs <font color="#ff0000">1368533</font> V int-regs <font color="#ff0000">1368532</font> <br />##shl-imm V int-regs <font color="#ff0000">1368533</font> V int-regs <font color="#ff0000">1368533</font> <font color="#ff0000">3</font> <br />##replace V int-regs <font color="#ff0000">1368533</font> D <font color="#ff0000">2</font> <br />##copy V int-regs <font color="#ff0000">1368537</font> V int-regs <font color="#ff0000">1368527</font> <br />##and-imm V int-regs <font color="#ff0000">1368537</font> V int-regs <font color="#ff0000">1368537</font> <font color="#ff0000">8</font> <br />##load-immediate V int-regs <font color="#ff0000">1368542</font> <font color="#ff0000">20539868920</font> <br />##load-immediate V int-regs <font color="#ff0000">1368543</font> <font color="#ff0000">0</font> <br />##replace V int-regs <font color="#ff0000">1368543</font> D <font color="#ff0000">0</font> <br />##replace V int-regs <font color="#ff0000">1368542</font> D <font color="#ff0000">1</font> <br />_compare-imm-branch <font color="#ff0000">7</font> V int-regs <font color="#ff0000">1368537</font> <font color="#ff0000">8</font> cc/= <br />_label <font color="#ff0000">6</font> <br />##inc-d <font color="#ff0000">-1</font> <br />_branch <font color="#ff0000">8</font> <br />_label <font color="#ff0000">7</font> <br />##inc-d <font color="#ff0000">-1</font> <br />##peek V int-regs <font color="#ff0000">1368550</font> D <font color="#ff0000">-1</font> <br />##replace V int-regs <font color="#ff0000">1368550</font> D <font color="#ff0000">0</font> <br />_label <font color="#ff0000">8</font> <br />##inc-r <font color="#ff0000">-1</font> <br />##peek V int-regs <font color="#ff0000">1368551</font> D <font color="#ff0000">1</font> <br />##peek V int-regs <font color="#ff0000">1368552</font> D <font color="#ff0000">0</font> <br />##copy V int-regs <font color="#ff0000">1368553</font> V int-regs <font color="#ff0000">1368551</font> <br />##xor V int-regs <font color="#ff0000">1368553</font> V int-regs <font color="#ff0000">1368553</font> V int-regs <font color="#ff0000">1368552</font> <br />##replace V int-regs <font color="#ff0000">1368553</font> D <font color="#ff0000">1</font> <br />##peek V int-regs <font color="#ff0000">1368554</font> R <font color="#ff0000">0</font> <br />##peek V int-regs <font color="#ff0000">1368555</font> R <font color="#ff0000">-1</font> <br />##add-imm V int-regs <font color="#ff0000">1368559</font> V int-regs <font color="#ff0000">1368554</font> <font color="#ff0000">3176</font> <br />##replace V int-regs <font color="#ff0000">1368555</font> R <font color="#ff0000">0</font> <br />##replace V int-regs <font color="#ff0000">1368559</font> D <font color="#ff0000">0</font> <br />_compare-imm-branch <font color="#ff0000">10</font> V int-regs <font color="#ff0000">1368559</font> <font color="#ff0000">4992</font> cc&lt;= <br />_label <font color="#ff0000">9</font> <br />##peek V int-regs <font color="#ff0000">1368569</font> D <font color="#ff0000">0</font> <br />##sub-imm V int-regs <font color="#ff0000">1368570</font> V int-regs <font color="#ff0000">1368569</font> <font color="#ff0000">4992</font> <br />##replace V int-regs <font color="#ff0000">1368570</font> D <font color="#ff0000">0</font> <br />_label <font color="#ff0000">10</font> <br />##inc-r <font color="#ff0000">-6</font> <br />##inc-d <font color="#ff0000">1</font> <br />##peek V int-regs <font color="#ff0000">1368571</font> R <font color="#ff0000">-6</font> <br />##slot-imm V int-regs <font color="#ff0000">1368574</font> V int-regs <font color="#ff0000">1368571</font> <font color="#ff0000">3</font> <font color="#ff0000">2</font> <br />##peek V int-regs <font color="#ff0000">1368575</font> D <font color="#ff0000">1</font> <br />##copy V int-regs <font color="#ff0000">1368579</font> V int-regs <font color="#ff0000">1368575</font> <br />##shl-imm V int-regs <font color="#ff0000">1368579</font> V int-regs <font color="#ff0000">1368579</font> <font color="#ff0000">2</font> <br />##copy V int-regs <font color="#ff0000">1368582</font> V int-regs <font color="#ff0000">1368579</font> <br />##sar-imm V int-regs <font color="#ff0000">1368582</font> V int-regs <font color="#ff0000">1368582</font> <font color="#ff0000">3</font> <br />##add-imm V int-regs <font color="#ff0000">1368583</font> V int-regs <font color="#ff0000">1368574</font> <font color="#ff0000">13</font> <br />##add V int-regs <font color="#ff0000">1368585</font> V int-regs <font color="#ff0000">1368582</font> V int-regs <font color="#ff0000">1368583</font> <br />##alien-unsigned-4 V int-regs <font color="#ff0000">1368586</font> V int-regs <font color="#ff0000">1368585</font> <br />##copy V int-regs <font color="#ff0000">1368587</font> V int-regs <font color="#ff0000">1368586</font> <br />##shl-imm V int-regs <font color="#ff0000">1368587</font> V int-regs <font color="#ff0000">1368587</font> <font color="#ff0000">3</font> <br />##peek V int-regs <font color="#ff0000">1368588</font> D <font color="#ff0000">2</font> <br />##copy V int-regs <font color="#ff0000">1368590</font> V int-regs <font color="#ff0000">1368588</font> <br />##xor V int-regs <font color="#ff0000">1368590</font> V int-regs <font color="#ff0000">1368590</font> V int-regs <font color="#ff0000">1368587</font> <br />##peek V int-regs <font color="#ff0000">1368591</font> R <font color="#ff0000">-4</font> <br />##peek V int-regs <font color="#ff0000">1368592</font> R <font color="#ff0000">-5</font> <br />##slot-imm V int-regs <font color="#ff0000">1368597</font> V int-regs <font color="#ff0000">1368592</font> <font color="#ff0000">3</font> <font color="#ff0000">2</font> <br />##copy V int-regs <font color="#ff0000">1368602</font> V int-regs <font color="#ff0000">1368591</font> <br />##shl-imm V int-regs <font color="#ff0000">1368602</font> V int-regs <font color="#ff0000">1368602</font> <font color="#ff0000">2</font> <br />##copy V int-regs <font color="#ff0000">1368605</font> V int-regs <font color="#ff0000">1368602</font> <br />##sar-imm V int-regs <font color="#ff0000">1368605</font> V int-regs <font color="#ff0000">1368605</font> <font color="#ff0000">3</font> <br />##add-imm V int-regs <font color="#ff0000">1368606</font> V int-regs <font color="#ff0000">1368597</font> <font color="#ff0000">13</font> <br />##add V int-regs <font color="#ff0000">1368608</font> V int-regs <font color="#ff0000">1368605</font> V int-regs <font color="#ff0000">1368606</font> <br />##copy V int-regs <font color="#ff0000">1368610</font> V int-regs <font color="#ff0000">1368590</font> <br />##sar-imm V int-regs <font color="#ff0000">1368610</font> V int-regs <font color="#ff0000">1368610</font> <font color="#ff0000">3</font> <br />##set-alien-integer-4 V int-regs <font color="#ff0000">1368608</font> V int-regs <font color="#ff0000">1368610</font> <br />##peek V int-regs <font color="#ff0000">1368611</font> R <font color="#ff0000">-2</font> <br />##peek V int-regs <font color="#ff0000">1368612</font> R <font color="#ff0000">-3</font> <br />##peek V int-regs <font color="#ff0000">1368613</font> R <font color="#ff0000">-1</font> <br />##add-imm V int-regs <font color="#ff0000">1368620</font> V int-regs <font color="#ff0000">1368611</font> <font color="#ff0000">8</font> <br />##replace V int-regs <font color="#ff0000">1368620</font> D <font color="#ff0000">2</font> <br />##replace V int-regs <font color="#ff0000">1368612</font> D <font color="#ff0000">0</font> <br />##replace V int-regs <font color="#ff0000">1368613</font> D <font color="#ff0000">1</font> <br />_branch <font color="#ff0000">4</font> <br />_label <font color="#ff0000">11</font> <br />##inc-d <font color="#ff0000">-3</font> <br />_label <font color="#ff0000">12</font> <br />##inc-r <font color="#ff0000">-1</font> <br />##inc-d <font color="#ff0000">1</font> <br />##peek V int-regs <font color="#ff0000">1368626</font> R <font color="#ff0000">-1</font> <br />##load-immediate V int-regs <font color="#ff0000">1368628</font> <font color="#ff0000">0</font> <br />##set-slot-imm V int-regs <font color="#ff0000">1368628</font> V int-regs <font color="#ff0000">1368626</font> <font color="#ff0000">3</font> <font color="#ff0000">2</font> <br />##replace V int-regs <font color="#ff0000">1368628</font> D <font color="#ff0000">0</font> <br />_label <font color="#ff0000">13</font> <br />##inc-r <font color="#ff0000">-1</font> <br />##peek V int-regs <font color="#ff0000">1368634</font> R <font color="#ff0000">-1</font> <br />##slot-imm V int-regs <font color="#ff0000">1368639</font> V int-regs <font color="#ff0000">1368634</font> <font color="#ff0000">2</font> <font color="#ff0000">2</font> <br />##slot-imm V int-regs <font color="#ff0000">1368644</font> V int-regs <font color="#ff0000">1368639</font> <font color="#ff0000">3</font> <font color="#ff0000">2</font> <br />##peek V int-regs <font color="#ff0000">1368645</font> D <font color="#ff0000">0</font> <br />##copy V int-regs <font color="#ff0000">1368649</font> V int-regs <font color="#ff0000">1368645</font> <br />##shl-imm V int-regs <font color="#ff0000">1368649</font> V int-regs <font color="#ff0000">1368649</font> <font color="#ff0000">2</font> <br />##copy V int-regs <font color="#ff0000">1368652</font> V int-regs <font color="#ff0000">1368649</font> <br />##sar-imm V int-regs <font color="#ff0000">1368652</font> V int-regs <font color="#ff0000">1368652</font> <font color="#ff0000">3</font> <br />##add-imm V int-regs <font color="#ff0000">1368653</font> V int-regs <font color="#ff0000">1368644</font> <font color="#ff0000">13</font> <br />##add V int-regs <font color="#ff0000">1368655</font> V int-regs <font color="#ff0000">1368652</font> V int-regs <font color="#ff0000">1368653</font> <br />##alien-unsigned-4 V int-regs <font color="#ff0000">1368656</font> V int-regs <font color="#ff0000">1368655</font> <br />##copy V int-regs <font color="#ff0000">1368657</font> V int-regs <font color="#ff0000">1368656</font> <br />##shl-imm V int-regs <font color="#ff0000">1368657</font> V int-regs <font color="#ff0000">1368657</font> <font color="#ff0000">3</font> <br />##copy V int-regs <font color="#ff0000">1368661</font> V int-regs <font color="#ff0000">1368657</font> <br />##sar-imm V int-regs <font color="#ff0000">1368661</font> V int-regs <font color="#ff0000">1368661</font> <font color="#ff0000">14</font> <br />##copy V int-regs <font color="#ff0000">1368662</font> V int-regs <font color="#ff0000">1368661</font> <br />##shl-imm V int-regs <font color="#ff0000">1368662</font> V int-regs <font color="#ff0000">1368662</font> <font color="#ff0000">3</font> <br />##copy V int-regs <font color="#ff0000">1368665</font> V int-regs <font color="#ff0000">1368657</font> <br />##xor V int-regs <font color="#ff0000">1368665</font> V int-regs <font color="#ff0000">1368665</font> V int-regs <font color="#ff0000">1368662</font> <br />##copy V int-regs <font color="#ff0000">1368669</font> V int-regs <font color="#ff0000">1368665</font> <br />##shl-imm V int-regs <font color="#ff0000">1368669</font> V int-regs <font color="#ff0000">1368669</font> <font color="#ff0000">7</font> <br />##load-immediate V int-regs <font color="#ff0000">1368670</font> <font color="#ff0000">21095429120</font> <br />##copy V int-regs <font color="#ff0000">1368673</font> V int-regs <font color="#ff0000">1368669</font> <br />##and V int-regs <font color="#ff0000">1368673</font> V int-regs <font color="#ff0000">1368673</font> V int-regs <font color="#ff0000">1368670</font> <br />##copy V int-regs <font color="#ff0000">1368676</font> V int-regs <font color="#ff0000">1368665</font> <br />##xor V int-regs <font color="#ff0000">1368676</font> V int-regs <font color="#ff0000">1368676</font> V int-regs <font color="#ff0000">1368673</font> <br />##copy V int-regs <font color="#ff0000">1368680</font> V int-regs <font color="#ff0000">1368676</font> <br />##shl-imm V int-regs <font color="#ff0000">1368680</font> V int-regs <font color="#ff0000">1368680</font> <font color="#ff0000">15</font> <br />##load-immediate V int-regs <font color="#ff0000">1368681</font> <font color="#ff0000">32181846016</font> <br />##copy V int-regs <font color="#ff0000">1368684</font> V int-regs <font color="#ff0000">1368680</font> <br />##and V int-regs <font color="#ff0000">1368684</font> V int-regs <font color="#ff0000">1368684</font> V int-regs <font color="#ff0000">1368681</font> <br />##copy V int-regs <font color="#ff0000">1368687</font> V int-regs <font color="#ff0000">1368676</font> <br />##xor V int-regs <font color="#ff0000">1368687</font> V int-regs <font color="#ff0000">1368687</font> V int-regs <font color="#ff0000">1368684</font> <br />##copy V int-regs <font color="#ff0000">1368691</font> V int-regs <font color="#ff0000">1368687</font> <br />##sar-imm V int-regs <font color="#ff0000">1368691</font> V int-regs <font color="#ff0000">1368691</font> <font color="#ff0000">21</font> <br />##copy V int-regs <font color="#ff0000">1368692</font> V int-regs <font color="#ff0000">1368691</font> <br />##shl-imm V int-regs <font color="#ff0000">1368692</font> V int-regs <font color="#ff0000">1368692</font> <font color="#ff0000">3</font> <br />##copy V int-regs <font color="#ff0000">1368695</font> V int-regs <font color="#ff0000">1368687</font> <br />##xor V int-regs <font color="#ff0000">1368695</font> V int-regs <font color="#ff0000">1368695</font> V int-regs <font color="#ff0000">1368692</font> <br />##replace V int-regs <font color="#ff0000">1368695</font> D <font color="#ff0000">0</font> <br />##slot-imm V int-regs <font color="#ff0000">1368701</font> V int-regs <font color="#ff0000">1368634</font> <font color="#ff0000">3</font> <font color="#ff0000">2</font> <br />##add-imm V int-regs <font color="#ff0000">1368704</font> V int-regs <font color="#ff0000">1368701</font> <font color="#ff0000">8</font> <br />##set-slot-imm V int-regs <font color="#ff0000">1368704</font> V int-regs <font color="#ff0000">1368634</font> <font color="#ff0000">3</font> <font color="#ff0000">2</font> <br />##epilogue <br />##return<br /></font></pre><br />Finally, after register allocation, these instructions map pretty much directly onto machine code:<br /><pre>0x0000000109901940: add    $0x8,%r15<br />0x0000000109901944: add    $0x8,%r14<br />0x0000000109901948: mov    -0x8(%r14),%rax<br />0x000000010990194c: mov    %rax,(%r15)<br />0x000000010990194f: mov    0x16(%rax),%rcx<br />0x0000000109901953: mov    %rcx,(%r14)<br />0x0000000109901956: cmp    $0x1380,%rcx<br />0x000000010990195d: jge    0x109901973<br />0x0000000109901963: sub    $0x8,%r14<br />0x0000000109901967: mov    0x8(%r14),%rcx<br />0x000000010990196b: mov    %rcx,(%r14)<br />0x000000010990196e: jmpq   0x109901b5b<br />0x0000000109901973: add    $0x8,%r15<br />0x0000000109901977: add    $0x8,%r14<br />0x000000010990197b: mov    -0x10(%r14),%rcx<br />0x000000010990197f: mov    %rcx,(%r15)<br />0x0000000109901982: mov    $0x1380,%rax<br />0x000000010990198c: mov    0xe(%rcx),%rdx<br />0x0000000109901990: mov    $0x0,%rcx<br />0x000000010990199a: mov    %rdx,(%r14)<br />0x000000010990199d: mov    %rax,-0x8(%r14)<br />0x00000001099019a1: mov    %rcx,-0x10(%r14)<br />0x00000001099019a5: nop    <br />0x00000001099019a6: nop    <br />0x00000001099019a7: nop    <br />0x00000001099019a8: nop    <br />0x00000001099019a9: nop    <br />0x00000001099019aa: nop    <br />0x00000001099019ab: nop    <br />0x00000001099019ac: nop    <br />0x00000001099019ad: nop    <br />0x00000001099019ae: nop    <br />0x00000001099019af: nop    <br />0x00000001099019b0: mov    -0x10(%r14),%rcx<br />0x00000001099019b4: cmp    $0x1380,%rcx<br />0x00000001099019bb: jge    0x109901b3a<br />0x00000001099019c1: add    $0x38,%r15<br />0x00000001099019c5: mov    -0x8(%r14),%rcx<br />0x00000001099019c9: mov    (%r14),%rdx<br />0x00000001099019cc: mov    %rcx,-0x30(%r15)<br />0x00000001099019d0: mov    -0x10(%r14),%rcx<br />0x00000001099019d4: mov    %rdx,-0x20(%r15)<br />0x00000001099019d8: mov    %rcx,-0x28(%r15)<br />0x00000001099019dc: mov    %rdx,-0x10(%r15)<br />0x00000001099019e0: mov    %rcx,-0x18(%r15)<br />0x00000001099019e4: mov    %rdx,(%r15)<br />0x00000001099019e7: mov    %rcx,-0x8(%r15)<br />0x00000001099019eb: mov    0x16(%rdx),%rax<br />0x00000001099019ef: mov    %rcx,%rdx<br />0x00000001099019f2: shl    $0x2,%rdx<br />0x00000001099019f6: sar    $0x3,%rdx<br />0x00000001099019fa: lea    0xd(%rax),%rbx<br />0x00000001099019fe: lea    (%rdx,%rbx,1),%rax<br />0x0000000109901a02: mov    (%rax),%edx<br />0x0000000109901a04: shl    $0x3,%rdx<br />0x0000000109901a08: mov    $0x400000000,%rax<br />0x0000000109901a12: and    %rax,%rdx<br />0x0000000109901a15: lea    0x8(%rcx),%rax<br />0x0000000109901a19: shl    $0x2,%rax<br />0x0000000109901a1d: sar    $0x3,%rax<br />0x0000000109901a21: lea    (%rax,%rbx,1),%rcx<br />0x0000000109901a25: mov    (%rcx),%eax<br />0x0000000109901a27: shl    $0x3,%rax<br />0x0000000109901a2b: mov    $0x3fffffff8,%rcx<br />0x0000000109901a35: and    %rcx,%rax<br />0x0000000109901a38: or     %rax,%rdx<br />0x0000000109901a3b: mov    %rdx,%rax<br />0x0000000109901a3e: sar    $0x4,%rax<br />0x0000000109901a42: shl    $0x3,%rax<br />0x0000000109901a46: mov    %rax,-0x10(%r14)<br />0x0000000109901a4a: and    $0x8,%rdx<br />0x0000000109901a4e: mov    $0x4c84586f8,%rax<br />0x0000000109901a58: mov    $0x0,%rcx<br />0x0000000109901a62: mov    %rcx,(%r14)<br />0x0000000109901a65: mov    %rax,-0x8(%r14)<br />0x0000000109901a69: cmp    $0x8,%rdx<br />0x0000000109901a6d: jne    0x109901a7c<br />0x0000000109901a73: sub    $0x8,%r14<br />0x0000000109901a77: jmpq   0x109901a87<br />0x0000000109901a7c: sub    $0x8,%r14<br />0x0000000109901a80: mov    0x8(%r14),%rcx<br />0x0000000109901a84: mov    %rcx,(%r14)<br />0x0000000109901a87: sub    $0x8,%r15<br />0x0000000109901a8b: mov    -0x8(%r14),%rcx<br />0x0000000109901a8f: mov    (%r14),%rax<br />0x0000000109901a92: xor    %rax,%rcx<br />0x0000000109901a95: mov    %rcx,-0x8(%r14)<br />0x0000000109901a99: mov    (%r15),%rcx<br />0x0000000109901a9c: mov    0x8(%r15),%rax<br />0x0000000109901aa0: lea    0xc68(%rcx),%rdx<br />0x0000000109901aa7: mov    %rax,(%r15)<br />0x0000000109901aaa: mov    %rdx,(%r14)<br />0x0000000109901aad: cmp    $0x1380,%rdx<br />0x0000000109901ab4: jle    0x109901ac7<br />0x0000000109901aba: mov    (%r14),%rdx<br />0x0000000109901abd: lea    -0x1380(%rdx),%rax<br />0x0000000109901ac4: mov    %rax,(%r14)<br />0x0000000109901ac7: sub    $0x30,%r15<br />0x0000000109901acb: add    $0x8,%r14<br />0x0000000109901acf: mov    0x30(%r15),%rax<br />0x0000000109901ad3: mov    0x16(%rax),%rdx<br />0x0000000109901ad7: mov    -0x8(%r14),%rax<br />0x0000000109901adb: shl    $0x2,%rax<br />0x0000000109901adf: sar    $0x3,%rax<br />0x0000000109901ae3: lea    0xd(%rdx),%rcx<br />0x0000000109901ae7: lea    (%rax,%rcx,1),%rdx<br />0x0000000109901aeb: mov    (%rdx),%ecx<br />0x0000000109901aed: shl    $0x3,%rcx<br />0x0000000109901af1: mov    -0x10(%r14),%rdx<br />0x0000000109901af5: xor    %rcx,%rdx<br />0x0000000109901af8: mov    0x20(%r15),%rcx<br />0x0000000109901afc: mov    0x28(%r15),%rax<br />0x0000000109901b00: mov    0x16(%rax),%rbx<br />0x0000000109901b04: shl    $0x2,%rcx<br />0x0000000109901b08: sar    $0x3,%rcx<br />0x0000000109901b0c: lea    0xd(%rbx),%rax<br />0x0000000109901b10: lea    (%rcx,%rax,1),%rbx<br />0x0000000109901b14: sar    $0x3,%rdx<br />0x0000000109901b18: mov    %edx,(%rbx)<br />0x0000000109901b1a: mov    0x10(%r15),%rdx<br />0x0000000109901b1e: mov    0x18(%r15),%rbx<br />0x0000000109901b22: mov    0x8(%r15),%rax<br />0x0000000109901b26: lea    0x8(%rdx),%rcx<br />0x0000000109901b2a: mov    %rcx,-0x10(%r14)<br />0x0000000109901b2e: mov    %rbx,(%r14)<br />0x0000000109901b31: mov    %rax,-0x8(%r14)<br />0x0000000109901b35: jmpq   0x1099019b0<br />0x0000000109901b3a: sub    $0x18,%r14<br />0x0000000109901b3e: sub    $0x8,%r15<br />0x0000000109901b42: add    $0x8,%r14<br />0x0000000109901b46: mov    0x8(%r15),%rcx<br />0x0000000109901b4a: mov    $0x0,%rax<br />0x0000000109901b54: mov    %rax,0x16(%rcx)<br />0x0000000109901b58: mov    %rax,(%r14)<br />0x0000000109901b5b: sub    $0x8,%r15<br />0x0000000109901b5f: mov    0x8(%r15),%rax<br />0x0000000109901b63: mov    0xe(%rax),%rcx<br />0x0000000109901b67: mov    0x16(%rcx),%rbx<br />0x0000000109901b6b: mov    (%r14),%rcx<br />0x0000000109901b6e: shl    $0x2,%rcx<br />0x0000000109901b72: sar    $0x3,%rcx<br />0x0000000109901b76: lea    0xd(%rbx),%rdx<br />0x0000000109901b7a: lea    (%rcx,%rdx,1),%rbx<br />0x0000000109901b7e: mov    (%rbx),%edx<br />0x0000000109901b80: shl    $0x3,%rdx<br />0x0000000109901b84: mov    %rdx,%rbx<br />0x0000000109901b87: sar    $0xe,%rbx<br />0x0000000109901b8b: shl    $0x3,%rbx<br />0x0000000109901b8f: xor    %rbx,%rdx<br />0x0000000109901b92: mov    %rdx,%rbx<br />0x0000000109901b95: shl    $0x7,%rbx<br />0x0000000109901b99: mov    $0x4e962b400,%rcx<br />0x0000000109901ba3: and    %rcx,%rbx<br />0x0000000109901ba6: xor    %rbx,%rdx<br />0x0000000109901ba9: mov    %rdx,%rbx<br />0x0000000109901bac: shl    $0xf,%rbx<br />0x0000000109901bb0: mov    $0x77e300000,%rcx<br />0x0000000109901bba: and    %rcx,%rbx<br />0x0000000109901bbd: xor    %rbx,%rdx<br />0x0000000109901bc0: mov    %rdx,%rbx<br />0x0000000109901bc3: sar    $0x15,%rbx<br />0x0000000109901bc7: shl    $0x3,%rbx<br />0x0000000109901bcb: xor    %rbx,%rdx<br />0x0000000109901bce: mov    %rdx,(%r14)<br />0x0000000109901bd1: mov    0x16(%rax),%rdx<br />0x0000000109901bd5: lea    0x8(%rdx),%rbx<br />0x0000000109901bd9: mov    %rbx,0x16(%rax)<br />0x0000000109901bdd: retq   </pre><br />That's pretty tight code for a dynamic language.<br /><h3>Implementation of specialized arrays</h3><br />So there are 13 C types here: <code>char uchar short ushort int uint long ulong longlong ulonglong float double void*</code>. For each C type, we have four vocabularies: <code>specialized-arrays.<i>type</i></code>, <code>specialized-vectors.<i>type</i></code>, <code>specialized-arrays.direct.<i>type</i></code>, and <code>io.mmap.<i>type</i></code>. Implementing all of this by hand would be a pain: even with the best abstractions in Factor's object system, at a minimum there would be 4 or 5 lines of code per type and per feature, and ideally you'd want to clone some methods once per implementation instead of abstracting everything out through dynamic dispatch, for performance reasons. So instead, I did what any self-respecting programmer would do in this situation: I made the computer do all the hard work. Factor lacked the abstraction necessary to express what I wanted, but Factor is extensible, so I just implemented the abstraction -- as a library. The feature we want here is essentially C++ templates. So yes, there is now a <code>functors</code> vocabulary which implements what amounts to C++ templates... in Factor. I called them "functors", even though they're more like templates than ML functors, because the term "template" has meaning in Factor's web framework and I didn't want to create confusion. I don't expect functors will see widespread use and I certainly don't want to promote this as a central feature of Factor. It is just another library that happens to extend the parser -- like many other Factor libraries do.<br /><br />Let's look at how functors are used. For example, here is the entire text of the <code>specialized-arrays.direct.int</code> vocabulary:<br /><pre><font color="#000000"><font color="#000000"><strong>USING: </strong></font><font color="#003333">specialized-arrays.int</font><font color="#003333"> </font><font color="#003333">specialized-arrays.direct.functor</font><font color="#003333"> </font><font color="#000000"><strong>;</strong></font><br /><font color="#000000"><strong>IN:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>specialized-arrays.direct.int</strong></font><br /><br />&lt;&lt; <font color="#006666">&quot;</font><font color="#006666">int</font><font color="#006666">&quot;</font> define-direct-array &gt;&gt;<br /></font></pre><br />The key of course is that its invoking the <code>define-direct-array</code> word, at parse time (hence the <code>&lt;&lt;</code> and <code>&gt;&gt;</code>). This word is defined in the <code>specialized-arrays.direct.functor</code> vocabulary, and its definition looks quite unusual:<br /><pre><font color="#000000">FUNCTOR: define-direct-array <font color="#6600cc">( </font><font color="#793b1c"><strong>T</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br /><br />A'      IS $<font color="#006633">{</font>T<font color="#006633">}</font>-array<br />&gt;A'     IS &gt;$<font color="#006633">{</font>T<font color="#006633">}</font>-array<br />&lt;A'&gt;    IS &lt;$<font color="#006633">{</font>A'<font color="#006633">}</font>&gt;<br /><br />A       DEFINES direct-$<font color="#006633">{</font>T<font color="#006633">}</font>-array<br />&lt;A&gt;     DEFINES &lt;$<font color="#006633">{</font>A<font color="#006633">}</font>&gt;<br /><br />NTH     <font color="#006633">[</font> T dup c-getter array-accessor <font color="#006633">]</font><br />SET-NTH <font color="#006633">[</font> T dup c-setter array-accessor <font color="#006633">]</font><br /><br />WHERE<br /><br />TUPLE: A<br /><font color="#006633">{</font> underlying alien read-only <font color="#006633">}</font><br /><font color="#006633">{</font> length fixnum read-only <font color="#006633">}</font> <font color="#000000"><strong>;</strong></font><br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>&lt;A&gt;</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>alien</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>len</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>direct</strong></font><font color="#793b1c"><strong>-</strong></font><font color="#793b1c"><strong>array</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> A boa <font color="#000000"><strong>;</strong></font> inline<br />M: A length length&gt;&gt; <font color="#000000"><strong>;</strong></font><br />M: A nth-unsafe underlying&gt;&gt; NTH call <font color="#000000"><strong>;</strong></font><br />M: A set-nth-unsafe underlying&gt;&gt; SET-NTH call <font color="#000000"><strong>;</strong></font><br />M: A like drop dup A instance? <font color="#006633">[</font> &gt;A' execute <font color="#006633">]</font> unless <font color="#000000"><strong>;</strong></font><br />M: A new-sequence drop &lt;A'&gt; execute <font color="#000000"><strong>;</strong></font><br /><br />INSTANCE: A sequence<br /><br />;FUNCTOR<br /></font></pre>This <code>FUNCTOR: ... IS / DEFINES ... WHERE ... ;FUNCTOR</code> business is not new syntax in the language; its just parsing words defined in the <code>functors</code> vocabulary. Essentially we are defining a word, <code>define-direct-array</code>, which generates code, parameterized by a single input <code>T</code>, which is a C type name in this case. Note that what's going on here is more elaborate than text substitution; the functor body is parsed once, and converted into code which instantiates it, rather than simply expanding at usages like C preprocessor macros do.<br /><br />Functors may seem like an elaborate new piece of functionality, comparable in complexity to the object system or locals, but in reality, the emperor has no clothes; they have a trivial desugaring.<br /><br />First, inside a functor body, the <code>TUPLE:</code>, <code>:</code>, <code>M:</code> and <code>INSTANCE:</code> are shadowed to special words in the <code>functors</code> vocabulary named <code>`TUPLE:</code>, <code>`:</code>, and so on.<br /><br />Next, <code>IS</code> and <code>DEFINES</code> desugar as follows.<br /><pre>A'      IS ${T}-array</pre>expands into<br /><pre>A' [ [ I[ ${T}-array]I ] with-string-writer dup search [ ] [ no-word ] ?if ]</pre>and<br /><pre>&lt;A>     DEFINES &lt;${A}></pre>expands into<br /><pre>&lt;A> [ [ I[ &lt;${A}>]I ] with-string-writer create-in ]</pre><br />The <code>I[</code> syntax is just the <code>interpolate</code> library, which turns this,<br /><pre>I[ Hello, ${name}.]I</pre>into this,<br /><pre>"Hello, " write name write "." write</pre>Now,<br /><pre>FUNCTOR: foo ( inputs -- )<br /><br />...names...<br /><br />WHERE<br /><br />...body...<br /><br />;FUNCTOR</pre>is really just syntax sugar for<br /><pre>:: foo ( inputs -- )<br />    [let* | ...names... | ...body... ] ;</pre><br />With the added caveat that inside the body, <code>`:</code> is remapped to <code>:</code> and so on.<br /><br />As you can see, a seemingly powerful feature is melting away as it becomse apparent its only some rather trivial syntax sugar. Words such as <code>`:</code> desugar like so;<br /><pre>`: foo 2 2 + . ;</pre>becomes<br /><pre>foo [ 2 2 + . ] define</pre>Let's look at a functor and its desugaring. Here is a simple functor, it takes a tuple class name as input, and defines a constructor word <code>&lt;foo></code> which makes a new instance of this tuple class using <code>new</code>. So it is like the built-in parsing word <code>C:</code>, except it uses <code>new</code> instead of <code>boa</code>:<br /><pre><font color="#000000">FUNCTOR: make-constructor <font color="#6600cc">( </font><font color="#793b1c"><strong>name</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br /><br />tuple IS $<font color="#006633">{</font>name<font color="#006633">}</font><br />&lt;tuple&gt; DEFINES &lt;$<font color="#006633">{</font>name<font color="#006633">}</font>&gt;<br /><br />WHERE<br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>&lt;tuple&gt;</strong></font> tuple new <font color="#000000"><strong>;</strong></font><br /><br />;FUNCTOR<br /></font></pre><br />Given the above, this functor is really equivalent to the following:<br /><pre><font color="#000000">:<font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>make-constructor</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>name</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#006633">[</font>let* | tuple <font color="#006633">[</font> name dup search <font color="#006633">[</font> <font color="#006633">]</font> <font color="#006633">[</font> no-word <font color="#006633">]</font> ?if <font color="#006633">]</font><br />            &lt;tuple&gt; <font color="#006633">[</font> <font color="#006633">[</font> <font color="#006666">&quot;</font><font color="#006666">&lt;</font><font color="#006666">&quot;</font> write name write <font color="#006666">&quot;</font><font color="#006666">&gt;</font><font color="#006666">&quot;</font> write <font color="#006633">]</font> with-string-writer <font color="#006633">]</font> |<br />        &lt;tuple&gt; <font color="#006633">[</font> tuple new <font color="#006633">]</font> define<br />    <font color="#006633">]</font> <font color="#000000"><strong>;</strong></font><br /></font></pre><br />We could keep going -- the <code>::</code> word, which defines a word with named parameters, is it self a library word, in the <code>locals</code> vocabulary, which desugars down to stack code.<br /><br />In this simple example, the hand-coded version is shorter than the functor, but the point of using a functor is that you can make the meta-code look like the code that it is generating. For the more complex functors that generate the various forms of specialized arrays, this is invaluable because it makes the code easier to maintain and debug.<br /><br />Finally, the stuff described in this post, especially the implementation of functors, is some pretty advanced stuff. I don't expect most people using Factor to know or care about how this works; after all, you can use specialized arrays without "peeking under the hood", so to speak. However, all of this meta-programming power is there when you are ready for it.
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2008/12/arrays-of-unboxed-primitive-values-and.html' itemprop='url'/>
<a class='timestamp-link' href='12/arrays-of-unboxed-primitive-values-and.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2008-12-04T11:34:00-05:00'>11:34 AM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=6405874209088924172' onclick=''>
1 comment:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=6405874209088924172' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=6405874209088924172&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=6405874209088924172&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=6405874209088924172&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=6405874209088924172&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=6405874209088924172&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=6405874209088924172&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Monday, December 01, 2008</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='8486995260268389207' itemprop='postId'/>
<a name='8486995260268389207'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='12/factor-now-fully-supported-on-64-bit.html'>Factor now fully supported on 64-bit Windows</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-8486995260268389207' itemprop='description articleBody'>
The 64-bit Windows porting effort is complete. All vocabularies load and all tests pass (except PostgreSQL doesn't have 64-bit client libraries). A <a href="http://factorcode.org/binaries.fhtml">binary package</a> is available. This brings the total number of supported platforms to 13. Enjoy!
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2008/12/factor-now-fully-supported-on-64-bit.html' itemprop='url'/>
<a class='timestamp-link' href='12/factor-now-fully-supported-on-64-bit.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2008-12-01T19:05:00-05:00'>7:05 PM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=8486995260268389207' onclick=''>
2 comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=8486995260268389207' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=8486995260268389207&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8486995260268389207&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8486995260268389207&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8486995260268389207&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8486995260268389207&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=8486995260268389207&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Sunday, November 30, 2008</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='7479609845088003448' itemprop='postId'/>
<a name='7479609845088003448'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='11/new-features-in-smtp-and-ssl-library.html'>New features in SMTP and SSL library allow sending e-mail through Gmail</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-7479609845088003448' itemprop='description articleBody'>
Although I added <a href="05/ssltls-support-added.html">SSL support</a> to Factor's I/O library recently, it was missing a feature needed by SMTP-TLS: upgrading insecure connections to secure ones. Unlike HTTPS, where the client connects to a special port number initiates a secure handshake as soon as the connection is established, SMTP uses a <code>STARTTLS</code> command, which is sent in plain-text, and handshaking only begins after this command is sent.<br /><br />To accomodate this use-case, I added two new words to the <code>io.sockets.secure</code> vocabulary: <code>send-secure-handshake</code> and <code>accept-secure-handshake</code>. They are meant to be used in a client and server respectively, wishing to upgrade the current connection to a secure connection.<br /><br />I also updated the <code>smtp</code> vocabulary to support the <code>STARTTLS</code> and <code>AUTH PLAIN</code> features of the SMTP protocol. The end result is that the SMTP vocabulary can now send e-mail through Gmail's SMTP servers. An example is shown below. The key thing to notice here is that we set the <code>smtp-auth</code> and <code>smtp-tls?</code> variables before sending the e-mail. As you can see, the SMTP library is easy to use and the code for sending an e-mail is succinct; we create an e-mail object, fill in some slots, and send it off:<br /><br /><pre><font color="#000000"><font color="#006666">&quot;</font><font color="#006666">smtp.gmail.com</font><font color="#006666">&quot;</font> <font color="#ff0000">587</font> &lt;inet&gt; smtp-server set<br />smtp-tls? on<br /><font color="#006666">&quot;</font><font color="#006666">YourUserName@gmail.com</font><font color="#006666">&quot;</font> <font color="#006666">&quot;</font><font color="#006666">YourPassword</font><font color="#006666">&quot;</font> &lt;plain-auth&gt; smtp-auth set<br /><br />&lt;email&gt;<br />    <font color="#006666">&quot;</font><font color="#006666">yourname@example.com</font><font color="#006666">&quot;</font> &gt;&gt;from<br />    <font color="#006633">{</font> <font color="#006666">&quot;</font><font color="#006666">theirname@example.com</font><font color="#006666">&quot;</font> <font color="#006633">}</font> &gt;&gt;to<br />    <font color="#006666">&quot;</font><font color="#006666">We</font><font color="#006666"> </font><font color="#006666">should</font><font color="#006666"> </font><font color="#006666">probably</font><font color="#006666"> </font><font color="#006666">beer</font><font color="#006666">&quot;</font> &gt;&gt;subject<br />    <font color="#006666">&quot;</font><font color="#006666">For</font><font color="#006666"> </font><font color="#006666">teh</font><font color="#006666"> </font><font color="#006666">win</font><font color="#006666">&quot;</font> &gt;&gt;body<br />send-email<br /></font></pre><br />The SMTP library is still missing some functionality, like support for character encodings, attachements and setting custom headers; I'll be adding those over time.
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2008/11/new-features-in-smtp-and-ssl-library.html' itemprop='url'/>
<a class='timestamp-link' href='11/new-features-in-smtp-and-ssl-library.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2008-11-30T14:34:00-05:00'>2:34 PM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=7479609845088003448' onclick=''>
No comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=7479609845088003448' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=7479609845088003448&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7479609845088003448&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7479609845088003448&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7479609845088003448&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7479609845088003448&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7479609845088003448&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Saturday, November 29, 2008</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='4340944151645521763' itemprop='postId'/>
<a name='4340944151645521763'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='11/faster-generic-arithmetic-and-integer.html'>Faster generic arithmetic and integer overflow checking</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-4340944151645521763' itemprop='description articleBody'>
While the Factor compiler does a pretty good job of inferring types and eliminating dispatch where possible, runtime polymorphism still ends up being used a lot. Integer arithmetic presents an additional challenge. Factor supports arbitrary-precision integers, and it tries to make this support transparent. However, the flipside of this is that even if the compiler can figure out that all of the values in an expression are integers, it may not be able to eliminate the overflow check, depending on whether or not the ranges of the values are known. Because of this, making runtime polymorphism efficient is still important. In the last few days, I worked on making integer arithmetic more efficient.<br /><br />Consider a word like <code>+</code>. If compile-time type information is not available, this word has to look at the types of the top two stack items, and take appropriate action depending on whether they are fixnums, bignums, ratios, floats, or complex numbers. Until now, this dispatch was implemented by two indirect jumps. The type of the first object is used to key a dispatch table, where each entry then looks at the type of the second object and keys into a second-level dispatch table; the entries in the latter are the actual methods implementing the arithmetic operation.<br /><br />In Factor, the generic word system generates Factor code for performing method dispatch. If you look at the definition of a word such as <code>+</code> in an older build, you'll see this two-level jump table pattern, implemented with Factor's <code>dispatch</code> combinator:<br /><pre>( scratchpad ) \ + def>> .<br />[<br />    over tag {<br />        [<br />            dup tag {<br />                [ fixnum=>+ ]<br />                [ [ >bignum ] dip bignum=>+ ]<br />                [ \ + no-math-method ]<br />                [ \ + no-math-method ]<br />                [ ratio=>+ ]<br />                [ [ >float ] dip float=>+ ]<br />                [ complex=>+ ]<br />                [ \ + no-math-method ]<br />            } dispatch<br />        ]<br />        [<br />            dup tag {<br />                [ >bignum bignum=>+ ]<br />                [ bignum=>+ ]<br />                [ \ + no-math-method ]<br />                [ \ + no-math-method ]<br />                [ ratio=>+ ]<br />                [ [ >float ] dip float=>+ ]<br />                [ complex=>+ ]<br />                [ \ + no-math-method ]<br />            } dispatch<br />        ]<br />        [ \ + no-math-method ]<br />        [ \ + no-math-method ]<br />        [<br />            dup tag {<br />                [ ratio=>+ ]<br />                [ ratio=>+ ]<br />                [ \ + no-math-method ]<br />                [ \ + no-math-method ]<br />                [ ratio=>+ ]<br />                [ [ >float ] dip float=>+ ]<br />                [ complex=>+ ]<br />                [ \ + no-math-method ]<br />            } dispatch<br />        ]<br />        [<br />            dup tag {<br />                [ >float float=>+ ]<br />                [ >float float=>+ ]<br />                [ \ + no-math-method ]<br />                [ \ + no-math-method ]<br />                [ >float float=>+ ]<br />                [ float=>+ ]<br />                [ complex=>+ ]<br />                [ \ + no-math-method ]<br />            } dispatch<br />        ]<br />        [<br />            dup tag {<br />                [ complex=>+ ]<br />                [ complex=>+ ]<br />                [ \ + no-math-method ]<br />                [ \ + no-math-method ]<br />                [ complex=>+ ]<br />                [ complex=>+ ]<br />                [ complex=>+ ]<br />                [ \ + no-math-method ]<br />            } dispatch<br />        ]<br />        [ \ + no-math-method ]<br />    } dispatch<br />]</pre><br />The <code>dispatch</code> combinator compiles down to an indirect jump, and indirect jumps are expensive on modern CPUs. Also, note that this dispatch scheme did not favor any single numeric type over another. However, in practice, operations on bignums and ratios will always be slow, and dispatch overhead is neglegible there; whereas code that works with floating point numbers and complex numbers can only be fast if the compiler can infer types and unbox values statically, in which case there is no runtime dispatch at all. So performance of runtime arithmetic dispatch on types other than fixnums is largely irrelevant in Factor. Indeed, the overwhelming majority of calls to generic arithmetic operations involve fixnums, so some kind of trick to avoid two indirect jumps in this common case is needed.<br /><br />There are many solutions, but the one I settled on is pretty much the simplest one. In Factor, all values are tagged pointers (except for unboxed floats and such, which the compiler uses, but they cannot be "observed" in their unboxed state from the outside). A tagged pointer is a value where the low 3 bits encode a type, and the remaining bits encode a value. If the type tag is 0, the value is interpreted as an integer; otherwise, it is a pointer. All values in the heap are aligned on 8 byte boundaries, so if we mask off the 3 tag bits, we get a valid pointer.<br /><br />So if we have two values, stored in registers <code>x</code> and <code>y</code>, then both have a tag of 0 if their inclusive bitwise or has a tag of zero. That is, we can check if both are fixnums with a single conditional.<br /><br />Here is the new Factor code generated for the dispatch performed by <code>+</code>:<br /><pre>( scratchpad ) \ + def>> .<br />[<br />    both-fixnums?<br />    [ { fixnum fixnum } declare fixnum=>+ ] [<br />        over tag {<br />            [<br />                dup tag {<br />                    [ { fixnum fixnum } declare fixnum=>+ ]<br />                    [<br />                        { fixnum bignum } declare<br />                        [ >bignum ] dip bignum=>+<br />                    ]<br />                    [<br />                        { fixnum tuple } declare<br />                        \ + no-math-method<br />                    ]<br />                    [ \ + no-math-method ]<br />                    [ { fixnum ratio } declare ratio=>+ ]<br />                    [<br />                        { fixnum float } declare [ >float ] dip<br />                        float=>+<br />                    ]<br />                    [ { fixnum complex } declare complex=>+ ]<br />                    [<br />                        { fixnum POSTPONE: f } declare<br />                        \ + no-math-method<br />                    ]<br />                } dispatch<br />            ]<br />            [<br />                dup tag {<br />                    [<br />                        { bignum fixnum } declare<br />                        >bignum bignum=>+<br />                    ]<br />                    [ { bignum bignum } declare bignum=>+ ]<br />                    [<br />                        { bignum tuple } declare<br />                        \ + no-math-method<br />                    ]<br />                    [ \ + no-math-method ]<br />                    [ { bignum ratio } declare ratio=>+ ]<br />                    [<br />                        { bignum float } declare [ >float ] dip<br />                        float=>+<br />                    ]<br />                    [ { bignum complex } declare complex=>+ ]<br />                    [<br />                        { bignum POSTPONE: f } declare<br />                        \ + no-math-method<br />                    ]<br />                } dispatch<br />            ]<br />            [ \ + no-math-method ]<br />            [ \ + no-math-method ]<br />            [<br />                dup tag {<br />                    [ { ratio fixnum } declare ratio=>+ ]<br />                    [ { ratio bignum } declare ratio=>+ ]<br />                    [<br />                        { ratio tuple } declare<br />                        \ + no-math-method<br />                    ]<br />                    [ \ + no-math-method ]<br />                    [ { ratio ratio } declare ratio=>+ ]<br />                    [<br />                        { ratio float } declare [ >float ] dip<br />                        float=>+<br />                    ]<br />                    [ { ratio complex } declare complex=>+ ]<br />                    [<br />                        { ratio POSTPONE: f } declare<br />                        \ + no-math-method<br />                    ]<br />                } dispatch<br />            ]<br />            [<br />                dup tag {<br />                    [<br />                        { float fixnum } declare<br />                        >float float=>+<br />                    ]<br />                    [<br />                        { float bignum } declare<br />                        >float float=>+<br />                    ]<br />                    [<br />                        { float tuple } declare<br />                        \ + no-math-method<br />                    ]<br />                    [ \ + no-math-method ]<br />                    [ { float ratio } declare >float float=>+ ]<br />                    [ { float float } declare float=>+ ]<br />                    [ { float complex } declare complex=>+ ]<br />                    [<br />                        { float POSTPONE: f } declare<br />                        \ + no-math-method<br />                    ]<br />                } dispatch<br />            ]<br />            [<br />                dup tag {<br />                    [ { complex fixnum } declare complex=>+ ]<br />                    [ { complex bignum } declare complex=>+ ]<br />                    [<br />                        { complex tuple } declare<br />                        \ + no-math-method<br />                    ]<br />                    [ \ + no-math-method ]<br />                    [ { complex ratio } declare complex=>+ ]<br />                    [ { complex float } declare complex=>+ ]<br />                    [ { complex complex } declare complex=>+ ]<br />                    [<br />                        { complex POSTPONE: f } declare<br />                        \ + no-math-method<br />                    ]<br />                } dispatch<br />            ]<br />            [ \ + no-math-method ]<br />        } dispatch<br />    ] if<br />]</pre><br />Notice that it is essentially the same as the old version, except the two-level jump table has been wrapped in a conditional. If <code>both-fixnums?</code> outputs true, we go directly to the fixnum case; otherwise we do the two-level dispatch.<br /><br />Since <code>both-fixnums?</code> needs to bitwise OR pointers together, I had no choice but to make it a VM primitive. The non-optimizing compiler inlines a fixed code sequence for calls of <code>both-fixnums?</code>, and the optimizing compiler expands it into a series of low-level IR operations:<br /><pre>( scratchpad ) [ both-fixnums? [ "Fixnums!" ] [ "At least one is not a fixnum" ] if ] test-mr mr.<br />=== word: ( gensym ), label: ( gensym )<br /><br />_label 0 <br />##prologue <br />_label 1 <br />##peek V int-regs 692262 D 0 <br />##peek V int-regs 692263 D 1 <br />##copy V int-regs 692264 V int-regs 692262 <br />##or V int-regs 692264 V int-regs 692264 V int-regs 692263 <br />##copy V int-regs 692265 V int-regs 692264 <br />##and-imm V int-regs 692265 V int-regs 692265 7 <br />_compare-imm-branch 3 V int-regs 692265 0 cc/= <br />_label 2 <br />##inc-d 1 <br />##load-indirect V int-regs 692269 "Fixnums!" <br />##replace V int-regs 692269 D 0 <br />##epilogue <br />##return <br />_label 3 <br />##inc-d 1 <br />##load-indirect V int-regs 692270 "At least one is not a fixnum" <br />##replace V int-regs 692270 D 0 <br />_label 4 <br />##epilogue <br />##return </pre><br />So the machine code generated for a generic arithmetic word such as <code>+</code> now begins as follows:<br /><pre>    mov    (%r14),%rax<br />    mov    -0x8(%r14),%rcx<br />    or     %rcx,%rax<br />    and    $0x7,%rax<br />    cmp    $0x0,%rax<br />    jne    slow_dispatch<br />    ... handle fixnum+fixnum here ...<br />    ret<br />slow_dispatch:<br />    ... do table dispatch here ...</pre><br />We load two values from the data stack, or them together, mask off the low 3 bits, compare with zero, and jump. Indeed, those readers who know the ways of x86 assembly will recognize that there is a shorter code sequence which can accomplish this same task:<br /><pre>    mov    (%r14),%rax<br />    mov    -0x8(%r14),%rcx<br />    or     %rcx,%rax<br />    test   $0x7,%rax<br />    jnz    slow_dispatch<br />    ... handle fixnum+fixnum here ...<br />    ret<br />slow_dispatch:<br />    ... do table dispatch here ...</pre><br />Once I figure out a nice way to incorporate the <code>test</code> instruction into my code generator and value numbering passes, I will switch things up and eliminate the unnecessary instruction there.<br /><br />This takes care of making dispatch faster. The next challenge was speeding up integer overflow handling. If the optimizing compiler's high-level optimizer can prove that a call to <code>+</code> has fixnum inputs, and in addition, the result will not overflow -- either because the ranges of the input values are constrained, or the output is passed to <code>bitand</code> -- it will replace it with a call to the <code>fixnum+fast</code> primitive. The low-level optimizer turns a call to <code>fixnum+fast</code> into a single low-level IR instruction, and this becomes a single machine instruction. Very efficient.<br /><br />However, if the high-level optimizer cannot prove that the result will not overflow, but it does know the inputs are fixnums, it replaces the call to <code>+</code> with a call to <code>fixnum+</code>. This still avoids dispatch overhead, however, until now, the low-level optimizer did not do anything special for <code>fixnum+</code>; it would compile it as a subroutine call of a VM function, which added two integers, checking for overflow, in C. This was slow, because C does not have a way to test the overflow flag of the CPU.<br /><br />I made the low-level optimizer aware of the <code>fixnum+</code> word; it converts it into a low-level instruction which can then participate in value numbering and register allocation. The CPU-specific backend is then responsible for generating an optimal machine code sequence for <code>fixnum+</code>. On x86 and PowerPC, this can use the overflow flag in the CPU, which is a more efficient than trying to simulate the same in C. If the overflow flag is set after the addition, <code>fixnum+</code> performs a subroutine call into the VM, however there is no call and the arithmetic is done inline in the common case, where there is no overflow.<br /><br />Here is an example of machine code emitted for <code>fixnum+</code>:<br /><pre>    sub    $0x8,%r14<br />    mov    (%r14),%rax<br />    mov    0x8(%r14),%rcx<br />    add    %rcx,%rax<br />    jno    no_overflow<br />    ... handle overflow ...<br />no_overflow:<br />    mov    %rax,(%r14)<br />    retq   </pre><br />I omitted the lengthy setup for the subroutine call into the VM, and register assignments will vary depending on the placement of <code>fixnum+</code> in the code.<br /><br />The results were very interesting. Some benchmarks, such as spectral-norm and mandelbrot, showed no improvement, because the compiler eliminates all the dispatch and overflow checks from the inner loops anyway. Other benchmarks showed an impressive gain. This is good because it means that I didn't waste my time with implementing the above, but it is also bad because it shows that the high-level optimizer could probably do a better job of inferring types in some of these benchmarks!<br /><br />Here are the results; I'm running each benchmark 5 times and measuring the runtime in milliseconds.<br /><table border="1"><tr><th>Benchmark</th><th>Before</th><th>After</th></tr><tr><td>fasta</td><td>9492 8985 8975 9310 9219</td><td>7841 7818 8115 7807 7777</td></tr> <tr><td>reverse-complement</td><td>5815 5611 5628 5645 5645</td><td>5176 5152 5177 5173 5289</td></tr> <tr><td>binary-trees</td><td>2911 2867 2870 2890 2894</td><td>2163 2142 2186 2168 2136</td></tr> <tr><td>fib2</td><td>113 112 114 112 112</td><td>82 83 84 85 85</td></tr> <tr><td>fib3</td><td>301 302 301 300 301</td><td>260 261 259 260 260</td></tr><tr><td>project-euler.134</td><td>427 427 427 426 424</td><td>314 313 315 318 313</td></tr></table>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2008/11/faster-generic-arithmetic-and-integer.html' itemprop='url'/>
<a class='timestamp-link' href='11/faster-generic-arithmetic-and-integer.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2008-11-29T02:53:00-05:00'>2:53 AM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=4340944151645521763' onclick=''>
3 comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=4340944151645521763' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=4340944151645521763&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=4340944151645521763&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=4340944151645521763&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=4340944151645521763&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=4340944151645521763&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=4340944151645521763&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Wednesday, November 26, 2008</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='http://factorcode.org/render-test.png' itemprop='image_url'/>
<meta content='17087850' itemprop='blogId'/>
<meta content='9024070617319711534' itemprop='postId'/>
<a name='9024070617319711534'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='11/some-recent-ui-rendering-fixes.html'>Some recent UI rendering fixes</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-9024070617319711534' itemprop='description articleBody'>
Over the last week or so I've fixed several OpenGL rendering problems in the Factor UI.<br /><br />The first problem is that on Linux, with certain ATI video cards, calling <code>glPolygonMode()</code> to disable polygon fill does not work, and as a result the UI would render with no text visible; borders around buttons would be drawn as filled rectangles and this would overwrite all of the text. I fixed this and modernized the UI rendering code to use vertex arrays at the same time.<br /><br />Then, I decided to address a long-standing issue: rectangles and lines were not rendered pixel-perfect on all systems. You see, with OpenGL, simply rendering a rectangle with integer co-ordinates doesn't give you the results you would expect. On my old Windows laptop for example, rectangles would render with the bottom-right pixel missing. Getting this to work in a cross-platform manner is surprisingly hard. It took me a lot of back-and-forth to get consistent rendering across the machines I tested on (An Intel iMac from a year ago or so, my MacBook Pro with NVidia graphics, Linux and Windows in VirtualBox, and an old Dell Laptop with Windows XP and Intel integrated graphics). For the record, the "correct" way to draw an outlined rectangle is to offset the top-left pixel by 0.5,0.5, and the bottom-right pixel by -0.3,-0.3. Similar heroics were required for line rendering. In the end, I made my job semi-automated by writing a simple program, which is in the <code>ui.render.test</code> vocabulary now, that renders some 2D shapes with OpenGL;<br /><img src="http://factorcode.org/render-test.png"><br />The vocabulary renders the shapes and then compares the results with a reference drawing. It reads the rendered pixels with <code>glReadPixels()</code> and loads the drawing with Doug's <code>graphics.bitmap</code> library.<br /><br />Of course, it turned out that vertex arrays themselves have issues on at least one OpenGL implementation. I started to receive reports of random segfaults on older MacBooks with the Intel X3100 graphics chip. Chris Double then came across a <a href="http://www.mailinglistarchive.com/mac-opengl@lists.apple.com/msg03672.html">mailing list post</a> which explained the situation. Turns out that with this driver, rendering a <code>GL_LINE_LOOP</code> vertex array causes a segfault. The workaround is to render a <code>GL_LINE_STRIP</code> where the last vertex is a copy of the first vertex.<br /><br />There are still a couple of OpenGL problems I haven't been able to resolve. A few users report random screen corruption on Windows machines with Intel graphics. There is also a problem where the Factor UI comes up black if used with Compiz on Linux, however this appears to affect any GL app -- even glxgears. The workaround is to enable indirect rendering with Compiz.<br /><br />It has been three years since I first <a href="../2005/10/random-status-update.html">ported Factor's UI to OpenGL</a> and I'm still finding new issues in drivers that need workarounds. It's a bit disappointing, but it does seem that in recent times, OpenGL driver quality is improving. I still think OpenGL is a good way to render graphics in a cross-platform manner; it has plenty of features and even runs on mobile platforms (OpenGL ES). Our UI only needs a tiny bit of platform-specific code for each platform: opening windows, creating GL contexts, receiving events, and working with the clipboard. Rendering is cross-platform.<br /><br />A few people have suggested using Cairo instead, and while Factor has a Cairo binding now, I'm not keen on using it to render the entire UI. I worry that by switching from OpenGL to Cairo, we'll just have to replace one set of bugs and workarounds with another. Another problem is that Cairo would be another external dependency that deployed Factor applications would have to ship. It seems Cairo is quite bloated these days, so that would be unacceptable. One other alternative is to use native APIs: perhaps Cairo rendering on Linux, GDI+ on Windows, and CoreGraphics on Mac. However, this would require too much effort on my part, so its not something I'm willing to dive into at this point.
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2008/11/some-recent-ui-rendering-fixes.html' itemprop='url'/>
<a class='timestamp-link' href='11/some-recent-ui-rendering-fixes.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2008-11-26T02:45:00-05:00'>2:45 AM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=9024070617319711534' onclick=''>
3 comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=9024070617319711534' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=9024070617319711534&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=9024070617319711534&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=9024070617319711534&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=9024070617319711534&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=9024070617319711534&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=9024070617319711534&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Monday, November 24, 2008</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='1009215376997047332' itemprop='postId'/>
<a name='1009215376997047332'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='11/comparing-performance-of-factor-and-v8.html'>Comparing the performance of Factor and V8</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-1009215376997047332' itemprop='description articleBody'>
<a href="http://code.google.com/p/v8/wiki/Source?tm=4">V8</a> is, of course, Google's new, much-hyped JavaScript VM. It combines a simple JIT with inline caching, and along with <a href="http://trac.webkit.org/wiki/SquirrelFish">SquirrelFish</a>, it promises to take JavaScript performance to the next level.<br /><br />Factor does not do inline caching (although this is planned), however the language itself is more static and the compiler performs more advanced optimizations than the V8 JIT. So I thought it would be interesting to see how these two approaches to dynamic language implementation stack up.<br /><br />I compiled the V8 trunk today on my Intel Core 2 Duo. Factor is of course the latest Factor from git.<br /><br />I chose the following benchmarks from the language shootout:<br /><ul><li>spectral-norm</li> <li>binary-trees</li> <li>fasta</li> <li>nsieve</li> <li>nsieve-bits</li> <li>partial-sums</li></ul><br />Unfortunately, I couldn't get reverse-complement or a few others to work in V8, because they use the <code>readline()</code> function which does not appear to exist. It would have been interesting to compare more benchmarks.<br /><br />I got the JavaScript versions from the <a href="http://shootout.alioth.debian.org/">shootout website</a>; the Factor versions are in the <a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=tree;f=extra/benchmark;hb=HEAD">Factor repository</a>.<br /><br />I ran the V8 benchmarks from the command line, like so,<br /><code>./shell foo.js</code><br />And I ran the Factor benchmarks from within the Factor environment.<br /><br />Without further ado, and without any attempt at post-mortem or analysis, here are the results. All running times are in seconds:<br /><table border="1"> <tr><th>Benchmark:</th><th>Factor</th><th>V8</th></tr> <tr><td>binary-trees </td><td>3.1</td><td>3.8</td></tr> <tr><td>fasta        </td><td>8.9</td><td>12 </td></tr> <tr><td>nsieve       </td><td>0.6</td><td>1.3</td></tr> <tr><td>nsieve-bits  </td><td>1.5</td><td>6.9</td></tr> <tr><td>partial-sums </td><td>2.6</td><td>2.3</td></tr><tr><td>spectral-norm</td><td>29 </td><td>85 </td></tr></table>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2008/11/comparing-performance-of-factor-and-v8.html' itemprop='url'/>
<a class='timestamp-link' href='11/comparing-performance-of-factor-and-v8.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2008-11-24T09:51:00-05:00'>9:51 AM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=1009215376997047332' onclick=''>
6 comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=1009215376997047332' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=1009215376997047332&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=1009215376997047332&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=1009215376997047332&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=1009215376997047332&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=1009215376997047332&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=1009215376997047332&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Sunday, November 23, 2008</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='1268439848197124011' itemprop='postId'/>
<a name='1268439848197124011'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='11/factor-presentation-at-otug.html'>Factor presentation at OTUG</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-1268439848197124011' itemprop='description articleBody'>
I will be giving a talk about <a href="http://factorcode.org">Factor</a> at <a href="http://www.otug.org/">OTUG</a>, The Object Technology User's Group of Minneapolis/St Paul on December 16th. If you're in the Twin Cities area and are interested in Factor, come check it out! There will be free pizza afterwards.
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2008/11/factor-presentation-at-otug.html' itemprop='url'/>
<a class='timestamp-link' href='11/factor-presentation-at-otug.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2008-11-23T05:26:00-05:00'>5:26 AM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=1268439848197124011' onclick=''>
No comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=1268439848197124011' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=1268439848197124011&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=1268439848197124011&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=1268439848197124011&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=1268439848197124011&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=1268439848197124011&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=1268439848197124011&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Tuesday, November 11, 2008</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='976754095456028820' itemprop='postId'/>
<a name='976754095456028820'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='11/factor-port-to-win64-in-progress.html'>Factor port to Win64 in progress</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-976754095456028820' itemprop='description articleBody'>
A year ago <a href="../2007/11/adventures-with-cygwin-on-64-bit.html">I tried to get a working gcc setup on 64-bit Windows with zero success</a>. This time around, I had better luck; the <a href="http://sourceforge.net/projects/mingw-w64/">MinGW-Win64</a> project has a functional gcc port out and I was able to use it to compile the Factor VM.<br /><br />The main hurdle to overcome is that Win64 uses a different calling convention from Linux/x86-64 and Mac OS X/x86-64. I got the non-optimizing compiler generating valid code, and set things up so that we now have two x86.64 boot images, <code>boot.winnt-x86.64.image</code> and <code>boot.unix-x86.64.image</code>, containing different non-optimizing compiler backends (most of the backend is shared, but some parameters are configured differently). After some messing around, I got it to load various modules, including the optimizing compiler.<br /><br />The main thing that tripped me up at this stage is that I did not have a working gdb, so certain problems were very hard to debug. For example, on my first reading of the Win64 calling conventions, I missed out that you must reserve 32 bytes in your stack frame for the callee to mess with, and if you put non-volatile data there, then calling any function will clobber your stack frame. This manifested in a most bizarre fashion, namely Factor would work if the VM was with <code>-O3</code> and crash if compiled with <code>-g</code>; usually we get the opposite, when we find gcc bugs. This time it was a bug in Factor, and the reason it would only crash with optimizations disabled is that the gcc optimizer would use registers to store values, instead of scribbling over the volatile portion of the caller's stack frame. A day of lost work later, I finally figured out the problem, and it was much smoother from thereon in.<br /><br />Next, I started updating the optimizing compiler backend. Again, the bulk of the work was with figuring out the calling convention. Win64 passes and returns structures differently from the other x86.64 platforms, so I to add some OS-specific hooks to the x86.64 optimizing compiler backend too.<br /><br />Overall, it seems like Microsoft's calling convention is simpler overall than the one used by Linux and Mac OS X, especially as far as passing structures by value is concerned. Other than the initial hurdle figuring out how the reserved scratch space in stack frame works, I was able to get things working fairly quickly.<br /><br />The tests all pass now, however testing some real C library bindings still reveals problems (hence the FFI tests are not exhaustive enough and need to be amended). I also need to do a lot of code cleanup before any of this is in a releasable state, so don't get your hopes up yet -- it will be a few more days before you can build Factor from git on Win64. Binary packages will follow soon after; this is mostly conditional on getting various external packages installed, such as PostgreSQL, SQLite, OpenSSL, and gdb. This is due to the fact that the build farm tests our most important C library bindings, and doesn't release anything if the tests fail (which is quite nice; if a bug in the C library binding prevents something important like OpenSSL from working, you really don't want users to come along and download the result).<br /><br />So while I work on finishing the port in the meantime, <a href="http://factorcode.org/win64.png">here is a screenshot</a> from when I got the FFI just far along enough to render, in a very broken fashion (no text!) the UI workspace and a couple of demos.<br /><br />Win64 seems rather neglected by the open source community; even gcc is only available in the experimental MinGW snapshots. However I think supporting it is important; moving to x86.64 can offer a performance boost from the additional registers and RIP-relative addressing mode, and the ability to address more than 4GB of RAM is going to be more and more important too. Very soon now Factor will be one of the few (or the only?) open source, natively-compiled, dynamic languages which can run on 64-bit Windows as well as 12 other platforms. Exciting times ahead.
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2008/11/factor-port-to-win64-in-progress.html' itemprop='url'/>
<a class='timestamp-link' href='11/factor-port-to-win64-in-progress.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2008-11-11T17:54:00-05:00'>5:54 PM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=976754095456028820' onclick=''>
No comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=976754095456028820' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=976754095456028820&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=976754095456028820&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=976754095456028820&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=976754095456028820&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=976754095456028820&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=976754095456028820&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Thursday, November 06, 2008</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='3920644984248099186' itemprop='postId'/>
<a name='3920644984248099186'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='11/further-performance-gains.html'>Further performance gains</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-3920644984248099186' itemprop='description articleBody'>
One thing I've learned over the last few months is that minor improvements to performance, accumulated over time, are just as important as big architectural changes which result in big gains. With the new code generator in place, I spent some time working on a few tweaks I've been thinking about for a while.<br /><h3>Tuple dispatch overview</h3><br />First up, I sped up method dispatch on tuples by eliminating some unnecessary conditional branches and memory accesses. In Factor, the object system is implemented in the language, and so all dispatch is done by generated Factor code. This code is generated at compile time. For example, we can define a tuple,<br /><pre>TUPLE: dog name breed ;</pre><br />and look at the code generated for the <code>breed</code> accessor:<br /><pre>( scratchpad ) \ breed>> def>> .<br />[<br />    dup tag dup 2 eq? [<br />        drop dup { tuple } declare 1 slot { array } declare<br />        7 slot dup \ dog eq?<br />        [ drop { dog } declare dog=>breed>> ]<br />        [ drop object=>breed>> ] if<br />    ] [ drop object=>breed>> ] if<br />]</pre><br />As you can see above, the generated code uses various low-level primitives to accelerate dispatch. Usually you will never work with these primitives directly. The words named <code><i>class</i>=><i>generic</i></code> are not real words in the dictionary; they are word objects corresponding to methods. So methods are essentially words, except they're not part of any vocabulary. Again, this is an implementation detail and you don't need to be aware of how methods are implemented behind the scenes. In the image where I defined this tuple, I had no other tuples with a slot named <code>breed</code>, so the generic accessor only has one method, and the code generated for a generic with one method is very simple. For generics with many methods, more complex code is generated; if you have enough methods, a hashtable dispatch is generated.<br /><br />The general philosophy of method dispatch on tuples is as follows. To each tuple, we associate an integer which is the length of the superclass chain from the tuple up to the root class of tuples, <code>tuple</code>. I call this the tuple's "echelon". Every tuple instance in the heap holds a pointer to a tuple layout object in its first slot. The tuple layout object holds the echelon, the sequence of superclasses, and the tuple size.<br /><br />The tuple class methods of a generic word are sorted into echelons, and dispatch proceeds by starting at the highest echelon and going down until a suitable method is found (or an error is thrown). At each echelon, the generic word looks at the corresponding entry in the superclass list of the tuple on the stack, and performs a hashtable lookup. So dispatch runs in O(n) time, where n is the maximum echelon number of the tuple classes participating in the generic word.<br /><br />For example, suppose we have the following inheritance hierarchy -- its contrieved, because in practice you probably would not have square inherit from rectangle, but it demonstrates a point here:<br /><pre>tuple<br />  text<br />  shape<br />    polygon<br />      quad<br />        rectangle<br />          square<br />        parallelogram<br />      triangle<br />    circle</pre><br />Now, suppose we have a generic word:<br /><pre>GENERIC: draw ( shape -- )<br /><br />M: text draw ... ;<br />M: rectangle draw ... ;<br />M: square draw ... ;<br />M: parallelogram draw ... ;<br />M: circle draw ... ;<br />M: triangle draw ... ;</pre><br />Note that if we pass a square instance to <code>draw</code>, we want it to invoke the <code>M: rectangle</code> method. Here are the participating classes, sorted into echelons:<br /><pre>level 1: text<br />level 2: circle<br />level 3: triangle<br />level 4: rectangle, parallelogram</pre><br />Method dispatch proceeds as follows:<br /><ul><li>If the tuple on the stack has echelon >= 4, we get the 4th element in its superclass chain, and check if it's <code>rectangle</code> or <code>parallelogram</code>. If so, we dispatch to that method. Note that the 4th element of the superclass chain of both rectangles and squares is <code>rectangle</code>.</li><li>If the tuple on the stack has echelon >= 3, we get the 3rd element and check if it's a triangle. If so, we dispatch to that method.</li><li>If the tuple on the stack has echelon >= 2, we get the 2nd element and check if its a circle. If it is, we dispatch to that method.</li><li>If the tuple on the stack has echelon >= 1, we get the 1st element and check if it's <code>text</code>. If so, we dispatch to that method.</li></ul><br />For this generic word, a maximum of four tests must be performed because the inheritance hierarchy is very tall. This situation is rare, since for the most part inheritance is very flat.<br /><h3>Method dispatch: removing conditionals and indirection</h3><br />The first thing I realized is that every tuple has an echelon level of at least 1, since it must have itself and <code>tuple</code> in the superclass chain. So the conditional test on the final step is unnecessary. Furthermore, if all tuples have echelon 1, there is no need to even load the echelon of the tuple on the stack into a register.<br /><br />Next, I decided to put the superclass list inside the tuple layout object itself, instead of having the tuple layout object reference an array. This removes one level of indirection, which reduces CPU cache pollution.<br /><br />To illustrate these improvements, look at the code generated for the <code>call</code> word before these improvements:<br /><pre>[<br />    dup tag dup 3 eq? [<br />        drop dup 0 slot 8 fixnum-fast dup 6 eq?<br />        [ drop { quotation } declare quotation=>call ]<br />        [ drop object=>call ] if<br />    ] [<br />        dup 2 eq? [<br />            drop dup { tuple } declare 1 slot<br />            { tuple-layout } declare 5 slot dup 1 fixnum>= [<br />                drop dup { tuple } declare 1 slot<br />                { tuple-layout } declare 4 slot<br />                { array } declare 3 slot { word } declare<br />                dup \ curry eq?<br />                [ drop { curry } declare curry=>call ] [<br />                    dup \ compose eq?<br />                    [ drop { compose } declare compose=>call ]<br />                    [ drop object=>call ] if<br />                ] if<br />            ] [ drop object=>call ] if<br />        ] [ drop object=>call ] if<br />    ] if<br />]</pre><br />And after:<br /><pre>[<br />    dup tag dup 2 eq? [<br />        drop dup { tuple } declare 1 slot { array } declare<br />        7 slot dup \ compose eq?<br />        [ drop { compose } declare compose=>call ] [<br />            dup \ curry eq?<br />            [ drop { curry } declare curry=>call ]<br />            [ drop object=>call ] if<br />        ] if<br />    ] [<br />        dup 3 eq? [<br />            drop dup { hi-tag } declare 0 slot dup 14 eq?<br />            [ drop { quotation } declare quotation=>call ]<br />            [ drop object=>call ] if<br />        ] [ drop object=>call ] if<br />    ] if<br />]</pre><br /><h3>Method dispatch: faster hashcode lookup</h3><br />If a generic word has more than 4 methods at the same echelon level, a hashtable dispach is generated instead of a series of linear tests. Formerly, the generated code would indirect through the class word to look up the hashcode. Again, this is bad for locality because it pulls in the entire word object's cache line in for no good reason. So what I did was intersperse the hashcodes with the superclass chain in the tuple layout object. The tuple layout object will already be in the cache, since we just read one of the superclass chain entries, so reading the hashcode is essentially free.<br /><h3>Method dispatch: re-ordering tests</h3><br />I noticed is that the <code>>fixnum</code> generic word had conditionals in an essentially random order. The cut-off between a series of conditionals and a jump table is 4 methods, and <code>>fixnum</code>, defining methods on every subtype of the reals, is the borderline case:<br /><pre>( scratchpad ) \ >fixnum def>> .<br />[<br />    dup tag dup 5 eq?<br />    [ drop { float } declare float=>>fixnum ] [<br />        dup 4 eq?<br />        [ drop { ratio } declare ratio=>>fixnum ] [<br />            dup 0 eq?<br />            [ drop { fixnum } declare fixnum=>>fixnum ] [<br />                dup 1 eq?<br />                [ drop { bignum } declare bignum=>>fixnum ]<br />                [ drop object=>>fixnum ] if<br />            ] if<br />        ] if<br />    ] if<br />]</pre><br />For various reasons, most <code>>fixnum</code> calls are made with a fixnum on the stack. By sorting the methods by tag number before generating the generic, I was able to get it to look like this:<br /><pre>( scratchpad ) \ >fixnum def>> .<br />[<br />    dup tag dup 0 eq?<br />    [ drop { fixnum } declare fixnum=>>fixnum ] [<br />        dup 1 eq?<br />        [ drop { bignum } declare bignum=>>fixnum ] [<br />            dup 4 eq?<br />            [ drop { ratio } declare ratio=>>fixnum ] [<br />                dup 5 eq?<br />                [ drop { float } declare float=>>fixnum ]<br />                [ drop object=>>fixnum ] if<br />            ] if<br />        ] if<br />    ] if<br />]</pre><br />This reduces the number of conditionals in the common case.<br /><h3>I/O system tweaks and <code>string-nth</code> intrinsic</h3><br />I made some changes to <code>io.ports</code> and <code>io.buffers</code>; mostly adding inline declarations. I also added a hint to the <code>push</code> word for the <code>sbuf</code> class; <code>stream-readln</code> would push every character onto an sbuf, and adding this fast-path eliminated some method dispatch. Finally, I made <code>string-nth</code> a compiler intrinsic rather than a call into the VM, which means that words where the compiler infers you're operating on strings will inline the intrinsic and perform less memory loads/stores and subroutine calls than before.<br /><h3>Eliminating useless branches with value numbering</h3><br />Take a look at what the high-level optimizer does to the following quotation:<br /><pre>( scratchpad ) [ [ { + - * } member? ] contains? ] optimized.<br />[<br />    dup length swap 0 -rot \ ( gensym ) [<br />        pick pick < [<br />            swap<br />            >r 2dup<br />            >r<br />            >r nth-unsafe dup \ * eq? [ t ] [ f ] if<br />            [ drop t ] [<br />                dup \ - eq? [ t ] [ f ] if<br />                [ drop t ]<br />                [ \ + eq? [ t ] [ f ] if [ t ] [ f ] if ] if<br />            ] if r><br />            r><br />            r><br />            swap<br />            >r rot r><br />            swap<br />            [ 2drop ]<br />            [ >r >r 1 +-integer-fixnum r> r> ( gensym ) ] if<br />        ] [ 3drop f ] if<br />    ] label dup [ ] [ ] if [ t ] [ f ] if<br />]</pre><br />A lot of dispatch is eliminated and methods are inlined, but there is some pretty crappy control flow redundancy there. I extended the low-level optimizer to eliminate it when building the low-level IR.<br /><br />One of the worst offenders is the <code>=</code> word, defined as follows:<br /><pre>: = ( obj1 obj2 -- ? )<br />    2dup eq? [ 2drop t ] [ equal? ] if ; inline</pre><br />If <code>obj2</code> is a word, then <code>equal?</code> expands into <code>2drop f</code>, so we get<br /><pre>2dup eq? [ 2drop t ] [ 2drop f ] if</pre><br />Then, dead code elimination converts this to<br /><pre>eq? [ t ] [ f ] if</pre><br />Ideally, we'd get rid of <code>[ t ] [ f ] if</code> altogether. Instead of doing this in the high-level optimizer, I decided to detect this code pattern, along with its negation <code>[ f ] [ t ] if</code> (which is the inlined definition of <code>not</code>) and emit a branchless comparison, instead:<br /><pre>( scratchpad ) [ \ + = ] test-mr mr.<br />=== word: ( gensym ), label: ( gensym )<br /><br />_label 0 <br />##prologue <br />_label 1 <br />##load-indirect V int-regs 582552 + <br />##peek V int-regs 582553 D 0 <br />##compare V int-regs 582555 V int-regs 582553 V int-regs 582552 cc= <br />##replace V int-regs 582555 D 0 <br />##epilogue <br />##return </pre><br />Now, suppose you have a code sequence like <code>[ t ] [ f ] if [ 1 ] [ 2 ] if</code> after inlining. Value numbering builds up an expression chain where one comparison depends on the result of another, and it is able to collapse them down to a single comparison.<br /><br />Finally, the empty conditional, <code>[ ] [ ] if</code>, manifests in value numbering as a conditional branch instruction where both successors point to the same node. This is replaced with an unconditional branch.<br /><h3>Results</h3><br />Here are the timings, in milliseconds, for 10 runs of the reverse-complement benchmark:<br /><pre>5309 5310 5342 5297 5305 5635 5344 5313 5338 5303</pre><br />This represents a 35% improvement over <a href="11/new-low-level-optimizer-and-code.html">last time</a>.<br /><br />Finally, bootstrap is faster too. On my laptop it now takes around 3 minutes 45 seconds, which is about 40 seconds faster than before.<br /><br /><b>Edit:</b> some more minor optimizations improved reverse-complement runtime by another 500 milliseconds or so.
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2008/11/further-performance-gains.html' itemprop='url'/>
<a class='timestamp-link' href='11/further-performance-gains.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2008-11-06T11:41:00-05:00'>11:41 AM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=3920644984248099186' onclick=''>
No comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=3920644984248099186' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=3920644984248099186&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3920644984248099186&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3920644984248099186&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3920644984248099186&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3920644984248099186&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3920644984248099186&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

        </div></div>
      
</div>
<div class='blog-pager' id='blog-pager'>
<span id='blog-pager-newer-link'>
<a class='blog-pager-newer-link' href='http://factor-language.blogspot.com/search?updated-max=2009-02-17T16:03:00-05:00&amp;max-results=7&amp;reverse-paginate=true' id='Blog1_blog-pager-newer-link' title='Newer Posts'>Newer Posts</a>
</span>
<span id='blog-pager-older-link'>
<a class='blog-pager-older-link' href='http://factor-language.blogspot.com/search?updated-max=2008-11-06T11:41:00-05:00&amp;max-results=7' id='Blog1_blog-pager-older-link' title='Older Posts'>Older Posts</a>
</span>
<a class='home-link' href='../index.html'>Home</a>
</div>
<div class='clear'></div>
<div class='blog-feeds'>
<div class='feed-links'>
Subscribe to:
<a class='feed-link' href='http://factor-language.blogspot.com/feeds/posts/default' target='_blank' type='application/atom+xml'>Posts (Atom)</a>
</div>
</div>
</div></div>
</div>
<div id='sidebar-wrapper'>
<div class='sidebar section' id='sidebar'><div class='widget BlogArchive' data-version='1' id='BlogArchive1'>
<h2>Older Posts</h2>
<div class='widget-content'>
<div id='ArchiveList'>
<div id='BlogArchive1_ArchiveList'>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2010/index.html'>
2010
</a>
<span class='post-count' dir='ltr'>(18)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2010/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2010/07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2010/05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2010/04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2010/03/index.html'>
March
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2010/02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2010/01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/index.html'>
2009
</a>
<span class='post-count' dir='ltr'>(35)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/08/index.html'>
August
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/03/index.html'>
March
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(6)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='index.html'>
2008
</a>
<span class='post-count' dir='ltr'>(96)</span>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(4)</span>
<ul class='posts'>
<li><a href='12/discussion-of-concatenative-languages.html'>Discussion of concatenative languages on various b...</a></li>
<li><a href='12/prevalence-of-shuffle-words-and.html'>Prevalence of shuffle words and dataflow combinators</a></li>
<li><a href='12/arrays-of-unboxed-primitive-values-and.html'>Arrays of unboxed primitive values, and a faster M...</a></li>
<li><a href='12/factor-now-fully-supported-on-64-bit.html'>Factor now fully supported on 64-bit Windows</a></li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(9)</span>
<ul class='posts'>
<li><a href='11/new-features-in-smtp-and-ssl-library.html'>New features in SMTP and SSL library allow sending...</a></li>
<li><a href='11/faster-generic-arithmetic-and-integer.html'>Faster generic arithmetic and integer overflow che...</a></li>
<li><a href='11/some-recent-ui-rendering-fixes.html'>Some recent UI rendering fixes</a></li>
<li><a href='11/comparing-performance-of-factor-and-v8.html'>Comparing the performance of Factor and V8</a></li>
<li><a href='11/factor-presentation-at-otug.html'>Factor presentation at OTUG</a></li>
<li><a href='11/factor-port-to-win64-in-progress.html'>Factor port to Win64 in progress</a></li>
<li><a href='11/further-performance-gains.html'>Further performance gains</a></li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='08/index.html'>
August
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='06/index.html'>
June
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(6)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(13)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='03/index.html'>
March
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(17)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/index.html'>
2007
</a>
<span class='post-count' dir='ltr'>(141)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(13)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(10)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(15)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/08/index.html'>
August
</a>
<span class='post-count' dir='ltr'>(21)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/06/index.html'>
June
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/03/index.html'>
March
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(15)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/index.html'>
2006
</a>
<span class='post-count' dir='ltr'>(207)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(23)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(30)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(25)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(22)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/08/index.html'>
August
</a>
<span class='post-count' dir='ltr'>(26)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(23)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/06/index.html'>
June
</a>
<span class='post-count' dir='ltr'>(11)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(15)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/03/index.html'>
March
</a>
<span class='post-count' dir='ltr'>(11)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2005/index.html'>
2005
</a>
<span class='post-count' dir='ltr'>(23)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2005/12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(11)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2005/11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2005/10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(6)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2005/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class='clear'></div>
</div>
</div><div class='widget Feed' data-version='1' id='Feed2'>
<h2>Recent Factor Commits</h2>
<div class='widget-content' id='Feed2_feedItemListDisplay'>
<span style='filter: alpha(25); opacity: 0.25;'>
<a href='http://gitweb.factorcode.org/gitweb.cgi?p=factor.git;a=atom'>Loading...</a>
</span>
</div>
<div class='clear'></div>
</div><div class='widget Feed' data-version='1' id='Feed1'>
<h2>Planet Factor</h2>
<div class='widget-content' id='Feed1_feedItemListDisplay'>
<span style='filter: alpha(25); opacity: 0.25;'>
<a href='http://planet.factorcode.org/feed.xml'>Loading...</a>
</span>
</div>
<div class='clear'></div>
</div><div class='widget LinkList' data-version='1' id='LinkList1'>
<h2>Links</h2>
<div class='widget-content'>
<ul>
<li><a href='http://twitter.com/slava_pestov'>@slava_pestov</a></li>
<li><a href='http://factorcode.org/slava/'>My home page</a></li>
<li><a href='http://factorcode.org/'>Factor programming language</a></li>
<li><a href='http://concatenative.org/'>Concatenative language wiki</a></li>
<li><a href='http://planet.factorcode.org/'>Planet Factor</a></li>
</ul>
<div class='clear'></div>
</div>
</div></div>
</div>
<!-- spacer for skins that want sidebar and main to be the same height-->
<div class='clear'>&#160;</div>
</div>
<!-- end content-wrapper -->
<div id='footer-wrapper'>
<div class='footer no-items section' id='footer'></div>
</div>
</div></div>
<!-- end outer-wrapper -->

<script type="text/javascript" src="https://www.blogger.com/static/v1/widgets/940443484-widgets.js"></script>
<script type='text/javascript'>
window['__wavt'] = 'AOuZoY4HoGNapdcoMZxmcJ5grpoGytwP0w:1693932705442';_WidgetManager._Init('//www.blogger.com/rearrange?blogID\x3d17087850','//factor-language.blogspot.com/2008/','17087850');
_WidgetManager._SetDataContext([{'name': 'blog', 'data': {'blogId': '17087850', 'title': 'Factor: a practical stack language', 'url': 'http://factor-language.blogspot.com/2008/', 'canonicalUrl': 'http://factor-language.blogspot.com/2008/', 'homepageUrl': 'http://factor-language.blogspot.com/', 'searchUrl': 'http://factor-language.blogspot.com/search', 'canonicalHomepageUrl': 'http://factor-language.blogspot.com/', 'blogspotFaviconUrl': 'http://factor-language.blogspot.com/favicon.ico', 'bloggerUrl': 'https://www.blogger.com', 'hasCustomDomain': false, 'httpsEnabled': true, 'enabledCommentProfileImages': true, 'gPlusViewType': 'FILTERED_POSTMOD', 'adultContent': false, 'analyticsAccountNumber': '', 'encoding': 'UTF-8', 'locale': 'en-US', 'localeUnderscoreDelimited': 'en', 'languageDirection': 'ltr', 'isPrivate': false, 'isMobile': false, 'isMobileRequest': false, 'mobileClass': '', 'isPrivateBlog': false, 'isDynamicViewsAvailable': true, 'feedLinks': '\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Factor: a practical stack language - Atom\x22 href\x3d\x22http://factor-language.blogspot.com/feeds/posts/default\x22 /\x3e\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/rss+xml\x22 title\x3d\x22Factor: a practical stack language - RSS\x22 href\x3d\x22http://factor-language.blogspot.com/feeds/posts/default?alt\x3drss\x22 /\x3e\n\x3clink rel\x3d\x22service.post\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Factor: a practical stack language - Atom\x22 href\x3d\x22https://www.blogger.com/feeds/17087850/posts/default\x22 /\x3e\n', 'meTag': '', 'adsenseHostId': 'ca-host-pub-1556223355139109', 'adsenseHasAds': false, 'adsenseAutoAds': false, 'boqCommentIframeForm': true, 'loginRedirectParam': '', 'view': '', 'dynamicViewsCommentsSrc': '//www.blogblog.com/dynamicviews/4224c15c4e7c9321/js/comments.js', 'dynamicViewsScriptSrc': '//www.blogblog.com/dynamicviews/591781cadcbb8744', 'plusOneApiSrc': 'https://apis.google.com/js/platform.js', 'disableGComments': true, 'interstitialAccepted': false, 'sharing': {'platforms': [{'name': 'Get link', 'key': 'link', 'shareMessage': 'Get link', 'target': ''}, {'name': 'Facebook', 'key': 'facebook', 'shareMessage': 'Share to Facebook', 'target': 'facebook'}, {'name': 'BlogThis!', 'key': 'blogThis', 'shareMessage': 'BlogThis!', 'target': 'blog'}, {'name': 'Twitter', 'key': 'twitter', 'shareMessage': 'Share to Twitter', 'target': 'twitter'}, {'name': 'Pinterest', 'key': 'pinterest', 'shareMessage': 'Share to Pinterest', 'target': 'pinterest'}, {'name': 'Email', 'key': 'email', 'shareMessage': 'Email', 'target': 'email'}], 'disableGooglePlus': true, 'googlePlusShareButtonWidth': 0, 'googlePlusBootstrap': '\x3cscript type\x3d\x22text/javascript\x22\x3ewindow.___gcfg \x3d {\x27lang\x27: \x27en\x27};\x3c/script\x3e'}, 'hasCustomJumpLinkMessage': false, 'jumpLinkMessage': 'Read more', 'pageType': 'archive', 'pageName': '2008', 'pageTitle': 'Factor: a practical stack language: 2008'}}, {'name': 'features', 'data': {}}, {'name': 'messages', 'data': {'edit': 'Edit', 'linkCopiedToClipboard': 'Link copied to clipboard!', 'ok': 'Ok', 'postLink': 'Post Link'}}, {'name': 'template', 'data': {'isResponsive': false, 'isAlternateRendering': false, 'isCustom': false}}, {'name': 'view', 'data': {'classic': {'name': 'classic', 'url': '?view\x3dclassic'}, 'flipcard': {'name': 'flipcard', 'url': '?view\x3dflipcard'}, 'magazine': {'name': 'magazine', 'url': '?view\x3dmagazine'}, 'mosaic': {'name': 'mosaic', 'url': '?view\x3dmosaic'}, 'sidebar': {'name': 'sidebar', 'url': '?view\x3dsidebar'}, 'snapshot': {'name': 'snapshot', 'url': '?view\x3dsnapshot'}, 'timeslide': {'name': 'timeslide', 'url': '?view\x3dtimeslide'}, 'isMobile': false, 'title': 'Factor: a practical stack language', 'description': '\x3ca href\x3d\x22http://factorcode.org/slava\x22\x3eSlava Pestov\x3c/a\x3e\x27s weblog, primarily about \x3ca href\x3d\x22http://factorcode.org\x22\x3eFactor\x3c/a\x3e.', 'url': 'http://factor-language.blogspot.com/2008/', 'type': 'feed', 'isSingleItem': false, 'isMultipleItems': true, 'isError': false, 'isPage': false, 'isPost': false, 'isHomepage': false, 'isArchive': true, 'isLabelSearch': false, 'archive': {'year': 2008, 'rangeMessage': 'Showing posts from 2008'}}}]);
_WidgetManager._RegisterWidget('_NavbarView', new _WidgetInfo('Navbar1', 'navbar', document.getElementById('Navbar1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_HeaderView', new _WidgetInfo('Header1', 'header', document.getElementById('Header1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogView', new _WidgetInfo('Blog1', 'main', document.getElementById('Blog1'), {'cmtInteractionsEnabled': false, 'lightboxEnabled': true, 'lightboxModuleUrl': 'https://www.blogger.com/static/v1/jsbin/1333563935-lbx.js', 'lightboxCssUrl': 'https://www.blogger.com/static/v1/v-css/3268905543-lightbox_bundle.css'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogArchiveView', new _WidgetInfo('BlogArchive1', 'sidebar', document.getElementById('BlogArchive1'), {'languageDirection': 'ltr', 'loadingMessage': 'Loading\x26hellip;'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_FeedView', new _WidgetInfo('Feed2', 'sidebar', document.getElementById('Feed2'), {'title': 'Recent Factor Commits', 'showItemDate': true, 'showItemAuthor': true, 'feedUrl': 'http://gitweb.factorcode.org/gitweb.cgi?p\x3dfactor.git;a\x3datom', 'numItemsShow': 5, 'loadingMsg': 'Loading...', 'openLinksInNewWindow': false, 'useFeedWidgetServ': 'true'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_FeedView', new _WidgetInfo('Feed1', 'sidebar', document.getElementById('Feed1'), {'title': 'Planet Factor', 'showItemDate': true, 'showItemAuthor': false, 'feedUrl': 'http://planet.factorcode.org/feed.xml', 'numItemsShow': 5, 'loadingMsg': 'Loading...', 'openLinksInNewWindow': false, 'useFeedWidgetServ': 'true'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_LinkListView', new _WidgetInfo('LinkList1', 'sidebar', document.getElementById('LinkList1'), {}, 'displayModeFull'));
</script>
</body>
</html>