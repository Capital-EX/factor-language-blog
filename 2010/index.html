<!DOCTYPE html>
<html dir='ltr'>
<head>
<link href='https://www.blogger.com/static/v1/widgets/55013136-widget_css_bundle.css' rel='stylesheet' type='text/css'/>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'/>
<meta content='blogger' name='generator'/>
<link href='../favicon.ico' rel='icon' type='image/x-icon'/>
<link href='index.html' rel='canonical'/>
<link rel="alternate" type="application/atom+xml" title="Factor: a practical stack language - Atom" href="http://factor-language.blogspot.com/feeds/posts/default" />
<link rel="alternate" type="application/rss+xml" title="Factor: a practical stack language - RSS" href="http://factor-language.blogspot.com/feeds/posts/default?alt=rss" />
<link rel="service.post" type="application/atom+xml" title="Factor: a practical stack language - Atom" href="https://www.blogger.com/feeds/17087850/posts/default" />
<!--Can't find substitution for tag [blog.ieCssRetrofitLinks]-->
<meta content='http://factor-language.blogspot.com/2010/' property='og:url'/>
<meta content='Factor: a practical stack language' property='og:title'/>
<meta content='&lt;a href=&quot;http://factorcode.org/slava&quot;&gt;Slava Pestov&lt;/a&gt;&#39;s weblog, primarily about &lt;a href=&quot;http://factorcode.org&quot;&gt;Factor&lt;/a&gt;.' property='og:description'/>
<title>Factor: a practical stack language: 2010</title>
<style id='page-skin-1' type='text/css'><!--
/*
-----------------------------------------------
Blogger Template Style
Name:     Stretch Denim Light
Designer: Darren Delaye
URL:      www.DarrenDelaye.com
Date:     11 Jul 2006
-----------------------------------------------
*/
body {
background: #ffffff;
margin: 0;
padding: 0px;
font: x-small Verdana, Arial;
text-align: center;
color: #333333;
font-size/* */:/**/small;
font-size: /**/small;
}
a:link {
color: #336699;
}
a:visited {
color: #336699;
}
a img {
border-width: 0;
}
#outer-wrapper {
font: normal normal 100% Verdana, Arial, Sans-serif;;
}
/* Header
----------------------------------------------- */
#header-wrapper {
margin:0;
padding: 0;
background-color: #c4e1ff;
text-align: left;
}
#header {
margin: 0 2%;
background-color: #c4e1ff;
color: #003366;
padding: 0;
font: normal normal 210% Verdana, Arial, Sans-serif;;
position: relative;
}
h1.title {
padding-top: 38px;
margin: 0 1% .1em;
line-height: 1.2em;
font-size: 100%;
}
h1.title a, h1.title a:visited {
color: #003366;
text-decoration: none;
}
#header .description {
display: block;
margin: 0 1%;
padding: 0 0 40px;
line-height: 1.4em;
font-size: 50%;
}
/* Content
----------------------------------------------- */
.clear {
clear: both;
}
#content-wrapper {
margin: 0 2%;
padding: 0 0 15px;
text-align: left;
background-color: #ffffff;
border: 1px solid #ffffff;
border-top: 0;
}
#main-wrapper {
margin-left: 1%;
width: 64%;
float: left;
background-color: #ffffff;
display: inline;       /* fix for doubling margin in IE */
word-wrap: break-word; /* fix for long text breaking sidebar float in IE */
overflow: hidden;      /* fix for long non-text content breaking IE sidebar float */
}
#sidebar-wrapper {
margin-right: 1%;
width: 29%;
float: right;
background-color: #ffffff;
display: inline;       /* fix for doubling margin in IE */
word-wrap: break-word; /* fix for long text breaking sidebar float in IE */
overflow: hidden;      /* fix for long non-text content breaking IE sidebar float */
}
/* Headings
----------------------------------------------- */
h2, h3 {
margin: 0;
}
/* Posts
----------------------------------------------- */
.date-header {
margin: 1.5em 0 0;
font-weight: normal;
color: #999999;
font-size: 100%;
}
.post {
margin: 0 0 1.5em;
padding-bottom: 1.5em;
}
.post-title {
margin: 0;
padding: 0;
font-size: 125%;
font-weight: bold;
line-height: 1.1em;
}
.post-title a, .post-title a:visited, .post-title strong {
text-decoration: none;
color: #333333;
font-weight: bold;
}
.post div {
margin: 0 0 .75em;
line-height: 1.3em;
}
.post-footer {
margin: -.25em 0 0;
color: #333333;
font-size: 87%;
}
.post-footer .span {
margin-right: .3em;
}
.post img, table.tr-caption-container {
padding: 4px;
border: 1px solid #ffffff;
}
.tr-caption-container img {
border: none;
padding: 0;
}
.post blockquote {
margin: 1em 20px;
}
.post blockquote p {
margin: .75em 0;
}
/* Comments
----------------------------------------------- */
#comments h4 {
margin: 1em 0;
color: #999999;
}
#comments h4 strong {
font-size: 110%;
}
#comments-block {
margin: 1em 0 1.5em;
line-height: 1.3em;
}
#comments-block dt {
margin: .5em 0;
}
#comments-block dd {
margin: .25em 0 0;
}
#comments-block dd.comment-footer {
margin: -.25em 0 2em;
line-height: 1.4em;
font-size: 78%;
}
#comments-block dd p {
margin: 0 0 .75em;
}
.deleted-comment {
font-style:italic;
color:gray;
}
.feed-links {
clear: both;
line-height: 2.5em;
}
#blog-pager-newer-link {
float: left;
}
#blog-pager-older-link {
float: right;
}
#blog-pager {
text-align: center;
}
/* Sidebar Content
----------------------------------------------- */
.sidebar h2 {
margin: 1.6em 0 .5em;
padding: 4px 5px;
background-color: #ffffff;
font-size: 100%;
color: #333333;
}
.sidebar ul {
margin: 0;
padding: 0;
list-style: none;
}
.sidebar li {
margin: 0;
padding-top: 0;
padding-right: 0;
padding-bottom: .5em;
padding-left: 15px;
text-indent: -15px;
line-height: 1.5em;
}
.sidebar {
color: #333333;
line-height:1.3em;
}
.sidebar .widget {
margin-bottom: 1em;
}
.sidebar .widget-content {
margin: 0 5px;
}
/* Profile
----------------------------------------------- */
.profile-img {
float: left;
margin-top: 0;
margin-right: 5px;
margin-bottom: 5px;
margin-left: 0;
padding: 4px;
border: 1px solid #ffffff;
}
.profile-data {
margin:0;
text-transform:uppercase;
letter-spacing:.1em;
font-weight: bold;
line-height: 1.6em;
font-size: 78%;
}
.profile-datablock {
margin:.5em 0 .5em;
}
.profile-textblock {
margin: 0.5em 0;
line-height: 1.6em;
}
/* Footer
----------------------------------------------- */
#footer {
clear: both;
text-align: center;
color: #333333;
}
#footer .widget {
margin:.5em;
padding-top: 20px;
font-size: 85%;
line-height: 1.5em;
text-align: left;
}
/** Page structure tweaks for layout editor wireframe */
body#layout #header {
width: 750px;
}

--></style>
<link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=17087850&amp;zx=107902e8-e226-40c6-bb3f-e93edf539d65' media='none' onload='if(media!=&#39;all&#39;)media=&#39;all&#39;' rel='stylesheet'/><noscript><link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=17087850&amp;zx=107902e8-e226-40c6-bb3f-e93edf539d65' rel='stylesheet'/></noscript>
<meta name='google-adsense-platform-account' content='ca-host-pub-1556223355139109'/>
<meta name='google-adsense-platform-domain' content='blogspot.com'/>

</head>
<body>
<div class='navbar section' id='navbar'><div class='widget Navbar' data-version='1' id='Navbar1'><script type="text/javascript">
    function setAttributeOnload(object, attribute, val) {
      if(window.addEventListener) {
        window.addEventListener('load',
          function(){ object[attribute] = val; }, false);
      } else {
        window.attachEvent('onload', function(){ object[attribute] = val; });
      }
    }
  </script>
<div id="navbar-iframe-container"></div>
<script type="text/javascript" src="https://apis.google.com/js/platform.js"></script>
<script type="text/javascript">
      gapi.load("gapi.iframes:gapi.iframes.style.bubble", function() {
        if (gapi.iframes && gapi.iframes.getContext) {
          gapi.iframes.getContext().openChild({
              url: 'https://www.blogger.com/navbar.g?targetBlogID\x3d17087850\x26blogName\x3dFactor:+a+practical+stack+language\x26publishMode\x3dPUBLISH_MODE_BLOGSPOT\x26navbarType\x3dBLUE\x26layoutType\x3dLAYOUTS\x26searchRoot\x3dhttps://factor-language.blogspot.com/search\x26blogLocale\x3den_US\x26v\x3d2\x26homepageUrl\x3dhttp://factor-language.blogspot.com/\x26vt\x3d1910212838315471456',
              where: document.getElementById("navbar-iframe-container"),
              id: "navbar-iframe"
          });
        }
      });
    </script><script type="text/javascript">
(function() {
var script = document.createElement('script');
script.type = 'text/javascript';
script.src = '//pagead2.googlesyndication.com/pagead/js/google_top_exp.js';
var head = document.getElementsByTagName('head')[0];
if (head) {
head.appendChild(script);
}})();
</script>
</div></div>
<div id='outer-wrapper'><div id='wrap2'>
<!-- skip links for text browsers -->
<span id='skiplinks' style='display:none;'>
<a href='index.html#main'>skip to main </a> |
      <a href='index.html#sidebar'>skip to sidebar</a>
</span>
<div id='header-wrapper'>
<div class='header section' id='header'><div class='widget Header' data-version='1' id='Header1'>
<div id='header-inner'>
<div class='titlewrapper'>
<h1 class='title'>
<a href='../index.html'>
Factor: a practical stack language
</a>
</h1>
</div>
<div class='descriptionwrapper'>
<p class='description'><span><a href="http://factorcode.org/slava">Slava Pestov</a>'s weblog, primarily about <a href="http://factorcode.org">Factor</a>.</span></p>
</div>
</div>
</div></div>
</div>
<div id='content-wrapper'>
<div id='crosscol-wrapper' style='text-align:center'>
<div class='crosscol no-items section' id='crosscol'></div>
</div>
<div id='main-wrapper'>
<div class='main section' id='main'><div class='widget Blog' data-version='1' id='Blog1'>
<div class='blog-posts hfeed'>

          <div class="date-outer">
        
<h2 class='date-header'><span>Saturday, September 18, 2010</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='2482709033725182854' itemprop='postId'/>
<a name='2482709033725182854'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='09/factor-094-now-available.html'>Factor 0.94 now available</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-2482709033725182854' itemprop='description articleBody'>
<p>Factor 0.94 is now available from the <a href="http://factorcode.org">Factor website</a>, five months after the previous release, Factor 0.93. Binaries are provided for 10 platforms.</p> <p>As usual, contributors did most of the work. Thanks to Daniel Ehrenberg, Dmitry Shubin, Doug Coleman, Erik Charlebois, Joe Groff, John Benediktsson, Jose A. Ortega Ruiz, Niklas Waern, Samuel Tardieu, Sascha Matzke and everyone else who helped out this time around!</p> <h3>Incompatible changes:</h3> <ul> <li>The PowerPC architecture is no longer supported. (Slava Pestov)</li> <li>The <a href="http://docs.factorcode.org/content/word-require-when%2Cvocabs.loader.html">require-when</a> word now supports dependencies on multiple vocabularies. (Daniel Ehrenberg)</li> <li>The <code>C-ENUM:</code> word in the C library interface has been replaced with <a href="http://docs.factorcode.org/content/word-ENUM__colon__%2Calien.syntax.html">ENUM:</a>, a much improved word for defining type-safe enumerations. (Erik Charlebois, Joe Groff)</li> <li>Tuple slot setter words with stack effect <code>( value object -- )</code> are now named <code>foo&lt;&lt;</code> instead of <code>(>>foo)</code>. Most code is unaffected since it uses the <code>>>foo</code> form. (Slava Pestov)</li> <li>The older <code>system-micros</code> word, which returned microseconds since the Unix epoch as an integer, has been removed. For a while, the recommended way to get the current time has been to call the <code>now</code> word from the <a href="http://docs.factorcode.org/content/vocab-calendar.html">calendar</a> vocabulary, which returned a <a href="http://docs.factorcode.org/content/word-timestamp%2Ccalendar.html">timestamp</a> instance. (Doug Coleman)</li> <li>A few sequence-related words were moved from the <a href="http://docs.factorcode.org/content/vocab-generalizations.html">generalizations</a> vocabulary to <a href="http://docs.factorcode.org/content/vocab-sequences.generalizations.html">sequences.generalizations</a>. (Slava Pestov)</li> <li>The <code>alarms</code> vocabulary has been renamed to <a href="http://docs.factorcode.org/content/vocab-timers.html">timers</a> to better explain its true purpose, with improved timing accuracy and robustness. (Doug Coleman)</li> <li><a href="http://docs.factorcode.org/content/vocab-cocoa.subclassing.html">cocoa.subclassing</a>: the syntax for defining new Objective-C classes has been changed to improve readability. (Slava Pestov)</li> <li><a href="http://docs.factorcode.org/content/vocab-io.streams.limited.html">io.streams.limited</a>: the ability to throw errors on EOF was extracted from limited streams, and limited streams simplified as a result. Throwing on EOF is now implemented by the <a href="http://docs.factorcode.org/content/vocab-io.streams.throwing.html">io.streams.throwing</a> vocabulary. (Doug Coleman)</li> </ul> <h3>New libraries:</h3> <ul> <li><a href="http://docs.factorcode.org/content/vocab-boyer-moore.html">boyer-moore</a>: efficient text search algorithm (Dmitry Shubin)</li> <li><a href="http://docs.factorcode.org/content/vocab-checksums.internet.html">checksums.internet</a>: implementation of checksum algorithm used by ICMP for the <a href="http://docs.factorcode.org/content/vocab-checksums.html">checksums</a> framework (John Benediktsson)</li> <li><a href="http://docs.factorcode.org/content/vocab-gdbm.html">gdbm</a>: disk-based hash library binding (Dmitry Shubin)</li> <li><a href="http://docs.factorcode.org/content/vocab-io.encodings.detect.html">io.encodings.detect</a>: binary file/text encoding detection heuristics from jEdit (Joe Groff)</li> <li><a href="http://docs.factorcode.org/content/vocab-javascriptcore.html">javascriptcore</a>: FFI to the WebKit JavaScript engine (Doug Coleman)</li> <li><a href="http://docs.factorcode.org/content/vocab-lua.html">lua</a>: FFI to the Lua scripting language (Erik Charlebois)</li> <li><a href="http://docs.factorcode.org/content/vocab-oauth.html">oauth</a>: minimal implementation of client-side OAuth (Slava Pestov)</li> <li><a href="http://docs.factorcode.org/content/vocab-sequences.unrolled.html">sequences.unrolled</a>: efficient unrolled loops with constant iteration count (Joe Groff)</li> </ul> <h3>Improved libraries:</h3> <ul> <li><a href="http://docs.factorcode.org/content/vocab-cuda.html">cuda</a>: various improvements (Joe Groff, Doug Coleman)</li> <li><a href="http://docs.factorcode.org/content/vocab-game.input.html">game.input</a>: now uses XInput2 on X11 (Niklas Waern)</li> <li><a href="http://docs.factorcode.org/content/vocab-gpu.render.html">gpu.render</a>, <a href="http://docs.factorcode.org/content/vocab-gpu.buffers.html">gpu.buffers</a>: various improvements (Joe Groff)</li> <li><a href="http://docs.factorcode.org/content/vocab-math.combinatorics.html">math.combinatorics</a>: various improvements (John Benediktsson)</li> <li><a href="http://docs.factorcode.org/content/vocab-math.primes.html">math.primes</a>: various improvements (Samuel Tardieu)</li> <li><a href="http://docs.factorcode.org/content/vocab-math.vectors.simd.cords.html">math.vectors.simd.cords</a>: compound "256-bit" SIMD types now support the full set of SIMD operations (Joe Groff)</li> <li><a href="http://docs.factorcode.org/content/vocab-mongodb.html">mongodb</a>: various improvements (Sascha Matzke)</li> <li><a href="http://docs.factorcode.org/content/vocab-twitter.html">twitter</a>: now uses OAuth as required by Twitter (Slava Pestov)</li> <li><a href="http://docs.factorcode.org/content/vocab-unix.users.html">unix.users,</a> <a href="http://docs.factorcode.org/content/vocab-unix.groups.html">unix.groups</a>: various improvements (Doug Coleman)</li> </ul> <h3>Compiler improvements:</h3> <ul> <li>Improved instruction selection, copy propagation, representation selection, and register allocation; details in a <a href="05/collection-of-small-compiler.html">blog post</a>. (Slava Pestov) <li>An instruction scheduling pass now runs prior to register allocation, intended to reduce register pressure by moving uses closer to definitions; details in a <a href="http://useless-factor.blogspot.com/2010/02/instruction-scheduling-for-register.html">blog post</a>. (Daniel Ehrenberg)</li> <li>The code generation for the C library interface has been revamped; details in a <a href="07/overhauling-factors-c-library-interface.html">blog post</a>. (Slava Pestov) <li>Something similar to what C++ and C# programmers refer to as "value types"; binary data can now be allocated on the call stack, and passed to C functions like any other pointer. The <a href="http://docs.factorcode.org/content/word-with-out-parameters%2Calien.data.html">with-out-parameters</a> combinator replaces tricky code for allocating and juggling multiple temporary byte arrays used as out parameters for C function calls, making this idiom easier to read and more efficient. The <a href="http://docs.factorcode.org/content/word-with-scoped-allocation,alien.data.html">with-scoped-allocation</a> combinator presents a more general, lower-level interface. (Slava Pestov)</li> <li>The compiler can now use the x87 floating point unit on older CPUs where SSE2 is not available. However, this is not recommended, because the build farm does not test Factor (or build any binaries) in x87 mode, so this support can break at any time. To use x87 code generation, you must download the source code and bootstrap Factor yourself, on a CPU without SSE2. (Slava Pestov)</li> </ul> <h3>Miscellaneous improvements:</h3> <ul> <li><code>fuel</code>: Factor's Ultimate Emacs Library has seen many improvements, and also some keyboard shortcuts have changed; see the <a href="index.html">README</a>. (Erik Charlebois, Dmitry Shubin, Jose A. Ortega Ruiz)</li> <li>A new <code>factor.cmd</code> script is now included in the <code>build-support</code> directory, to automate the update/build/bootstrap cycle for those who build from source. Its functionality is a subset of the <code>factor.sh</code> script for Unix. (Joe Groff)</li> <li>The default set of icons shipped in <code>misc</code> has been tweaked, with better contrast and improved appearance when scaled down. (Joe Groff)</li> </ul>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2010/09/factor-094-now-available.html' itemprop='url'/>
<a class='timestamp-link' href='09/factor-094-now-available.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2010-09-18T23:40:00-04:00'>11:40 PM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=2482709033725182854' onclick=''>
No comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=2482709033725182854' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=2482709033725182854&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=2482709033725182854&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=2482709033725182854&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=2482709033725182854&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=2482709033725182854&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=2482709033725182854&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Saturday, September 11, 2010</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='3219921363760945818' itemprop='postId'/>
<a name='3219921363760945818'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='09/overview-of-factors-io-library.html'>An overview of Factor's I/O library</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-3219921363760945818' itemprop='description articleBody'>
<p>Factor has grown a very powerful and high-level I/O library over the years, however it is easy to get lost in the forest of reference documentation surrounding the <a href="http://docs.factorcode.org/content/vocab-io.html">io</a> vocabulary hierarchy. In this blog post I'm attempting to give an overview of the functionality available, with some easy-to-digest examples, along with links for futher reading. I will also touch upon some common themes that come up throughout the library, such as encoding support, timeouts, and uses for dynamically-scoped variables.</p> <p>Factor's I/O library is the work of many contributors over the years. Implementing FFI bindings to native I/O APIs, developing high-level abstractions on top, and making the whole thing cross-platform takes many people. In particular <a href="http://docs.factorcode.org/content/author-Doug%20Coleman.html">Doug Coleman</a> did a lot of heavy lifting early on for the Windows port, and also implemented several new cross-platform features such as file system metadata and memory mapped files.</p> <p>Our I/O library is competitive with Python's APIs and Java's upcoming NIO2 in breadth of functionality. I like to think the design is quite a bit cleaner too, because instead of being a thin wrapper over POSIX we try to come up with clear and conherent APIs that make sense on both Windows and Unix.</p> <h3>First example: converting a text file from MacRoman to UTF8</h3> <p>The <a href="http://docs.factorcode.org/content/vocab-io.files.html">io.files</a> vocabulary defines words for reading and writing files. It supports two modes of operation in a pretty standard fashion:</p> <ul> <li>Stream-based: <a href="http://docs.factorcode.org/content/word-with-file-reader,io.files.html">with-file-reader</a>, <a href="http://docs.factorcode.org/content/word-with-file-writer,io.files.html">with-file-writer</a></li> <li>Entire file: <a href="http://docs.factorcode.org/content/word-file-contents,io.files.html">file-contents</a>, <a href="http://docs.factorcode.org/content/word-set-file-contents,io.files.html">set-file-contents</a>, <a href="http://docs.factorcode.org/content/word-file-lines,io.files.html">file-lines</a>, <a href="http://docs.factorcode.org/content/word-set-file-lines,io.files.html">set-file-lines</a></li> </ul> <p>What makes Factor's file I/O interesting is that it takes advantage of pervasive support for I/O encoding. In Factor, a string is not a sequence of bytes; it is a sequence of Unicode code points. When reading and writing strings on external resources, which only consist of bytes, an encoding parameter is given to specify the conversion from strings to byte arrays.</p> <p>Let's convert <code>foo.txt</code> from MacRoman, an older encoding primarily used by classic Mac OS, to UTF8:</p> <pre>USING: io.encodings.8-bit.mac-roman io.encodings.utf8 io.files ;<br /><br />"foo.txt" mac-roman file-contents<br />"foo.txt" utf8 set-file-contents</pre> <p>This is a very simple and concise implementation but it has the downside that the entire file is read into memory. For most small text files this does not matter, but if efficiency is a concern then we can do the conversion a line at a time:</p> <pre>USING: io io.encodings.8-bit.mac-roman io.encodings.utf8<br />io.files ;<br /><br />"out.txt" utf8 [<br />    "in.txt" mac-roman [<br />        [ print ] each-line<br />    ] with-file-reader<br />] with-file-writer</pre> <h3>Converting a directory full of files from MacRoman to UTF8</h3> <p>The <a href="http://docs.factorcode.org/content/vocab-io.files.html">io.files</a> vocabulary defines words for listing and modifying directories. Let's make the above example more interesting by performing the conversion on a directory full of files:</p> <pre>USING: io.directories io.encodings.8-bit.mac-roman<br />io.encodings.utf8 io.files ;<br /><br />: convert-directory ( path -- )<br />    [<br />        [<br />            [ mac-roman file-contents ] keep<br />            utf8 set-file-contents<br />        ] each<br />    ] with-directory-files ;</pre> <h3>An aside: generalizing the "current working directory"</h3> <p>If you run the following, you will see that <code>with-directory-files</code> returns relative, and not absolute, file names:</p> <pre>"/path/to/some/directory"<br />[ [ print ] each ] with-directory-files</pre> <p>So the question is, how did <code>file-contents</code> above know what directory to look for files in? The answer is that in addition to calling the quotation with the directory's contents, the <code>with-directory-files</code> word also rebinds the <a href="http://docs.factorcode.org/content/word-current-directory,io.pathnames.html">current-directory</a> dynamic variable.</p> <p>This directory is the Factor equivalent of the familiar Unix notion of "current working directory". It generalizes the Unix feature by making it dynamically-scoped; within the quotation passed to the <code>with-directory</code> combinator, relative paths are resolved relative to that directory, but other coroutines executing at the time, or code after the quotation, is unaffected. This functionality is implemented entirely at the library level; all pathname strings are "normalized" with the <code>normalize-pathname</code> word before being handed off to the operating system.</p> <p>When calling a shell command with <code>io.launcher</code>, the child process is run from the Factor <code>current-directory</code> so relative pathnames passed on the command line will just work. However, when making C FFI calls which take pathnames, you pass in absolute paths only, or normalize the path with <code>normalize-path</code> first, otherwise the C code wlll search for it in the wrong place.</p> <h3>Checking free disk space</h3> <p>The <a href="http://docs.factorcode.org/content/vocab-io.files.info.html">io.files.info</a> vocabulary defines two words which return tuples containing information about a file, and the file system containing the file, respectively: <ul> <li><a href="http://docs.factorcode.org/content/word-file-info,io.files.info.html">file-info</a></li> <li><a href="http://docs.factorcode.org/content/word-file-system-info,io.files.info.html">file-system-info</a></li> </ul> <p>Let's say your application needs to install some files in the user's home directory, but instead of failing half-way through in the event that there is insufficient space, you'd rather display a friendly error message upfront:</p> <pre>ERROR: buy-a-new-disk ;<br /><br />: gb ( m -- n ) 30 2^ * ;<br /><br />: check-space ( -- )<br />    home file-system-info free-space>> 10 gb <<br />    [ buy-a-new-disk ] when ;</pre> <p>Now if there is less than 10gb available, the <code>check-space</code> word will throw a <code>buy-a-new-disk</code> error.</p> <p>The <code>file-system-info</code> word reports a bunch of other info. There is a Factor implementation of the Unix <code>df</code> command in the <a href="http://docs.factorcode.org/content/vocab-tools.files.html">tools.files</a> vocabulary: <pre>( scratchpad ) file-systems.<br />+device-name+ +available-space+ +free-space+ +used-space+ +total-space+ +percent-used+ +mount-point+<br />/dev/disk0s2  15955816448       16217960448  183487713280 199705673728  91             /<br />fdesc         0                 0            1024         1024          100            /dev<br />fdesc         0                 0            1024         1024          100            /dev<br />map -hosts    0                 0            0            0             0              /net<br />map auto_home 0                 0            0            0             0              /home<br />/dev/disk1s2  15922262016       15922262016  383489052672 399411314688  96             /Users/slava</pre> <p>Doug has two blog posts about these features, <a href="http://code-factor.blogspot.com/2009/01/files-and-file-systems-in-factor-part-1.html">part 1</a> and <a href="http://code-factor.blogspot.com/2009/01/files-and-file-systems-in-factor-part-2.html">part 2</a>.</p> <h3>Unix only: symbolic links</h3> <p>Factor knows about symbolic links on Unix. The <a href="http://docs.factorcode.org/content/vocab-io.files.links.html">io.files.links</a> vocabulary defines a pair of words, <a href="http://docs.factorcode.org/content/word-make-link,io.files.links.html">make-link</a> and <a href="http://docs.factorcode.org/content/word-make-hard-link,io.files.links.html">make-hard-link</a>. The <a href="http://docs.factorcode.org/content/word-link-info,io.files.info.html">link-info</a> word is like <a href="http://docs.factorcode.org/content/word-file-info,io.files.info.html">file-info</a> except it doesn't follow symbolic links. Finally, the <a href="http://docs.factorcode.org/content/vocab-io.directories.hierarchy.html">directory hierarchy traversal words</a> don't follow links, so a link cycle or bogus link to / somewhere won't break everything.</p> <h3>File system monitoring</h3> <p>The <a href="http://docs.factorcode.org/content/vocab-io.monitors.html">io.monitors</a> vocabulary implements real-time file and directory change monitoring. Unfortunately at this point in time, it is only supported on Windows, Linux and Mac. Neither one of FreeBSD and OpenBSD exposes the necessary information to user-space.</p> <p>Here is an example for watching a directory for changes, and logging them:</p> <pre>USE: io.monitors<br /><br />: watch-loop ( monitor -- )<br />    dup next-change path>> print flush watch-loop ;<br /><br />: watch-directory ( path -- )<br />    [ t [ watch-loop ] with-monitor ] with-monitors ;</pre> <p>Try pasting the above code into a Factor listener window, and then run <code>home watch-directory</code>. Every time a file in your home directory is modified, its full pathname will be printed in the listener.</p> <p>Java will only begin to support symbolic links and directory monitoring in the upcoming JDK7 release.</p> <h3>Memory mapped files</h3> <p>The <a href="http://docs.factorcode.org/content/vocab-io.mmap.html">io.mmap</a> vocabulary defines support for working with memory-mapped files. The highest-level and easiest to use interface is the <a href="http://docs.factorcode.org/content/word-with-mapped-array,io.mmap.html">with-mapped-array</a> combinator. It takes a file name, a <a href="http://docs.factorcode.org/content/article-c-types-specs.html">C type</a>, and a quotation. The quotation can perform generic sequence operations on the mapped file.</p> <p>Here is an example which reverses each group of 4 bytes:</p> <pre>USING: alien.c-types grouping io.mmap sequences<br />specialized-arrays ;<br />SPECIALIZED-ARRAY: char<br /><br />"mydata.dat" char [<br />    4 &lt;sliced-groups><br />    [ reverse! drop ] each<br />] with-mapped-array</pre> <p>The <a href="http://docs.factorcode.org/content/word-__lt__sliced-groups__gt__%2Cgrouping.html">&lt;sliced-groups></a> word returns a view of an underlying sequence, grouped into n-element subsequences. Mutating one of these subsequences in-place mutates the underlying sequence, which in our case is a mapped view of a file.</p> <p>A more efficient implementation of the above is also possible, by mapping in the file as an <code>int</code> array and then performing bitwise arithmetic on the elements.</p> <h3>Launching processes</h3> <p>Factor's <a href="http://docs.factorcode.org/content/vocab-io.launcher.html">io.launcher</a> vocabulary was originally developed for use by the <a href="09/making-factors-continuous-build-system.html">build farm</a>. The build farm needs to launch processes with precise control over I/O redirection and timeouts, and so a rich set of cross-platform functionality was born.</p> <p>The central concept in the library is the <code>process</code>, tuple, constructed by calling <code>&lt;process></code>. Various slots of the process tuple can be filled in to specify the command line, environment variables, redirection, and so on. Then the process can be run in various ways, running in the foreground, in the background, or with input and output attached to Factor streams.</p> <p>The launcher's I/O redirection is very flexible. If you don't touch the redirection slots in a process tuple, the subprocess will just inherit the current standard input and output. You can specify a file name to read or write from, a file name to append to, or even supply a pipe object, constructed from the <a href="http://docs.factorcode.org/content/vocab-io.pipes.html">io.pipes</a> vocabulary.</p> <pre>&lt;process><br />    "rotate-logs" >>command<br />    +closed+ >>stdin<br />    "out.txt" >>stdout<br />    "error.log" &lt;appender> >>stderr</pre> <p>It is possible to specify a timeout when running a process:</p> <pre>&lt;process><br />    { "ssh" "myhost" "-l" "jane" "do-calculation" } >>command<br />    15 minutes >>timeout<br />    "results.txt" >>stdout<br />run-process</pre> The process will be killed if it runs for longer than the timeout period. Many other features are supported; setting environment variables, setting process priority, and so on. The <a href="http://docs.factorcode.org/content/vocab-io.launcher.html">io.launcher</a> vocabulary has all the details. <p>Support for timeouts is a cross-cutting concern that touches many ports of the I/O API. This support is consolidated in the <a href="http://docs.factorcode.org/content/vocab-io.timeouts.html">io.timeouts</a> vocabulary. The <code>set-timeout</code> generic word is supported by all external resources which provide interruptible blocking operations.</p> <p>Timeouts are implemented on top of our <a href="http://code-factor.blogspot.com/2009/11/monotonic-timers.html">monotonic timer support</a>; changing your system clock while Factor is running won't screw with active network connections.</p> <h3>Unix only: file ownership and permissions</h3> <p>The <code>io.files.unix</code> vocabulary defines words for reading and writing file ownership and permissions. Using this vocabulary, we can write a shell script to a file, make it executable, and run it. An essential component of any multi-language quine:</p> <pre>USING: io.encodings.ascii io.files io.files.info.unix<br />io.launcher ;<br /><br />"""<br />#!/bin/sh<br />echo "Hello, polyglot"<br />""" "script.sh" ascii set-file-contents<br />OCT: 755 "script.sh" set-file-permissions<br />"./script.sh" run-process</pre> <p>There are even more Unix-specific words in the <a href="http://docs.factorcode.org/content/vocab-unix.users.html">unix.users</a> and <a href="http://docs.factorcode.org/content/vocab-unix.groups.html">unix.groups</a> vocabularies. Using these words enables listing all users on the system, converting user names to UIDs and back, and even <code>setuid</code> and <code>setgid</code>.</p> <h3>Networking</h3> <p>Factor's <a href="http://docs.factorcode.org/content/vocab-io.sockets.html">io.sockets</a> vocabulary supports stream and packet-based networking.</p> <ul> <li>Stream-based: <a href="http://docs.factorcode.org/content/word-with-client,io.sockets.html">with-client</a>, <a href="http://docs.factorcode.org/content/word-__lt__server__gt__,io.sockets.html">&lt;server></a>, <a href="http://docs.factorcode.org/content/word-accept,io.sockets.html">accept</a></li> <li>Packet-based: <a href="http://docs.factorcode.org/content/word-__lt__datagram__gt__,io.sockets.html">&lt;datagram></a>, <a href="http://docs.factorcode.org/content/word-send%2Cio.sockets.html">send</a>, <a href="http://docs.factorcode.org/content/word-receive%2Cio.sockets.html">receive</a></li> </ul> <p>Network addresses are specified in a flexible manner. Specific classes exist for IPv4, IPv6 and Unix domain socket addressing. When a network socket is constructed, that endpoint is bound to a given address specifier.</p> <p>Connecting to <code>http://www.apple.com</code>, sending a GET request, and reading the result:</p> <pre>USING: io io.encodings.utf8 io.sockets ;<br /><br />"www.apple.com" 80 &lt;inet> utf8 [<br />    """GET / HTTP/1.1\r<br />host: www.apple.com\r<br />connection: close\r<br />\r<br />""" write flush<br />    contents<br />] with-client<br />print</pre> <p>SSL support is almost transparent; the only difference is that the address specifier is wrapped in <code>&lt;secure></code>:</p> <pre>USING: io io.encodings.utf8 io.sockets<br />io.sockets.secure ;<br /><br />"www.cia.gov" 443 &lt;inet> &lt;secure> utf8 [<br />    """GET / HTTP/1.1\r<br />host: www.cia.gov\r<br />connection: close\r<br />\r<br />""" write flush<br />    contents<br />] with-client<br />print</pre> <p>For details, see the <a href="http://docs.factorcode.org/content/vocab-io.sockets.secure.html">io.sockets.secure</a> documentation, and my <a href="../2008/05/ssltls-support-added.html">blog post about SSL in Factor.</a>.</p> <p>Of course you'd never send HTTP requests directly using sockets; instead you'd use the <a href="http://docs.factorcode.org/content/vocab-http.client.html">http.client</a> vocabulary.</p> <h3>Network servers</h3> <p>Factor's <a href="http://docs.factorcode.org/content/vocab-io.servers.connection.html">io.servers.connection</a> vocabulary is so cool, that a couple of years back I made a <a href="http://factor.blip.tv/file/1316060/">screencast about it</a>. Nowadays the sample application developed in that screencast is in the <a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=extra/time-server/time-server.factor;hb=HEAD">extra/time-server</a>; the implementation is very concise and elegant.</p> <h3>Under the hood</h3> <p>All of this functionality is implemented in pure Factor code on top of our excellent <a href="http://docs.factorcode.org/content/article-alien.html">C library interface</a> and extensive bindings to POSIX and Win32 in the <a href="http://docs.factorcode.org/content/vocab-unix.html">unix</a> and <a href="http://docs.factorcode.org/content/vocab-windows.html">windows</a> vocabulary hierarchies, respectively.</p> <p>As much as possible, I/O is performed with non-blocking operations; synchronous reads and writes only suspend the current coroutine and switch to the next runnable one rather than hanging the entire VM. I recently <a href="04/switching-call-stacks-on-different.html">rewrote the coroutines implementation to use direct context switching rather than continuations</a>.</p> <p>Co-ordination and scheduling of coroutines is handled with a series of <a href="../2008/02/some-changes-to-threads.html">simple concurrency abstractions</a>.</p>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2010/09/overview-of-factors-io-library.html' itemprop='url'/>
<a class='timestamp-link' href='09/overview-of-factors-io-library.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2010-09-11T22:23:00-04:00'>10:23 PM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=3219921363760945818' onclick=''>
5 comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=3219921363760945818' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=3219921363760945818&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3219921363760945818&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3219921363760945818&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3219921363760945818&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3219921363760945818&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3219921363760945818&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Sunday, September 05, 2010</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='3585300047922066265' itemprop='postId'/>
<a name='3585300047922066265'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='09/making-factors-continuous-build-system.html'>Making Factor's continuous build system more robust</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-3585300047922066265' itemprop='description articleBody'>
<p>I've done some work on <a href="http://concatenative.org/wiki/view/Factor/Build%20farm">Factor's continuous build system</a> over the weekend to make it more robust in the face of failure, with improved error reporting and less manual intervention required to fix problems when they come up. The current build system is called "mason", because it is based on an earlier build system named "builder" that was written by Eduardo Cavazos. Every binary package you download from <a href="http://factorcode.org">factorcode.org</a> was built, tested and benchmarked by mason.</p> <h3>Checking for disk space</h3> <p>Every once in a while build machines run out of disk space. This is a condition that Git doesn't handle very gracefully; if a git pull fails half way through, it leaves the repository in an inconsistent state. Instead of failing during source code checkout or testing, mason now checks disk usage before attempting a build. If less than 1 Gb is free, it sends out a warning e-mail and takes no further action. Disk usage is also now part of every build report; for example, take a look at the <a href="http://builds.factorcode.org/report?os=macosx&cpu=x86.32">latest Mac OS X report</a>. Finally, mason does a better job of cleaning up after itself when builds fail, reducing the rate of disk waste overall.</p> <p>I must say the disk space check was very easy to implement using Doug Coleman's excellent cross-platform <code>file-system-info</code> library. Factor's I/O libraries are top-notch and everything works as expected across all of the platforms we run on.</p> <h3>Git repository corruption</h3> <p>Git is not 100% reliable, and sometimes repositories will end up in a funny state. One cause is when the disk fills up in the middle of a pull, but it seems to happen in other cases too. For example, just a few days ago, our 64-bit Windows build machine started failing builds with the following error: <pre>From git://factorcode.org/git/factor<br /> * branch            master     -> FETCH_HEAD<br />Updating d386ea7..eece1e3<br /><br />error: Entry 'basis/io/sockets/windows/windows.factor' not uptodate. Cannot merge.</pre> <p>Of course nobody actually edits files in the repository in question, its a clone of the official repo that gets updated every 5 minutes. Why git messed up here I have no clue, but instead of expecting software to be perfect, we can design for failure.</p> <p>If a pull fails with a merge error, or if the working copy somehow ends up containing modified or untracked files, mason deletes the repository and clones it again from scratch, instead of just falling over and requiring manual intervention.</p> <h3>Error e-mail throttling</h3> <p>Any time mason encounters an error, such as not being able to pull from the Factor Git repository, disk space exhaustion, or intermittent network failure, it sends out an e-mail to <a href="http://sourceforge.net/mailarchive/forum.php?forum_name=factor-builds">Factor-builds</a>. Since it checks for new code every 5 minutes, this can get very annoying if there is a problem with the machine and nobody is able to fix it immediately; the <a href="http://sourceforge.net/mailarchive/forum.php?forum_name=factor-builds">Factor-builds list</a> would get spammed with hundreds of duplicate messages. Now, mason uses a heuristic to limit the number of error e-mails sent out. If two errors are sent within twenty minutes of each other, no further errors are sent for another 6 hours.</p> <h3>More robust new code check</h3> <p>Previously mason would initiate a build if a git pull had pulled in patches. This was insufficient though, because if a build was killed half way through, for example due to power failure or machine reboot, it would not re-attempt a build when it came back up until new patches were pushed. Now mason compares the latest git revision with the last one that was actually built to completion (whether or not there were errors).</p> <h3>Build system dashboard</h3> <p>I've put together <a href="http://builds.factorcode.org/dashboard">a simple dashboard page</a> showing build system status. Sometimes VMs will crash (FreeBSD is particularly flaky when running under VirtualBox, for example) and we don't always notice that a VM is down until several days after, when no builds are being uploaded. Since mason now sends out heartbeats every 5 minutes to a central server, it was easy to put together a dashboard showing which machines have not sent any heartbeats for a while. These machines are likely to be down. The dashboard also allows a build to be forced even if no new code was pushed to the repository; this is useful to test things out after changing machine configuration.</p> <p>The dashboard nicely complements my earlier work on <a href="../2009/05/live-status-display-for-factors-build.html">live status display</a> for the build farm.</p> <h3>Conclusion</h3> <p>I think mason is one of the most advanced continuous integration systems among open source language implementations, nevermind the less mainstream ones such as Factor. And thanks to Factor's advanced libraries, it is only 1600 lines of code. Here is a selection of the functionality from Factor's standard library used by mason:</p> <ul> <li><a href="http://docs.factorcode.org/content/vocab-io.files.info.html">io.files.info</a> - checking disk usage</li> <li><a href="http://docs.factorcode.org/content/vocab-io.launcher.html">io.launcher</a> - running processes, such as git, make, zip, tar, ssh, and of course the actual Factor instance being tested</li> <li><a href="http://docs.factorcode.org/content/vocab-io.timeouts.html">io.timeouts</a> - timeouts on network operations and child processes are invaluable; Factor's consistent and widely-used timeout API makes it easy</li> <li><a href="http://docs.factorcode.org/content/vocab-http.client.html">http.client</a> - downloading boot images, making POST requests to builds.factorcode.org for the live status display feature</li> <li><a href="http://docs.factorcode.org/content/vocab-smtp.html">smtp</a> - sending build report e-mails</li> <li><a href="http://docs.factorcode.org/content/vocab-twitter.html">twitter</a> - Tweeting binary upload notifications</li><li><a href="http://docs.factorcode.org/content/vocab-oauth.html">oauth</a> - yes, Factor has a library to support the feared OAuth. Everyone complains about how hard OAuth is, but if you have easy to use libraries for HMAC, SHA1 and HTTP then it's no big deal at all.<li><a href="http://docs.factorcode.org/content/vocab-xml.syntax.html">xml.syntax</a> - constructing HTML-formatted build reports using XML literal syntax</li> </ul>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2010/09/making-factors-continuous-build-system.html' itemprop='url'/>
<a class='timestamp-link' href='09/making-factors-continuous-build-system.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2010-09-05T20:50:00-04:00'>8:50 PM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=3585300047922066265' onclick=''>
No comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=3585300047922066265' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=3585300047922066265&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3585300047922066265&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3585300047922066265&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3585300047922066265&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3585300047922066265&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3585300047922066265&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Friday, September 03, 2010</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='5808076548128250184' itemprop='postId'/>
<a name='5808076548128250184'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='09/two-things-every-unix-developer-should.html'>Two things every Unix developer should know</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-5808076548128250184' itemprop='description articleBody'>
<p>Unix programming can be tricky. There are many subtleties many developers are not aware of. In this post, I will describe just two of them... my favorite Unix quirks, if you will.</p> <h3>Interruptible system calls</h3> <p>On Unix, any system call which blocks can potentially fail with an errno of <code>EINTR</code>, which indicates that the caller must retry the system call. The <code>EINTR</code> error can be raised at any time for any reason, so essentially <i>every</i> I/O operation on a Unix system must be prepared to handle this error properly. Surprisingly to some, this includes the C standard library functions such as <code>fread()</code>, <code>fwrite()</code>, and so on.</p> <p>For example, if you are writing a network server, then most of the time, you want to ignore the <code>SIGPIPE</code> signal which is raised when the client closes its end of a socket. However, this ignored signal can cause some pending I/O in the server to return <code>EINTR</code>.</p> <p>A commonly-held belief is that setting the <code>SA_RESTART</code> flag with the <code>sigaction()</code> system call means that if that signal is delivered, system calls are restarted for you and <code>EINTR</code> doesn't need to be handled. Unfortunately this is not true. The reason is that certain signals are unmaskable. For instance, on Mac OS X, if your process is blocking reading on standard input, and the user suspends the program by sending it <code>SIGSTOP</code> (usually by pressing ^Z in the terminal), then upon resumption, your <code>read()</code> call will immediately fail with <code>EINTR</code>.</p> <p>Don't believe me? The Mac OS X <code>cat</code> program is not actually interrupt-safe, and has this bug. Run <code>cat</code> with no arguments in a terminal, press ^Z, then type <code>%1</code>, and you'll get an error from cat!</p> <pre>$ cat<br />^Z<br />[1]+  Stopped                 cat<br />$ %1<br />cat<br />cat: stdin: Interrupted system call<br />$</pre> <p>As far as I'm aware, Factor properly handles interruptible system calls, and has for a while now, thanks to <a href="http://code-factor.blogspot.com">Doug Coleman</a> explaining the issue to me 4 years ago. Not having to deal with crap like this (not to mention being able to write cross-platform code that runs on both Unix and Windows) is one of the advantages of using a high-level language like Factor or Java over C.</p> <h3>Subprocesses inherit semi-random things from the parent process</h3> <p>When you <code>fork()</code> your process, various things are copied from the parent to the child; environment variables, file descriptors, the ignored signal mask, and so on. Less obvious is the fact that <code>exec()</code> doesn't reset everything. If shared file descriptors such as stdin and stdout were set to non-blocking in the parent, the child will start with these descriptors non-blocking also, which will most likely break most programs. <a href="../2008/07/dont-set-shared-file-descriptors-to-non.html">I've blogged about this problem before</a>.</p> <p>A similar issue is that if you elect to ignore certain signals with the <code>SIG_IGN</code> action using <code>sigaction()</code>, then subprocesses will inherit this behavior. Again, this can break processes. Until yesterday, Factor would ignore <code>SIGPIPE</code> using this mechanism, and child processes spawned with the <code>io.launcher</code> vocabulary that expected to receive <code>SIGPIPE</code> would not work properly. There are various workarounds; you can reset the signal mask before the <code>exec()</code> call, or you can do what I did in Factor, and ignore the signal by giving it an empty signal handler instead of a <code>SIG_IGN</code> action.</p>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2010/09/two-things-every-unix-developer-should.html' itemprop='url'/>
<a class='timestamp-link' href='09/two-things-every-unix-developer-should.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2010-09-03T23:57:00-04:00'>11:57 PM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=5808076548128250184' onclick=''>
7 comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=5808076548128250184' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=5808076548128250184&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5808076548128250184&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5808076548128250184&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5808076548128250184&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5808076548128250184&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5808076548128250184&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Wednesday, July 28, 2010</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='3474927088354023566' itemprop='postId'/>
<a name='3474927088354023566'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='07/overhauling-factors-c-library-interface.html'>Overhauling Factor's C library interface</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-3474927088354023566' itemprop='description articleBody'>
<p>For the last while I've been working on an overhaul of Factor's <a href="http://docs.factorcode.org/content/article-alien.html">C library interface</a> and associated compiler infrastructure. The goals of the rewrite were three-fold:</p> <ul> <li>Improving performance</li> <li>Cleaning up some crusty old code that dates back to my earliest experiments with native code generation</li> <li>Laying the groundwork for future compiler improvements</li> </ul> <p>These changes were all behind-the-scenes; I did not introduce any new functionality or language changes, and I think Factor's FFI is already quite stable and feature-complete.</p> <h3>The previous FFI implementation</h3> <p>I started work on Factor's C library interface (FFI) almost immediately after I bootstrapped the native implementation off of JFactor. I began experimenting with an SDL-based UI early on and immediately decided I wanted to have a real FFI, instead of extending the VM with primitives which wrap C functions by hand.</p> <p>Over time, both the FFI and compiler have evolved in parallel, but there was little integration between them, other than the fact that both used the same <a href="../2009/09/survey-of-domain-specific-languages-in.html">assembler DSL</a> under the hood. The result is that FFI calls were generated in a somewhat inefficient way. Since the optimizing compiler had no knowledge of how they work, it would save all values to the data stack first. Then the FFI code generator would take over; it would pop the input parameters one by one, pass them to a per-type C function in the Factor VM which unboxed the value, then stored the value in the stack frame. Finally, the target C function would be invoked, then another C function in the VM would box the return value, and the return value would be pushed to the stack. The optimizing compiler would then take over, possibily generating code to pop the value from the stack.</p> <p>The redundant stack traffic was wasteful. In some cases, the optimizing compiler would generate code to box a value and push it to the stack, only to have the FFI then generate code to pop it and unbox it immediately after. To make matters worse, over time the optimizing compiler gained the ability to box and unbox values with open-coded assembly sequences, but the FFI would still make calls into the VM to do it.</p> <p>All in all, it was about time I rewrote the FFI, modernizing it and integrating it with the rest of the compiler in the process.</p> <h3>Factoring FFI calls into simpler instructions</h3> <p>Most <a href="http://github.com/slavapestov/factor/blob/master/basis/compiler/cfg/instructions/instructions.factor">low-level IR instructions</a> are very simple; FFI calls used to be the exception. Now I've split these up into smaller instructions. Parameters and return values are now read and written from the stack with the same <code>##peek</code> and <code>##replace</code> instructions that everything else uses, and boxing and unboxing parameters and return values is now done with the <a href="05/collection-of-small-compiler.html">representation selection pass</a>. A couple of oddball C types, such as <code>long long</code> on x86-32, still require VM calls to box and unbox, and I added new instructions for those.</p> <p>One slightly tricky thing that came up was that I had to re-engineer low-level IR to support instructions with multiple output values. This is required for C calls which return structs and <code>long long</code> types by value, since each word-size chunk of the return value is returned in its own register, and these chunks have to be re-assembled later. In the future, I will be able to use this support to add instructions such as the x86 division instruction, which computes <code>x / y</code> and <code>x mod y</code> simultaneously.</p> <p>I also had to change low-level IR to distinguish between instructions with side effects and those without. Previously, optimization passes would assume any instruction with an output value did not have side effects, and could be deleted if the output value was not used. This is no longer true for C calls; a C function might both have a side effect and return a value.</p> <h3>GC maps</h3> <p>Now that FFI calls no longer force the optimizer to sync all live values to the data and retain stacks, it can happen that SSA values are live across an FFI call. These values get spilled to the call stack by the register allocator. Spilling to the call stack is cheaper than spilling to the data and retain stacks, because floating point values and integers do not need to be boxed, and since the spilling is done later in the optimization process, optimizations can proceed across the call site instead of being stumped by pushes and pops on either side.</p> <p>However, since FFI calls can invoke callbacks, which in turn run Factor code, which can trigger a garbage collection, the garbage collector must be able to identify spill slots in call frames which contain tagged pointers.</p> <p>The technique I'm using is to record "GC maps". This idea comes from a paper titled <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.87.71&rep=rep1&type=pdf">Compiler Support for Garbage Collection in a Statically Typed Language</a> (Factor is dynamically typed, and the paper itself doesn't have anything specific to static typing in it, so I found the title a bit odd). The Java HotSpot VM uses the same technique. The basic idea is that for every call site, you record a bitmap indicating which spill slots contain tagged pointers. This information is then stored in a per-code-block map, where the keys are return addresses and the values are these bitmaps.</p> <p>In the future, I intend on using GC maps at call sites of Factor words as well, instead of spilling temporary values to the retain stack; then I can eliminate the retain stack altogether, freeing up a register. After this is done the data stack will only be used to pass parameters between words, and not to store temporaries within a word. This will allow more values to be unboxed in more situations, and it will improve accuracy of compiler analyses.</p> <p>In fact, getting GC maps worked out was my primary motivation for this FFI rewrite; the code cleanups and performance improvements were just gravy.</p> <h3>Callback support improvements</h3> <p>Another one of those things that only makes sense when you look at how Factor evolved is that the body of an FFI callback was compiled with the non-optimizing compiler, rather than the optimizing compiler. It used to be that only certain definitions could be optimized, because static stack effects were optional and there were many common idioms which did not have static stack effects. It has been more than a year since I undertook the engineering effort to make the compiler enforce <a href="../2009/03/better-static-safety-for-higher-order.html">static stack safety</a>, and the implementation of callbacks was the last vestigial remnant from the bad old days.</p> <p>This design made callbacks harder to debug than they should be; if you used up too many parameters, or forgot to push a return value, you'd be greeted with a runtime error instead of a compiler error. Now this has been fixed, and callbacks are fully compiled with the optimizing compiler.</p>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2010/07/overhauling-factors-c-library-interface.html' itemprop='url'/>
<a class='timestamp-link' href='07/overhauling-factors-c-library-interface.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2010-07-28T02:36:00-04:00'>2:36 AM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=3474927088354023566' onclick=''>
1 comment:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=3474927088354023566' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=3474927088354023566&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3474927088354023566&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3474927088354023566&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3474927088354023566&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3474927088354023566&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3474927088354023566&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Friday, July 02, 2010</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='4942585095767393047' itemprop='postId'/>
<a name='4942585095767393047'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='07/factor-talk-in-boston-july-26th.html'>Factor talk in Boston, July 26th</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-4942585095767393047' itemprop='description articleBody'>
I will be presenting Factor at the Boston Lisp Users' Group on July 26th, 2010. Details in <a href="http://fare.livejournal.com/157280.html">François-René Rideau's announcement</a>. I'm also going to be giving a quick talk at the <a href="http://emerginglangs.com/">Emerging Languages Camp</a> in Portland, July 22nd. Unfortunately registration for this camp is already full.
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2010/07/factor-talk-in-boston-july-26th.html' itemprop='url'/>
<a class='timestamp-link' href='07/factor-talk-in-boston-july-26th.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2010-07-02T00:53:00-04:00'>12:53 AM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=4942585095767393047' onclick=''>
1 comment:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=4942585095767393047' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=4942585095767393047&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=4942585095767393047&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=4942585095767393047&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=4942585095767393047&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=4942585095767393047&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=4942585095767393047&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Saturday, May 29, 2010</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='2177055053070299407' itemprop='postId'/>
<a name='2177055053070299407'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='05/comparing-factors-performance-against.html'>Comparing Factor's performance against V8, LuaJIT, SBCL, and CPython</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-2177055053070299407' itemprop='description articleBody'>
<p>Together with <a href="http://useless-factor.blogspot.com">Daniel Ehrenberg</a> and <a href="http://duriansoftware.com/joe">Joe Groff</a>, I'm writing a paper about Factor for <a href="http://www.wikicfp.com/cfp/servlet/event.showcfp?eventid=9566&copyownerid=3264">DLS2010</a>. We would appreciate feedback about the <a href="http://useless-factor.blogspot.com/2010/05/paper-for-dls-2010.html">draft version of the paper</a>. As part of the paper we include a performance comparison between Factor, V8, LuaJIT, SBCL, and Python. The performance comparison consists of some benchmarks from the <a href="http://shootout.alioth.debian.org/">The Computer Language Benchmarks Game</a>. I'm posting the results here first, in case there's something really stupid here.</p> <h3>Language implementations</h3> <p>Factor and V8 were built from their respective repositories. SBCL is version 1.0.38. LuaJIT is version 2.0.0beta4. CPython is version 3.1.2. All language implementations were built as 64-bit binaries and run on an 2.4 GHz Intel Core 2 Duo.</p> <h3>Benchmark implementations</h3> <p>Factor implementations of the benchmarks can be found in our source repository:</p> <ul> <li><a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=extra/benchmark/binary-trees/binary-trees.factor;hb=HEAD">binary-trees</a></li> <li><a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=extra/benchmark/fasta/fasta.factor;hb=HEAD">fasta</a></li> <li><a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=extra/benchmark/knucleotide/knucleotide.factor;hb=HEAD">knucleotide</a></li> <li><a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=extra/benchmark/nbody-simd/nbody-simd.factor;hb=HEAD">nbody</a></li> <li><a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=extra/benchmark/regex-dna/regex-dna.factor;hb=HEAD">regex-dna</a></li> <li><a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=extra/benchmark/reverse-complement/reverse-complement.factor;hb=HEAD">reverse-complement</a></li> <li><a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=extra/benchmark/spectral-norm/spectral-norm.factor;hb=HEAD">spectral-norm</a></li> </ul> <p>Implementations for the other languages can be found at the language benchmark game <a href="https://alioth.debian.org/scm/?group_id=30402">CVS repository</a>:</p><table border="3"> <tr><th></th><th>LuaJIT</th><th>SBCL</th><th>V8</th><th>CPython</th></tr> <tr><td>binary-trees          </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/binarytrees/binarytrees.lua-2.lua?view=markup&root=shootout">binarytrees.lua-2.lua</a></td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/binarytrees/binarytrees.sbcl?view=markup&root=shootout">binarytrees.sbcl</a>                 </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/binarytrees/binarytrees.javascript?view=markup&root=shootout">binarytrees.javascript</a>                          </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/binarytrees/binarytrees.python3-6.python3?view=markup&root=shootout">binarytrees.python3-6.python3</a>   </tr> <tr><td>fasta                 </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/fasta/fasta.lua?view=markup&root=shootout">fasta.lua</a>                              </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/fasta/fasta.sbcl?view=markup&root=shootout">fasta.sbcl</a>                                   </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/fasta/fasta.javascript-2.javascript?view=markup&root=shootout">fasta.javascript-2.javascript</a>                  </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/fasta/fasta.python3-2.python3?view=markup&root=shootout">fasta.python3-2.python3</a>                     </td></tr> <tr><td>knucleotide           </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/knucleotide/knucleotide.lua-2.lua?view=markup&root=shootout">knucleotide.lua-2.lua</a></td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/knucleotide/knucleotide.sbcl-3.sbcl?view=markup&root=shootout">knucleotide.sbcl-3.sbcl</a>   </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/knucleotide/knucleotide.javascript-3.javascript?view=markup&root=shootout">knucleotide.javascript-3.javascript</a></td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/knucleotide/knucleotide.python3-4.python3?view=markup&root=shootout">knucleotide.python3-4.python3</a>   </td></tr> <tr><td>nbody                 </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/nbody/nbody.lua-2.lua?view=markup&root=shootout">nbody.lua-2.lua</a>                  </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/nbody/nbody.sbcl?view=markup&root=shootout">nbody.sbcl</a>                                   </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/nbody/nbody.javascript?view=markup&root=shootout">nbody.javascript</a>                                            </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/nbody/nbody.python3-4.python3 ?view=markup&root=shootout">nbody.python3-4.python3</a>                    </td></tr> <tr><td>regex-dna             </td><td>                                                                                                                                                       </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/regexdna/regexdna.sbcl-3.sbcl?view=markup&root=shootout">regexdna.sbcl-3.sbcl</a>            </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/regexdna/regexdna.javascript?view=markup&root=shootout">regexdna.javascript</a>                                   </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/regexdna/regexdna.python3 ?view=markup&root=shootout">regexdna.python3</a>                               </td></tr> <tr><td>reverse-complement    </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/revcomp/revcomp.lua?view=markup&root=shootout">revcomp.lua</a>                        </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/revcomp/revcomp.sbcl?view=markup&root=shootout">revcomp.sbcl</a>                             </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/revcomp/revcomp.javascript-2.javascript?view=markup&root=shootout">revcomp.javascript-2.javascript</a>            </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/revcomp/revcomp.python3-4.python3 ?view=markup&root=shootout">revcomp.python3-4.python3</a>              </td></tr> <tr><td>spectral-norm         </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/spectralnorm/spectralnorm.lua?view=markup&root=shootout">spectralnorm.lua</a>         </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/spectralnorm/spectralnorm.sbcl-3.sbcl?view=markup&root=shootout">spectralnorm.sbcl-3.sbcl</a></td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/spectralnorm/spectralnorm.javascript?view=markup&root=shootout">spectralnorm.javascript</a>                       </td><td><a href="https://alioth.debian.org/scm/viewvc.php/shootout/bench/spectralnorm/spectralnorm.python3-5.python3?view=markup&root=shootout">spectralnorm.python3-5.python3</a></td></tr> </table><p>In order to make the reverse complement benchmark work with SBCL on Mac OS X, I had to apply this patch; I don't understand why:</p> <pre>--- bench/revcomp/revcomp.sbcl 9 Feb 2007 17:17:26 -0000 1.4<br />+++ bench/revcomp/revcomp.sbcl 29 May 2010 08:32:19 -0000<br />@@ -26,8 +26,7 @@<br /> <br /> (defun main ()<br />   (declare (optimize (speed 3) (safety 0)))<br />-  (with-open-file (in "/dev/stdin" :element-type +ub+)<br />-    (with-open-file (out "/dev/stdout" :element-type +ub+ :direction :output :if-exists :append)<br />+  (let ((in sb-sys:*stdin*) (out sb-sys:*stdout*))<br />       (let ((i-buf (make-array +buffer-size+ :element-type +ub+))<br />             (o-buf (make-array +buffer-size+ :element-type +ub+))<br />             (chunks nil))<br />@@ -72,4 +71,4 @@<br />                         (setf start 0)<br />                         (go read-chunk))))<br />            end-of-input<br />-             (flush-chunks)))))))<br />+             (flush-chunks))))))<br /></pre> <h3>Running the benchmarks</h3> <p>I used Factor's deploy tool to generate minimal images for the Factor benchmarks, and then ran them from the command line:</P> <pre>./factor -e='USE: tools.deploy "benchmark.nbody-simd" deploy'<br />time benchmark.nbody-simd.app/Contents/MacOS/benchmark.nbody-simd</pre> <p>For the scripting language implementations (LuaJIT and V8) I ran the scripts from the command line:</p> <pre>time ./d8 ~/perf/shootout/bench/nbody/nbody.javascript -- 1000000<br />time ./src/luajit ~/perf/shootout/bench/nbody/nbody.lua-2.lua 1000000</pre> <p>For SBCL, I did what the shootout does, and compiled each file into a new core:</p> <pre>ln -s ~/perf/shootout/bench/nbody/nbody.sbcl .<br /><br />cat > nbody.sbcl_compile &lt;&lt;EOF<br />(proclaim '(optimize (speed 3) (safety 0) (debug 0) (compilation-speed 0) (space 0)))<br />(handler-bind ((sb-ext:defconstant-uneql (lambda (c) (abort c))))<br />  (load (compile-file "nbody.sbcl" )))<br />(save-lisp-and-die "nbody.core" :purify t)<br />EOF<br /><br />sbcl --userinit /dev/null --load nbody.sbcl_compile<br /><br />cat > nbody.sbcl_run &lt;&lt;EOF<br />(proclaim '(optimize (speed 3) (safety 0) (debug 0) (compilation-speed 0) (space 0)))<br />(main) (quit)<br />EOF<br /><br />time sbcl --dynamic-space-size 500 --noinform --core nbody.core --userinit /dev/null --load nbody.sbcl_run 1000000</pre><p>For CPython, I precompiled each script into bytecode first:</p><pre>python3.1 -OO -c "from py_compile import compile; compile('nbody.python3-4.py')"</pre> <h3>Benchmark results</h3><p>All running times are wall clock time from the Unix <code>time</code> command. I ran each benchmark 5 times and used the best result.</p><table border='3'> <tr><td>                  </td><th>Factor</th><th>LuaJIT</th><th>SBCL  </th><th>V8     </th><th>CPython   </th></tr> <tr><td>fasta             </td><td>2.597s</td><td>1.689s</td><td>2.105s</td><td>3.948s </td><td>35.234s  </td></tr> <tr><td>reverse-complement</td><td>2.377s</td><td>1.764s</td><td>2.955s</td><td>3.884s </td><td>1.669s   </td></tr> <tr><td>nbody             </td><td>0.393s</td><td>0.604s</td><td>0.402s</td><td>4.569s </td><td>37.086s  </td></tr> <tr><td>binary-trees      </td><td>1.764s</td><td>6.295s</td><td>1.349s</td><td>2.119s </td><td>19.886s  </td></tr> <tr><td>spectral-norm     </td><td>1.377s</td><td>1.358s</td><td>2.229s</td><td>12.227s</td><td>1m44.675s</td></tr> <tr><td>regex-dna         </td><td>0.990s</td><td>N/A   </td><td>0.973s</td><td>0.166s </td><td>0.874s   </td></tr> <tr><td>knucleotide       </td><td>1.820s</td><td>0.573s</td><td>0.766s</td><td>1.876s </td><td>1.805s   </td></tr> </table><br /><h3>Benchmark analysis</h3> <p>Some notes on the results:</p> <ul> <li>There is no Lua implementation of the regex-dna benchmark.</li><li>Some of the SBCL benchmark implementations can make use of multiple cores if SBCL is compiled with thread support. However, by default, thread support seems to be disabled on Mac OS X. None of the other language implementations being tested have native thread support, so this is a single-core performance test.</li><li>Factor's string manipulation still needs work. The fasta, knucleotide and reverse-complement benchmarks are not as fast as they should be.</li> <li>The binary-trees benchmark is a measure of how fast objects can be allocated, and how fast the garbage collector can reclaim dead objects. LuaJIT loses big here, perhaps because it lacks generational garbage collection, and because Lua's tables are an inefficient object representation.</li> <li>The regex-dna benchmark is a measure of how efficient the regular expression implementation is in the language. V8 wins here, because it uses Google's heavily-optimized Irregexp library.</li> <li>Factor beats the other implementations on the nbody benchmark because it is able to make use of SIMD.</li> <li>For some reason SBCL is slower than the others on spectral-norm. It should be generating the same code.</li> <li>The benchmarks exercise insufficiently-many language features. Any benchmark that uses native-sized integers (for example, an implementation of the SHA1 algorithm) would shine on SBCL and suffer on all the others. Similarly, any benchmark that requires packed binary data support would shine on Factor and suffer on all the others. However, the benchmarks in the shootout mostly consist of scalar floating point code, and text manipulation only.</li></ul><h3>Conclusions</h3><p>Factor's performance is coming along nicely. I'd like to submit Factor to the computer language shootout soon. Before doing that, we need a Debian package, and the deploy tool needs to be easier to use from the command line.</p>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2010/05/comparing-factors-performance-against.html' itemprop='url'/>
<a class='timestamp-link' href='05/comparing-factors-performance-against.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2010-05-29T04:46:00-04:00'>4:46 AM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=2177055053070299407' onclick=''>
16 comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=2177055053070299407' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=2177055053070299407&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=2177055053070299407&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=2177055053070299407&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=2177055053070299407&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=2177055053070299407&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=2177055053070299407&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Monday, May 10, 2010</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='5043552812433752925' itemprop='postId'/>
<a name='5043552812433752925'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='05/collection-of-small-compiler.html'>A collection of small compiler improvements</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-5043552812433752925' itemprop='description articleBody'>
<p>One of the big optimizations I'm planning on implementing in Factor is support for computations on machine-word-sized integers. The motivation is as follows. While code that operates on small integers (fixnums) does not currently allocate memory for intermediate values, and as a result can compile very efficiently if type checks are eliminated, sometimes fixnum precision is not quite enough. Using bignums in algorithms such as SHA1 that require 32-bit or 64-bit arithmetic incurs a big performance hit over writing the code in a <a href="http://bitbucket.org/kssreeram/clay">systems language</a>. My plan is to have the compiler support machine integers as an intermediate step between fixnums and bignums. Machine integers would be boxed and unboxed at call boundaries, but tight loops operating on them will run in registers.</p> <p>While I haven't yet implemented the above optimization, I've laid the groundwork and made it possible to represent operations on untagged integers at the level of compiler IR at least. While unboxed floats do not cause any complications for the GC, unboxed integers do, because they share a register file with tagged pointers. To make Factor's precise GC work, the compiler can now distinguish registers containing tagged pointers from those containing arbitrary integer data, by breaking down the register class of integer registers into two "representations", tagged and untagged.</p> <p>Since the above reworking touched many different parts of the compiler, I also took the time to implement some minor optimizations and clean up some older code. These improvements will be the topic of this post.</p> <p>To understand this post better, you should probably skim the list of low-level IR instructions defined in <a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=basis/compiler/cfg/instructions/instructions.factor;hb=HEAD">compiler.cfg.instructions</a> first. Also, feel free to post comments here or e-mail me questions about the design of the Factor compiler.</p> <h3>Improvements to value numbering</h3> <p>In the x86 architecture, almost any instruction can take a memory operand, and memory operands take the form <code>(base + displacement * scale + offset)</code>, where <code>base</code> and <code>displacement</code> are registers, <code>offset</code> is a 32-bit signed integer, and <code>scale</code> is 1, 2, 4 or 8. While using a complex addressing mode is not any faster than writing out the arithmetic by hand with a temporary register used to store the final address, it can reduce register pressure and code size.</p> <p>The compiler now makes better use of complex addressing modes. Prior to optimization, the low level IR builder lowers specialized array access to the <code>##load-memory-imm</code> and <code>##store-memory-imm</code> instructions. For example, consider the following code:</p> <pre>USING: alien.c-types specialized-arrays ;<br />SPECIALIZED-ARRAY: float<br /><br />: make-data ( -- seq ) 10 iota [ 3.5 + sqrt ] float-array{ } map-as ;</pre> The inner loop consists of the following low level IR: <pre>##integer>float 23 14<br />##sqrt 24 23<br />##load-integer 25 2<br />##slot-imm 26 15 2 7<br />##load-integer 27 4<br />##mul 28 14 27<br />##tagged>integer 29 26<br />##add-imm 30 29 7<br />##add 31 30 28<br />##store-memory-imm 24 31 0 float-rep f<br />##load-integer 32 1<br />##add 33 14 32</pre> <p>The <code>##mul</code>, <code>##add-imm</code> and <code>##add</code> instructions compute the address input to <code>##store-memory-imm</code>. After value numbering, these three instructions have been fused with <code>##store-memory-imm</code> to form <code>##store-memory</code>:</p> <pre>##integer>float 62 57<br />##sqrt 63 62<br />##slot-imm 65 48 2 7<br />##tagged>integer 68 65<br />##store-memory 63 68 57 2 7 float-rep f<br />##add-imm 72 57 1</pre> <h3>Optimistic copy propagation</h3> <p>While the low-level optimizer's value numbering and alias analysis passes only operate on individual basic blocks (<i>local</i> optimizations), the copy propagation pass is <i>global</i>, meaning it takes the entire procedure being compiled into account.</p> <p>Eventually I will merge the local alias analysis and value numbering passes with the copy propagation pass to get an optimization known as "global value numbering with redundant load elimination". One step along this road is a rewrite that makes the copy propagation pass <i>optimistic</i>, in the following sense.</p> <p>Copy propagation concerns itself with eliminating <code>##copy</code> instructions, which correspond to assignments from one SSA value to another (new) value:</p> <pre>y = x</pre> <p>When such an instruction is processed, all usages of the value <code>y</code> can be replaced with the value <code>x</code>, in every basic block, and the definition of <code>y</code> deleted.</p> <p>A simple extension of the above treats a <code>##phi</code> instruction where all inputs are equal the same as a copy. This optimizes cases such as:</p> <pre> a = ...<br />if(...)<br />{<br />    b = a<br />}<br />c = phi(b,a)</pre> <p>The case of <code>##phi</code> instructions where one of the inputs is carried by a back edge in the control flow graph (ie, a loop) is where the optimistic assumption comes in. Consider the following code, where the definition of <code>x''</code> is carried by a back edge:</p> <pre>x' = 0<br /><br />while(...)<br />{<br />    x = phi(x',x'')<br />    x'' = ...<br />}</pre> <p>Optimistic copy propagation is able to eliminate the phi node entirely. Switching from pessimistic to optimistic copy propagation eliminated about 10% of copy instructions. While this is not a great amount, it did reduce spilling in a few subroutines I looked at, and there is no increase in code complexity from this new approach.</p> <h3>Representation selection improvements</h3> <p>The low-level IR now includes three new instructions, <code>##load-double</code>, <code>##load-float</code> and <code>##load-vector</code>. These are inteded for loading unboxed floating point values and SIMD vectors into vector registers without using an integer register to temporarily hold a pointer to the boxed value.</p> <p>Uses of these instructions are inserted by the representation selection pass. If the destination of a <code>##load-reference</code> is used in an unboxed representation, then instead of inserting a memory load following the <code>##load-reference</code>, the instruction is replaced with one of the new variants.</p> <p>Loads from constant addresses directly into floating point and vector registers are only possible on x86, and not PowerPC, so the optimization is not performed on the latter architecture. On x86-32, an immediate displacement can encode any 32-bit address. On x86-64, loading from an absolute 64-bit address requires an integer register, however instruction pointer-relative addressing is supported with a 32-bit displacement. To make use of this capability, the compiler now supports a new "binary literal area" for unboxed data that compiled code can reference. The unboxed data is placed immediately following a word's machine code, allowing RIP-relative addressing to be used on x86-64.</p> <p>This optimization, together with value numbering improvements, helps reduce pressure on integer registers in floating point loops.</p> <h3>Register allocator improvements</h3> <p>Once representation selection has run, each SSA value has an associated representation and register class. Each representation always belongs to one specific register class; a register class is a finite set of registers from which the register allocator is allowed to choose a register for this type of value.</p> <p>Before register allocation, the SSA destruction pass transforms <code>##phi</code> instructions into <code>##copy</code>s, and then subsequently performs live range coalescing to eliminate as many of the copies as possible.</p> <p>Coalescing two SSA values from different register classes does not make sense; the compiler will not be able to generate valid machine code if a single SSA value is used as both a float and an integer, since on most CPUs the integer and floating point register files are distinct.</p> <p>However, coalescing values with different representations, but the same register class, is okay. Consider the case where a double-precision float is computed, and then converted into a single precision float, and subsequently stored into memory. If the double-precision value is not used after the conversion, then the same register that held the input value can be reused to store the result of the single-precision conversion.</p> <p>Previously this pass only coalesced values with identical representations; now I've generalized it to coalescing values with the same register class but possibly different representations. This reduces register pressure and spilling.</p> <p>The tricky part about making it work is that the register allocator needs to know the value's representation, not just its register class, for generating correct spills and reloads. For example, a spilled value with register class <code>float-regs</code> can use anywhere from 4 to 16 bytes in the stack frame, depending on the specific representation: single precision float, double precision float, or SIMD vector. Clearly, if coalescing simply lost this fine-grained representation information and only retained register classes, the register allocator would not have enough information to generate valid code.</p> <p>The solution is to have live range coalescing compute the equivalence classes of SSA values without actually renaming any usages to point to the canonical representative. The renaming map is made available to the register allocator. Most places in the register allocator where instruction operands are examined make use of the renaming map.</p> <p>Until the splitting phase, these equivalence classes are in one-to-one correspondence with live intervals, and each live interval has a single machine register and spill slot. However, when spill and reload decisions are made, the register allocator uses the original SSA values to look up representations.</p> <p>If Factor's compiler did not use SSA form at all, there would still be a copy coalescing pass, and the register allocator could also support coalescing values with different representations, by first performing a dataflow analysis known as <a href="http://en.wikipedia.org/wiki/Reaching_definition">reaching definitions</a>. This would propagate representation information to use sites.</p> <p>Retaining SSA structure all the way until register allocation gives you the results of this reaching definitions analysis "for free". In both the SSA and non-SSA case, you still don't want definitions with multiple different representations reaching the same call site. The SSA equivalent of this would be a phi instruction whose inputs had different representations. The compiler ensures this doesn't happen by first splitting up the set of SSA values into strongly-connected components (SCCs) whose edges are phi nodes. The same representation is then assigned to each member of every SCC; if an agreeable representation is not found then it falls back on boxing and tagging all members.</p> <p>Notice that while both representation selection and SSA destruction group values into equivalence classes, the groupings do not correspond to each other and neither one is a refinement of the other. Not all copies resulting from phi nodes get coalesced away, so a single SCC may intersect multiple coalescing classes. This can happen if the first input to a phi node is live at the definition point of the second: <pre>b = ...<br /><br />if(...)<br />{<br />    a = ...<br />    foo(b)<br />}<br />/* 'c' can be coalesced with 'a' or 'b' -- but not both.<br />All three values belong to the same SCC and must have the same<br />representation */<br />c = phi(a,b)</pre> On the other hand, two values from different SCCs might also get coalesced together:</p> <pre>a = some-double-float<br />/* if 'a' is not live after this instruction, then 'a' and 'b'<br />can share a register. They belong to different SCCs and have<br />different representations */<br />b = double-to-single-precision-float(a)</pre> <h3>Compiler code cleanups</h3> <p>In addition to just adding new optimizations I've also simplified and refactored the internals of some of the passes I worked on.</p> <p>One big change is that the "machine representation" used at the very end of the compilation process is gone. Previously, after register allocation had run, the control flow graph would be flattened into a list of instructions with CFG edges replaced by labels and jumps. The code generator would then iterate over this flat representation and emit machine code for each virtual instruction. However since no optimization passes ran on the flat representation, it was generated and then immediately consumed. Combining the linearization pass with the code generation pass let me eliminate about a dozen IR instructions that were specific to the flat representation (anything dealing with labels and jumps to labels). It also sped up compilation time slightly.</p> <p>Value numbering's common subexpression elimination now uses a simpler and more efficient scheme for hashed lookup of expressions. New algebraic simplifications are also easier to add now, because the def-use graph is easier to traverse.</p> <p>Some instructions which could be expressed in terms of others were removed, namely the <code>##string-nth</code> and <code>##set-string-nth-fast</code> instructions. Reading and writing characters from strings can be done by combining simpler memory operations already present in the IR.</p> <p>A number of instructions were combined. All of the instructions for reading from memory in different formats, <code>##alien-unsigned-1</code>, <code>##alien-signed-4</code>, <code>##alien-double</code>, have been merged into a single <code>##load-memory</code> instruction which has a constant operands storing the C type and representation of the data being loaded. Similarly, <code>##set-alien-signed-8</code>, etc have all been merged into <code>##store-memory</code>. This restructuring allows optimization passes to more easily treat all memory accesses in a uniform way.</p> <h3>A bug fix for alias analysis</h3> <p>While working on the above I found an interesting bug in alias analysis. It would incorrectly eliminate loads and stores in certain cases. The optimizer assumed that a pointer to a freshly-allocated object could never alias a pointer read from the heap. However the problem of course is that such a pointer could be stored in another object, and then read back in.<p> <p>Here is a Factor example that demonstrates the problem. First, a couple of tuple definitions; the type declarations and initial value are important further on.</p> <pre>USING: typed locals ;<br /><br />TUPLE: inner { value initial: 5 } ;<br />TUPLE: outer { value inner } ;</pre> <p>Now, a very contrieved word which takes two instances of <code>outer</code>,<br />mutates one, and reads a value out of the other:</p> <pre>TYPED: testcase ( x: outer y: outer -- )<br />    inner new :> z               ! Create a new instance of 'inner'<br />    z x value&lt;&lt;                  ! Store 'z' in 'x'<br />    y value>> :> new-z           ! Load 'new-z' from 'y'<br />    10 new-z value&lt;&lt;             ! Store a value inside 'new-z'  <br />    z value>>                    ! Read a value out of 'z'<br />    ;</pre> <p>Note that the initial value of the <code>value</code> slot in the <code>inner</code> tuple is 5, so <code>inner new</code> creates a new instance holding the value 5. In the case where <code>x</code> and <code>y</code> point at the same object, <code>new-z</code> and <code>z</code> will point to the same object, and the newly-allocated object's value is set to 10. However, the compiler did not realize this, and erronously constant-folded <code>z value>></code> down to 5!</p> <p>This bug never came up in actual code; the facepalm moment came while I was doing some code refactoring and noticed that the above case was not being handled.</p> <h3>Instruction scheduling to reduce register pressure</h3> <p>I'm not the only one who's been busy improving the Factor compiler. One of the <a href="http://useless-factor.blogspot.com">co-inventors of Factor</a> has cooked up an <a href="http://useless-factor.blogspot.com/2010/02/instruction-scheduling-for-register.html">instruction scheduler</a> and <a href="http://useless-factor.blogspot.com/2010/04/guarded-method-inlining-for-factor.html">improved method inlining</a>. The scheduler has been merged, and the it looks like the method inlining improvements should be ready in a few days.</p> <h3>Some benchmarks</h3> <p>Here is a comparison between the April 17th build of Factor with the latest code from the GIT repository. I ran a few of the <a href="http://shootout.alioth.debian.org/">language shootout benchmarks</a> on a 2.4 GHz MacBook Pro. Factor was built in 32-bit mode, because the new optimizations are most effective on the register-starved x86.</p> <table> <tr><th>Benchmark</th><th>Before (ms)</th><th>After (ms)</th><tr><td>nbody-simd</td><td>415</td><td>349</td></tr> <tr><td>fasta</td><td>2667</td><td>2485</td></tr> <tr><td>knucleotide</td><td>182</td><td>177</td></tr> <tr><td>regex-dna</td><td>109</td><td>86</td></tr> <tr><td>spectral-norm</td><td>1641</td><td>1347</td></tr> </table>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2010/05/collection-of-small-compiler.html' itemprop='url'/>
<a class='timestamp-link' href='05/collection-of-small-compiler.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2010-05-10T18:23:00-04:00'>6:23 PM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=5043552812433752925' onclick=''>
2 comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=5043552812433752925' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=5043552812433752925&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5043552812433752925&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5043552812433752925&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5043552812433752925&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5043552812433752925&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5043552812433752925&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Friday, April 16, 2010</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='5740682451340469020' itemprop='postId'/>
<a name='5740682451340469020'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='04/factor-093-now-available.html'>Factor 0.93 now available</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-5740682451340469020' itemprop='description articleBody'>
<p>After two months of development, Factor 0.93 is now available for download from the <a href="http://factorcode.org">Factor website</a>. A big thanks to all the contributors, testers and users. This release would not be possible without your help. A summary of the most important changes follows:</p><h3>Incompatible changes:</h3> <ul> <li>Factor no longer supports NetBSD, due to limitations in that operating system. (Slava Pestov)</li> <li><a href="http://docs.factorcode.org/content/article-sets.html">sets</a>, <a href="http://docs.factorcode.org/content/article-hash-sets.html">hash-sets</a>, <a href="http://docs.factorcode.org/content/article-bit-sets.html">bit-sets</a>: these vocabularies have been redesigned around a new <a href="http://useless-factor.blogspot.com/2010/03/protocol-for-sets.html">generic protocol for sets</a> (Daniel Ehrenberg) <li>Strings can no longer be used to refer to C types in FFI calls; you must use C type words instead. Also, ABI specifiers are now symbols rather than strings. So for example, the following code will no longer work: <pre>: my-callback ( -- callback ) "int" { "int" "int" } "cdecl" [ + ] alien-callback ;</pre> you must now write: <pre>: my-callback ( -- callback ) int { int int } cdecl [ + ] alien-callback ;</pre> (Joe Groff)</li> <li>The behavior of string types has changed. The <code>char*</code> C type is now just a bare pointer; to get the automatic conversion to and from Factor strings, use the <code>c-string</code> type. See <a href="http://docs.factorcode.org/content/article-c-strings.html">the documentation</a> for details. (Joe Groff)</li> <li>FFI function return values which are pointers to structs are now boxed in a struct class, instead of returning a bare alien. This means that many <code>memory>struct</code> calls can be removed. If the return value is actually a pointer to an array of structs, use specialized arrays as before. (Joe Groff)</li> <li>C-ENUM: now takes an additional parameter which is either the name of a new C type to define, or <code>f</code>. This type is aliased to <code>int</code>. (Erik Charlebois)</li> <li><a href="http://duriansoftware.com/joe/Improving-Factor's-error-messages.html">The stack checker now supports row polymorphic stack effects</a>, for improved error checking. See <a href="http://docs.factorcode.org/content/article-effects-variables.html">the documentation</a> for details. (Joe Groff)</li> </ul> <h3>New features:</h3> <ul> <li>Co-operative threads now use efficient context-switching primitives instead of copying stacks with continuations (Slava Pestov)</li> <li>Added <a href="http://docs.factorcode.org/content/word-final%2Csyntax.html">final class declarations</a>, to prohibit classes from being subclassed. This enables <a href="02/final-classes-and-platform-specific.html">a few compiler optimizations</a> (Slava Pestov)</li> <li>Added <a href="02/final-classes-and-platform-specific.html">platform support metadata</a> for vocabularies. Vocabulary directories can now contain a <code>platforms.txt</code> file listing operating system names which they can be loaded under. (Slava Pestov)</li> <li>The deploy tool can now deploy <a href="http://docs.factorcode.org/content/article-loading-libs.html">native libraries</a> and <a href="http://docs.factorcode.org/content/article-deploy-resources.html">resource files</a>, and supports <a href="http://docs.factorcode.org/content/article-vocabs.icons.html">custom icons</a>. (Joe Groff)</li> <li><a href="http://useless-factor.blogspot.com/2010/03/expressing-joint-behavior-of-modules.html">Joint behavior of vocabularies</a> - the new <a href="http://docs.factorcode.org/content/word-require-when%2Cvocabs.loader.html">require-when</a> word can be used to express that a vocabulary should be loaded if two existing vocabularies have been loaded (Daniel Ehrenberg)</li> <li>Callstack overflow is now caught and reported on all platforms except for Windows and OpenBSD. (Slava Pestov)</li> <li>The prettyprinter now has some limits set by default. This prevents out of memory errors when printing large structures, such as the global namespace. Use the <a href="http://docs.factorcode.org/content/word-without-limits%2Cprettyprint.config.html">without-limits</a> combinator to disable limits. (Slava Pestov)</li> <li>Added <a href="http://docs.factorcode.org/content/word-fastcall%2Calien.html">fastcall</a> and <a href="http://docs.factorcode.org/content/word-thiscall%2Calien.html">thiscall</a> ABIs on x86-32 (Joe Groff)</li> <li>The build farm's version release process is now more automated (Slava Pestov)</li> </ul> Improved libraries: <ul> <li><a href="http://docs.factorcode.org/content/vocab-delegate.html">delegate</a>: add <a href="http://docs.factorcode.org/content/word-BROADCAST__colon__%2Cdelegate.html">BROADCAST:</a> syntax, which delegates a generic word with no outputs to an array of multiple delegates. (Joe Groff)</li> <li><a href="http://docs.factorcode.org/content/vocab-game.input.html">game.input</a>: X11 support. (William Schlieper)</li> <li><a href="http://docs.factorcode.org/content/vocab-gpu.html">gpu</a>: geometry shader support. (Joe Groff)</li> <li><a href="http://docs.factorcode.org/content/vocab-opengl.gl.html">opengl</a>: OpenGL 4.0 support. (Joe Groff)</li> </ul> New libraries: <ul> <li><a href="http://docs.factorcode.org/content/vocab-bit.ly.html">bit.ly</a>: Factor interface to the <a href="http://bit.ly">bit.ly</a> URL shortening service. (Slava Pestov)</li> <li><a href="http://docs.factorcode.org/content/vocab-chipmunk.html">chipmunk</a>: binding for Chipmunk 2D physics library. (Erik Charlebois)</li> <li><a href="http://docs.factorcode.org/content/vocab-cuda.html">cuda</a>: binding to NVidia's CUDA API for GPU computing. (Doug Coleman, Joe Groff)</li> <li><a href="http://docs.factorcode.org/content/vocab-cursors.html">cursors</a>: experimental library for iterating over collections, inspired by STL iterators. (Joe Groff)</li> <li><a href="http://docs.factorcode.org/content/vocab-elf.html">elf</a>: parsing ELF binaries. The <a href="http://docs.factorcode.org/content/vocab-elf.nm.html">elf.nm</a> vocabulary is a demo which prints all symbols in an ELF binary. (Erik Charlebois)</li> <li><a href="http://docs.factorcode.org/content/vocab-images.pbm.html">images.pbm</a>, <a href="http://docs.factorcode.org/content/vocab-images.pgm.html">images.pgm</a>, <a href="http://docs.factorcode.org/content/vocab-ppm.html">images.ppm</a>: libraries for loading PBM, PGM and PPM images (Erik Charlebois)</li> <li><a href="http://docs.factorcode.org/content/vocab-macho.html">macho</a>: parsing Mach-O binaries. (Erik Charlebois)</li> <li><a href="http://docs.factorcode.org/content/vocab-opencl.html">opencl</a>: binding for the OpenCL standard interface for GPU computing. (Erik Charlebois)</li> <li><a href="http://docs.factorcode.org/content/vocab-path-finding.html">path-finding</a>: implementation of A* and BFS path finding algorithms. (Samuel Tardieu)</li> <li><a href="http://docs.factorcode.org/content/vocab-windows.ddk.html">windows.ddk</a>: binding for Windows hardware abstraction layer. (Erik Charlebois)</li> </ul>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2010/04/factor-093-now-available.html' itemprop='url'/>
<a class='timestamp-link' href='04/factor-093-now-available.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2010-04-16T18:24:00-04:00'>6:24 PM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=5740682451340469020' onclick=''>
No comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=5740682451340469020' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=5740682451340469020&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5740682451340469020&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5740682451340469020&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5740682451340469020&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5740682451340469020&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5740682451340469020&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Thursday, April 08, 2010</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='7929495712930034237' itemprop='postId'/>
<a name='7929495712930034237'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='04/frame-based-structured-exception.html'>Frame-based structured exception handling on Windows x86-64</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-7929495712930034237' itemprop='description articleBody'>
<p>Factor used to use vectored exception handlers, registered with <a href="http://msdn.microsoft.com/en-us/library/ms680588(VS.85).aspx">AddVectoredExceptionHandler</a>, however vectored handlers are somewhat problematic. A vectored handler is always called prior to any frame-based handlers, so Factor could end up reporting bogus exceptions if the FFI is used to call a library that uses SEH internally. This prompted me to switch to frame-based exception handlers. Unfortunately, these are considerably more complex to use, and the implementation differs between 32-bit and 64-bit Windows.</p> <p>I briefly discussed frame-based SEH on 32-bit Windows in my <a href="04/switching-call-stacks-on-different.html">previous post</a>. During the switch to 64 bits, Microsoft got rid of the old frame-based SEH implementation and introduced a new, lower-overhead approach. Instead of pushing and popping exception handlers onto a linked list at runtime, the system maintains a set of function tables, where each function table stores exception handling and stack frame unwinding information.</p> <p>Normally, the 64-bit Windows function tables are written into the executable by the native compiler. However, language implementations which generate code at runtime need to be able to define new function tables dynamically. This is done with the <a href="http://msdn.microsoft.com/en-us/library/ms680588(VS.85).aspx">RtlAddFunctionTable()</a> function.</p> <p>It took me a while to figure out the correct way to call this function. I found the <a href="http://hg.openjdk.java.net/jdk7/jsn/hotspot/file/d9bc824aa078/src/os_cpu/windows_x86/vm/os_windows_x86.cpp">os_windows_x86.cpp</a> source file from Sun's HotSpot Java implementation was very helpful, and I based my code on the <code>register_code_area()</code> function from this file.</p> <p>Factor and HotSpot only use function tables in a very simple manner, to set up an exception handler. Function tables can also be used to define stack unwinding behavior; this allows debuggers to generate backtraces, and so on. Doing that is more complicated and I don't understand how it works, so I won't attempt to discuss it here.</p> <p>The <code>RtlAddFunctionTable()</code> function takes an array of <code>RUNTIME_FUNCTION</code> structures and a base address. For some unknown reason, all pointers in the structures passed to this function are 32-bit integers relative to the base address.</p> <p>For a runtime compiler that does not need to perform unwinding, it suffices to map the entire code heap to one <code>RUNTIME_FUNCTION</code>. A <code>RUNTIME_FUNCTION</code> has three fields:</p> <ul> <li><code>BeginAddress</code> - the start of the function</li> <li><code>EndAddress</code> - the end of the function</li> <li><code>UnwindData</code> - a pointer to unwind data</li> </ul> <p>All pointers are relative to the base address passed into <code>RtlAddFunctionTable()</code>. The unwind data can take various forms. For the simple case of no unwind codes and an exception handler, the following structure is used:</p> <pre>struct UNWIND_INFO {<br />    UBYTE Version:3;<br />    UBYTE Flags:5;<br />    UBYTE SizeOfProlog;<br />    UBYTE CountOfCodes;<br />    UBYTE FrameRegister:4;<br />    UBYTE FrameOffset:4;<br />    ULONG ExceptionHandler;<br />    ULONG ExceptionData[1];<br />};</pre> <p>The <code>Version</code> and <code>Flags</code> fields should be set to 1, the <code>ExceptionHandler</code> field set to a function pointer, and the rest of the fields set to 0. The exception handler pointer must be within relative to the base address, and it must also be within the memory range specified by the <code>BeginAddress</code> and <code>EndAddress</code> fields of the <code>RUNTIME_FUNCTION</code> structure. The exception handler has the same function signature as in the 32-bit SEH case:</p> <pre>LONG exception_handler(PEXCEPTION_RECORD e, void *frame, PCONTEXT c, void *dispatch)</pre> <p>In both Factor and HotSpot, the exception handler is a C function, however the <code>RtlAddFunctionTable()</code> API requires that it be within the bounds of the runtime code heap. To get around the restriction, both VMs allocate a small trampoline in the code heap which simply jumps to the exception handler, and use a pointer to the trampoline instead. Similarly, because the "pointers" in these structures are actually 32-bit integers, it helps to allocate the <code>RUNTIME_FUNCTION</code> and <code>UNWIND_INFO</code> in the code heap as well, to ensure that everything is within the same 4Gb memory range.</p><p>The above explanation probably didn't make much sense, so I invite you to check out the source code instead: <a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=vm/os-windows-nt-x86.64.cpp;hb=HEAD">os-windows-nt-x86.64.cpp</a>.</p>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2010/04/frame-based-structured-exception.html' itemprop='url'/>
<a class='timestamp-link' href='04/frame-based-structured-exception.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2010-04-08T20:16:00-04:00'>8:16 PM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=7929495712930034237' onclick=''>
2 comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=7929495712930034237' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=7929495712930034237&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7929495712930034237&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7929495712930034237&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7929495712930034237&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7929495712930034237&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7929495712930034237&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Sunday, April 04, 2010</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='3795058133614123171' itemprop='postId'/>
<a name='3795058133614123171'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='04/switching-call-stacks-on-different.html'>Switching call stacks on different platforms</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-3795058133614123171' itemprop='description articleBody'>
<p>User-space implementations of coroutines and green threads need to be able to switch the CPU's call stack pointer between different memory regions. Since this is inherently CPU- and OS-specific, I'll limit my discussion to CPUs and platforms that Factor supports.</p> <h3>System APIs for switching call stacks</h3> <ul> <li>Windows has an API for creating and switching between contexts, which it calls "fibers". The main functions to look at are <a href="http://msdn.microsoft.com/en-us/library/ms682402(VS.85).aspx">CreateFiber()</a> and <a href="http://msdn.microsoft.com/en-us/library/ms686350(VS.85).aspx">SwitchToFiber()</a>. On Windows, by far the easiest way to switch call stacks is to just use fibers.</li> <li>Most Unix systems have a set of functions operating on <code>ucontext</code>s, such as <code>makecontext()</code>, <code>swapcontext()</code> and so on. On some systems, these APIs are poorly implemented and documented.</li> <li>The C standard library functions <code>setjmp()</code> and <code>longjmp()</code> can be (ab)used to switch contexts. The <code>jmpbuf</code> structure stored to by <code>setjmp()</code> and read from by <code>longjmp()</code> contains a snapshot of all registers, including the call stack pointer. Once you've allocated your own call stack, you can capture a <code>jmp_buf</code> with <code>setjmp()</code>, change the call stack pointer, and then resume execution with <code>longjmp()</code>. As far as I know, this is completely undocumented and unsupported with every major C compiler.</li> <li>The most direct way is to write some assembly to switch the relevant registers directly. Paradoxically, this approach is the most portable out of all of these, because while it is CPU-specific, the details are pretty much the same across most OSes, Windows being the exception. Switching call stacks on Windows is a bit more involved than just changing the <code>ESP</code> register, and requires updating some Windows-specific in-memory structures. However, it is still easy enough to do directly, if you do not wish to use the fiber API. I will describe the details at the end of this post.</li> </ul> <h3>High-level libraries for switching call stacks</h3> <p>A couple of existing libraries implement high-level, cross-platform abstractions using some combination of the above mechanisms.</p> <ul> <li><a href="http://www.dekorte.com/projects/opensource/libcoroutine/">libcoroutine</a> uses fibers on Windows, and ucontext and longjmp on Unix.</li> <li><a href="http://software.schmorp.de/pkg/libcoro.html">libcoro</a> uses a handful of Unix-specific APIs if they're available, or falls back onto some hand-coded assembly routines. The latter works on Windows.</li> </ul> <h3>NetBSD/x86 limitation</h3> <p>There is no realiable way to switch call stacks on NetBSD/x86, because of a limitation in the implementation of <code>libpthread</code>. Even if your program doesn't use pthreads, it might link with a library that does, such as Glib. The pthread library replaces various C standard library functions with its own versions, and since this includes some extremely common calls such as <code>malloc()</code>, almost nothing will work as a result.</p> <p>The reason is that the NetBSD pthread library uses a silly trick to implement thread-local storage, one which unfortunately assumes that every native thread has exactly one call stack. The trick is to always allocate thread call stacks on multiples of the maximum call stack size. Then, each thread's unique ID can just be the result of masking the call stack pointer by the maximum call stack size.</p> <h3>Windows-specific concerns</h3> <p>So far, I've only worked out the details of switching call stacks on 32-bit Windows. I'll talk about 64-bit Windows in another post.</p> <p>Windows has a mechanism known as <a href="http://msdn.microsoft.com/en-us/library/ms680657(VS.85).aspx">Structured Exception Handling</a>, which is a sort of scoped exception handling mechanism with kernel support. Windows uses SEH to deliver processor traps to user-space applications (illegal memory access, division by zero, etc). Some C++ compilers also use SEH to implement C++ exceptions.</p> <p>On Windows, simply changing the <code>ESP</code> register to point at another memory region is insufficient because structured exception handling must know the current call stack's beginning and end, as well as a pointer to the innermost exception handler record.</p> <p>These three pieces of information are stored in a per-thread information block, known as the TIB. The fiber switching APIs update the TIB for you, which is why Microsoft recommends their use.</p> <h4>The TIB</h4> <p>The TIB is defined by the <code>NT_TIB</code> struct in <code>winnt.h</code>:</p> &#65279;<pre>typedef struct _NT_TIB {<br />    struct _EXCEPTION_REGISTRATION_RECORD *ExceptionList;<br />    PVOID StackBase;<br />    PVOID StackLimit;<br />    PVOID SubSystemTib;<br />    _ANONYMOUS_UNION union {<br />        PVOID FiberData;<br />        DWORD Version;<br />    } DUMMYUNIONNAME;<br />    PVOID ArbitraryUserPointer;<br />    struct _NT_TIB *Self;<br />} NT_TIB,*PNT_TIB;</pre> <p>The relevant fields that must be updated when switching call stacks are <code>ExceptionList</code>, <code>StackBase</code> and <code>StackLimit</code>.</p> Note that since the x86 call stack grows down, <code>StackLimit</code> is the start of the call stack's memory region and <code>StackBase</code> is the end.</p> <h4>Structured exception handlers</h4> <p>Structured exception handlers are stored in a linked list on the call stack, with the head of the list pointed at by the <code>ExceptionList</code> field of the TIB:</p> <pre>struct _EXCEPTION_REGISTRATION_RECORD<br />{<br />     PEXCEPTION_REGISTRATION_RECORD Next;<br />     PEXCEPTION_DISPOSITION Handler;<br />} EXCEPTION_REGISTRATION_RECORD, *PEXCEPTION_REGISTRATION_RECORD;</pre> <p>The exception list should be saved and restored when switching between call stacks, and a new call stack should begin with an empty list (<code>ExceptionList</code> set to <code>NULL</code>).</p> <p>If the <code>ExceptionList</code> field of the TIB or the <code>Next</code> field of an exception record point outside the call stack, then the handler in question will not be called at all.</p> <h4>Accessing the TIB</h4> <p>On x86-32, the current thread's TIB is stored starting at address 0 in the segment pointed at by the FS segment register. The <code>Self</code> field always points at the struct itself. Since Windows uses flat addressing, the segment storing the TIB begins somewhere in the linear 32-bit address space, so an assembly routine to fetch the TIB and return a pointer to it in EAX looks like this:</p> <pre>fetch_tib:<br />    mov eax,[fs:24]<br />    ret</pre> <p>This assembly routine can then be called from C code, which can manipulate the TIB like any other structure.</p><h4>Sample code for updating Windows-specific structures</h4><p>The <a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=basis/cpu/x86/32/winnt/bootstrap.factor;hb=HEAD">basis/cpu/x86/32/winnt/bootstrap.factor</a> file defines assembly subroutines for updating the TIB when switching call stacks. These routines are invoked by the x86-32 non-optimizing compiler backend:</p> <ul> <li><a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=basis/cpu/x86/bootstrap.factor;hb=HEAD">basis/cpu/x86/bootstrap.factor</a></li> <li><a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=basis/cpu/x86/32/bootstrap.factor;hb=HEAD">basis/cpu/x86/32/bootstrap.factor</a></li></ul>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2010/04/switching-call-stacks-on-different.html' itemprop='url'/>
<a class='timestamp-link' href='04/switching-call-stacks-on-different.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2010-04-04T16:24:00-04:00'>4:24 PM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=3795058133614123171' onclick=''>
2 comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=3795058133614123171' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=3795058133614123171&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3795058133614123171&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3795058133614123171&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3795058133614123171&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3795058133614123171&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=3795058133614123171&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Tuesday, March 23, 2010</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='6584784544302650530' itemprop='postId'/>
<a name='6584784544302650530'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='03/change-in-mach-exception-handler.html'>Incompatible change in Mach exception handler behavior on Mac OS X 10.6</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-6584784544302650530' itemprop='description articleBody'>
<p>On Mac OS X, Factor uses Mach exceptions rather than Unix signals to receive notifications of illegal memory accesses and arithmetic exceptions from the operating system. This is used to catch datastack underflows, division by zero, and the like. The code implementing this can be found in <a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=vm/mach_signal.cpp;hb=HEAD">vm/mach_signal.c</a> in the Factor repository. This file is based on code from the <a href="http://libsigsegv.sourceforge.net/">GNU libsigsegv</a> project, with <a href="http://sourceforge.net/mailarchive/message.php?msg_name=200503102200.32002.bruno%40clisp.org">special permission</a> to use it under a BSD license instead of the restrictive GPL.</p><p>It seems that as of Mac OS X 10.6, exceptions raised by child processes are now reported to the parent if the parent has an exception handler thread. This caused a problem in Factor if a child process crashed with an access violation; Factor would think the access violation occurred in Factor code, and die with an assertion failure when attempting to map the thread ID back into a Factor VM object. It seems the simplest way is to add the following clause to the <code>catch_exception_raise()</code> function:</p><pre>if(task != mach_task_self()) return KERN_FAILURE;</pre><p>This fix should be applicable to the original <code>libsigsegv</code> code as well, along with other projects, such as CLisp, that use this library.</p>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2010/03/change-in-mach-exception-handler.html' itemprop='url'/>
<a class='timestamp-link' href='03/change-in-mach-exception-handler.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2010-03-23T04:29:00-04:00'>4:29 AM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=6584784544302650530' onclick=''>
2 comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=6584784544302650530' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=6584784544302650530&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=6584784544302650530&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=6584784544302650530&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=6584784544302650530&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=6584784544302650530&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=6584784544302650530&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Thursday, March 11, 2010</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='17087850' itemprop='blogId'/>
<meta content='5649626009483050415' itemprop='postId'/>
<a name='5649626009483050415'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='03/adding-recaptcha-to-factor-pastebin.html'>Adding a recaptcha to the Factor pastebin</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-5649626009483050415' itemprop='description articleBody'>
<p>Lately the <a href="http://paste.factorcode.org">Factor pastebin</a> has been flooded with penis enlargement spam. The pastebin had its own very weak captcha that worked well enough for a while: there was a form field that was required to be left blank, and if it was not blank validation would fail. However, spammers have started working around it so we needed something stronger. I decided to solve the problem once and for all by integrating <a href="http://code-factor.blogspot.com">Doug Coleman</a>'s <a href="http://docs.factorcode.org/content/article-furnace.recaptcha.html">furnace.recaptcha</a> vocabulary into the pastebin. Doing this was surprisingly easy.</p><p>First, I changed the <code>USING:</code> form in <a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=extra/webapps/pastebin/pastebin.factor;hb=HEAD">webapps.pastebin</a> to reference the <code>furnace.recaptcha</code> vocabulary:</p><pre>USING: namespaces assocs sorting sequences kernel accessors<br />hashtables db.types db.tuples db combinators<br />calendar calendar.format math.parser math.order syndication urls<br />xml.writer xmode.catalog validators<br />html.forms<br />html.components<br />html.templates.chloe<br />http.server<br />http.server.dispatchers<br />http.server.redirection<br />http.server.responses<br />furnace<br />furnace.actions<br />furnace.redirection<br />furnace.auth<br />furnace.auth.login<br />furnace.boilerplate<br />furnace.recaptcha<br />furnace.syndication<br />furnace.conversations ;</pre><p>Next, I changed the <code>validate-entity</code> word. This word is used to validate a form submission when adding a new paste or a new annotation. Instead of validating a captcha using the old simple scheme, it now calls <code>validate-recaptcha</code>:</p><pre>: validate-entity ( -- )<br />    {<br />        { "summary" [ v-one-line ] }<br />        { "author" [ v-one-line ] }<br />        { "mode" [ v-mode ] }<br />        { "contents" [ v-required ] }<br />    } validate-params<br />    validate-recaptcha ;</pre><p>Finally, I edited the <a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=extra/webapps/pastebin/new-paste.xml;hb=HEAD">new-paste.xml</a> and <a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=extra/webapps/pastebin/new-annotation.xml;hb=HEAD">new-annotation.xml</a> templates to add a recaptcha component inside the <code>t:form</code> tag:</p><pre>&lt;tr>&lt;td colspan="2">&lt;t:recaptcha />&lt;/td>&lt;/tr></pre><p>The implementation of the <a href="http://gitweb.factorcode.org/gitweb.cgi?p=factor/.git;a=blob;f=basis/furnace/recaptcha/recaptcha.factor;hb=HEAD">furnace.recaptcha</a> vocabulary is very straightforward and takes advantage of several features of Factor's web framework. It uses <a href="http://docs.factorcode.org/content/article-http.client.html">http.client</a> to communicate with the recaptcha server, and <a href="http://docs.factorcode.org/content/article-furnace.conversations.html">furnace.conversations</a> to pass the validation error between requests. Finally, it uses the <code>CHLOE:</code> parsing word to define the <code>t:recaptcha</code> tag for use in templates:</p><pre>CHLOE: recaptcha drop [ render-recaptcha ] [xml-code] ;</pre>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2010/03/adding-recaptcha-to-factor-pastebin.html' itemprop='url'/>
<a class='timestamp-link' href='03/adding-recaptcha-to-factor-pastebin.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2010-03-11T03:16:00-05:00'>3:16 AM</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='https://www.blogger.com/comment.g?blogID=17087850&postID=5649626009483050415' onclick=''>
No comments:
  </a>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=5649626009483050415' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=5649626009483050415&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5649626009483050415&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5649626009483050415&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5649626009483050415&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5649626009483050415&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=5649626009483050415&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
</div>

        </div></div>
      
</div>
<div class='blog-pager' id='blog-pager'>
<span id='blog-pager-newer-link'>
<a class='blog-pager-newer-link' href='../index.html' id='Blog1_blog-pager-newer-link' title='Newer Posts'>Newer Posts</a>
</span>
<span id='blog-pager-older-link'>
<a class='blog-pager-older-link' href='http://factor-language.blogspot.com/search?updated-max=2010-03-11T03:16:00-05:00&amp;max-results=7' id='Blog1_blog-pager-older-link' title='Older Posts'>Older Posts</a>
</span>
<a class='home-link' href='../index.html'>Home</a>
</div>
<div class='clear'></div>
<div class='blog-feeds'>
<div class='feed-links'>
Subscribe to:
<a class='feed-link' href='http://factor-language.blogspot.com/feeds/posts/default' target='_blank' type='application/atom+xml'>Posts (Atom)</a>
</div>
</div>
</div></div>
</div>
<div id='sidebar-wrapper'>
<div class='sidebar section' id='sidebar'><div class='widget BlogArchive' data-version='1' id='BlogArchive1'>
<h2>Older Posts</h2>
<div class='widget-content'>
<div id='ArchiveList'>
<div id='BlogArchive1_ArchiveList'>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='index.html'>
2010
</a>
<span class='post-count' dir='ltr'>(18)</span>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(4)</span>
<ul class='posts'>
<li><a href='09/factor-094-now-available.html'>Factor 0.94 now available</a></li>
<li><a href='09/overview-of-factors-io-library.html'>An overview of Factor&#39;s I/O library</a></li>
<li><a href='09/making-factors-continuous-build-system.html'>Making Factor&#39;s continuous build system more robust</a></li>
<li><a href='09/two-things-every-unix-developer-should.html'>Two things every Unix developer should know</a></li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(2)</span>
<ul class='posts'>
<li><a href='07/overhauling-factors-c-library-interface.html'>Overhauling Factor&#39;s C library interface</a></li>
<li><a href='07/factor-talk-in-boston-july-26th.html'>Factor talk in Boston, July 26th</a></li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(2)</span>
<ul class='posts'>
<li><a href='05/comparing-factors-performance-against.html'>Comparing Factor&#39;s performance against V8, LuaJIT,...</a></li>
<li><a href='05/collection-of-small-compiler.html'>A collection of small compiler improvements</a></li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(3)</span>
<ul class='posts'>
<li><a href='04/factor-093-now-available.html'>Factor 0.93 now available</a></li>
<li><a href='04/frame-based-structured-exception.html'>Frame-based structured exception handling on Windo...</a></li>
<li><a href='04/switching-call-stacks-on-different.html'>Switching call stacks on different platforms</a></li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='03/index.html'>
March
</a>
<span class='post-count' dir='ltr'>(2)</span>
<ul class='posts'>
<li><a href='03/change-in-mach-exception-handler.html'>Incompatible change in Mach exception handler beha...</a></li>
<li><a href='03/adding-recaptcha-to-factor-pastebin.html'>Adding a recaptcha to the Factor pastebin</a></li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/index.html'>
2009
</a>
<span class='post-count' dir='ltr'>(35)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/08/index.html'>
August
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/03/index.html'>
March
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2009/01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(6)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2008/index.html'>
2008
</a>
<span class='post-count' dir='ltr'>(96)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2008/12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2008/11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2008/10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2008/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2008/08/index.html'>
August
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2008/07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2008/06/index.html'>
June
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2008/05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(6)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2008/04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(13)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2008/03/index.html'>
March
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2008/02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(17)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2008/01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/index.html'>
2007
</a>
<span class='post-count' dir='ltr'>(141)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(13)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(10)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(15)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/08/index.html'>
August
</a>
<span class='post-count' dir='ltr'>(21)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/06/index.html'>
June
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/03/index.html'>
March
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2007/01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(15)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/index.html'>
2006
</a>
<span class='post-count' dir='ltr'>(207)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(23)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(30)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(25)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(22)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/08/index.html'>
August
</a>
<span class='post-count' dir='ltr'>(26)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(23)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/06/index.html'>
June
</a>
<span class='post-count' dir='ltr'>(11)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(15)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/03/index.html'>
March
</a>
<span class='post-count' dir='ltr'>(11)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2006/01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2005/index.html'>
2005
</a>
<span class='post-count' dir='ltr'>(23)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2005/12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(11)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2005/11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2005/10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(6)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../2005/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class='clear'></div>
</div>
</div><div class='widget Feed' data-version='1' id='Feed2'>
<h2>Recent Factor Commits</h2>
<div class='widget-content' id='Feed2_feedItemListDisplay'>
<span style='filter: alpha(25); opacity: 0.25;'>
<a href='http://gitweb.factorcode.org/gitweb.cgi?p=factor.git;a=atom'>Loading...</a>
</span>
</div>
<div class='clear'></div>
</div><div class='widget Feed' data-version='1' id='Feed1'>
<h2>Planet Factor</h2>
<div class='widget-content' id='Feed1_feedItemListDisplay'>
<span style='filter: alpha(25); opacity: 0.25;'>
<a href='http://planet.factorcode.org/feed.xml'>Loading...</a>
</span>
</div>
<div class='clear'></div>
</div><div class='widget LinkList' data-version='1' id='LinkList1'>
<h2>Links</h2>
<div class='widget-content'>
<ul>
<li><a href='http://twitter.com/slava_pestov'>@slava_pestov</a></li>
<li><a href='http://factorcode.org/slava/'>My home page</a></li>
<li><a href='http://factorcode.org/'>Factor programming language</a></li>
<li><a href='http://concatenative.org/'>Concatenative language wiki</a></li>
<li><a href='http://planet.factorcode.org/'>Planet Factor</a></li>
</ul>
<div class='clear'></div>
</div>
</div></div>
</div>
<!-- spacer for skins that want sidebar and main to be the same height-->
<div class='clear'>&#160;</div>
</div>
<!-- end content-wrapper -->
<div id='footer-wrapper'>
<div class='footer no-items section' id='footer'></div>
</div>
</div></div>
<!-- end outer-wrapper -->

<script type="text/javascript" src="https://www.blogger.com/static/v1/widgets/940443484-widgets.js"></script>
<script type='text/javascript'>
window['__wavt'] = 'AOuZoY7tg5IbaRJ9krKlTYDkfJMLPX3c7A:1693932681608';_WidgetManager._Init('//www.blogger.com/rearrange?blogID\x3d17087850','//factor-language.blogspot.com/2010/','17087850');
_WidgetManager._SetDataContext([{'name': 'blog', 'data': {'blogId': '17087850', 'title': 'Factor: a practical stack language', 'url': 'http://factor-language.blogspot.com/2010/', 'canonicalUrl': 'http://factor-language.blogspot.com/2010/', 'homepageUrl': 'http://factor-language.blogspot.com/', 'searchUrl': 'http://factor-language.blogspot.com/search', 'canonicalHomepageUrl': 'http://factor-language.blogspot.com/', 'blogspotFaviconUrl': 'http://factor-language.blogspot.com/favicon.ico', 'bloggerUrl': 'https://www.blogger.com', 'hasCustomDomain': false, 'httpsEnabled': true, 'enabledCommentProfileImages': true, 'gPlusViewType': 'FILTERED_POSTMOD', 'adultContent': false, 'analyticsAccountNumber': '', 'encoding': 'UTF-8', 'locale': 'en-US', 'localeUnderscoreDelimited': 'en', 'languageDirection': 'ltr', 'isPrivate': false, 'isMobile': false, 'isMobileRequest': false, 'mobileClass': '', 'isPrivateBlog': false, 'isDynamicViewsAvailable': true, 'feedLinks': '\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Factor: a practical stack language - Atom\x22 href\x3d\x22http://factor-language.blogspot.com/feeds/posts/default\x22 /\x3e\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/rss+xml\x22 title\x3d\x22Factor: a practical stack language - RSS\x22 href\x3d\x22http://factor-language.blogspot.com/feeds/posts/default?alt\x3drss\x22 /\x3e\n\x3clink rel\x3d\x22service.post\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Factor: a practical stack language - Atom\x22 href\x3d\x22https://www.blogger.com/feeds/17087850/posts/default\x22 /\x3e\n', 'meTag': '', 'adsenseHostId': 'ca-host-pub-1556223355139109', 'adsenseHasAds': false, 'adsenseAutoAds': false, 'boqCommentIframeForm': true, 'loginRedirectParam': '', 'view': '', 'dynamicViewsCommentsSrc': '//www.blogblog.com/dynamicviews/4224c15c4e7c9321/js/comments.js', 'dynamicViewsScriptSrc': '//www.blogblog.com/dynamicviews/591781cadcbb8744', 'plusOneApiSrc': 'https://apis.google.com/js/platform.js', 'disableGComments': true, 'interstitialAccepted': false, 'sharing': {'platforms': [{'name': 'Get link', 'key': 'link', 'shareMessage': 'Get link', 'target': ''}, {'name': 'Facebook', 'key': 'facebook', 'shareMessage': 'Share to Facebook', 'target': 'facebook'}, {'name': 'BlogThis!', 'key': 'blogThis', 'shareMessage': 'BlogThis!', 'target': 'blog'}, {'name': 'Twitter', 'key': 'twitter', 'shareMessage': 'Share to Twitter', 'target': 'twitter'}, {'name': 'Pinterest', 'key': 'pinterest', 'shareMessage': 'Share to Pinterest', 'target': 'pinterest'}, {'name': 'Email', 'key': 'email', 'shareMessage': 'Email', 'target': 'email'}], 'disableGooglePlus': true, 'googlePlusShareButtonWidth': 0, 'googlePlusBootstrap': '\x3cscript type\x3d\x22text/javascript\x22\x3ewindow.___gcfg \x3d {\x27lang\x27: \x27en\x27};\x3c/script\x3e'}, 'hasCustomJumpLinkMessage': false, 'jumpLinkMessage': 'Read more', 'pageType': 'archive', 'pageName': '2010', 'pageTitle': 'Factor: a practical stack language: 2010'}}, {'name': 'features', 'data': {}}, {'name': 'messages', 'data': {'edit': 'Edit', 'linkCopiedToClipboard': 'Link copied to clipboard!', 'ok': 'Ok', 'postLink': 'Post Link'}}, {'name': 'template', 'data': {'isResponsive': false, 'isAlternateRendering': false, 'isCustom': false}}, {'name': 'view', 'data': {'classic': {'name': 'classic', 'url': '?view\x3dclassic'}, 'flipcard': {'name': 'flipcard', 'url': '?view\x3dflipcard'}, 'magazine': {'name': 'magazine', 'url': '?view\x3dmagazine'}, 'mosaic': {'name': 'mosaic', 'url': '?view\x3dmosaic'}, 'sidebar': {'name': 'sidebar', 'url': '?view\x3dsidebar'}, 'snapshot': {'name': 'snapshot', 'url': '?view\x3dsnapshot'}, 'timeslide': {'name': 'timeslide', 'url': '?view\x3dtimeslide'}, 'isMobile': false, 'title': 'Factor: a practical stack language', 'description': '\x3ca href\x3d\x22http://factorcode.org/slava\x22\x3eSlava Pestov\x3c/a\x3e\x27s weblog, primarily about \x3ca href\x3d\x22http://factorcode.org\x22\x3eFactor\x3c/a\x3e.', 'url': 'http://factor-language.blogspot.com/2010/', 'type': 'feed', 'isSingleItem': false, 'isMultipleItems': true, 'isError': false, 'isPage': false, 'isPost': false, 'isHomepage': false, 'isArchive': true, 'isLabelSearch': false, 'archive': {'year': 2010, 'rangeMessage': 'Showing posts from 2010'}}}]);
_WidgetManager._RegisterWidget('_NavbarView', new _WidgetInfo('Navbar1', 'navbar', document.getElementById('Navbar1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_HeaderView', new _WidgetInfo('Header1', 'header', document.getElementById('Header1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogView', new _WidgetInfo('Blog1', 'main', document.getElementById('Blog1'), {'cmtInteractionsEnabled': false, 'lightboxEnabled': true, 'lightboxModuleUrl': 'https://www.blogger.com/static/v1/jsbin/1333563935-lbx.js', 'lightboxCssUrl': 'https://www.blogger.com/static/v1/v-css/3268905543-lightbox_bundle.css'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogArchiveView', new _WidgetInfo('BlogArchive1', 'sidebar', document.getElementById('BlogArchive1'), {'languageDirection': 'ltr', 'loadingMessage': 'Loading\x26hellip;'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_FeedView', new _WidgetInfo('Feed2', 'sidebar', document.getElementById('Feed2'), {'title': 'Recent Factor Commits', 'showItemDate': true, 'showItemAuthor': true, 'feedUrl': 'http://gitweb.factorcode.org/gitweb.cgi?p\x3dfactor.git;a\x3datom', 'numItemsShow': 5, 'loadingMsg': 'Loading...', 'openLinksInNewWindow': false, 'useFeedWidgetServ': 'true'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_FeedView', new _WidgetInfo('Feed1', 'sidebar', document.getElementById('Feed1'), {'title': 'Planet Factor', 'showItemDate': true, 'showItemAuthor': false, 'feedUrl': 'http://planet.factorcode.org/feed.xml', 'numItemsShow': 5, 'loadingMsg': 'Loading...', 'openLinksInNewWindow': false, 'useFeedWidgetServ': 'true'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_LinkListView', new _WidgetInfo('LinkList1', 'sidebar', document.getElementById('LinkList1'), {}, 'displayModeFull'));
</script>
</body>
</html>