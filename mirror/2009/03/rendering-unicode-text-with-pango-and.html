<!DOCTYPE html>
<html dir='ltr'>
<head>
<link href='https://www.blogger.com/static/v1/widgets/55013136-widget_css_bundle.css' rel='stylesheet' type='text/css'/>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'/>
<meta content='blogger' name='generator'/>
<link href='../../favicon.ico' rel='icon' type='image/x-icon'/>
<link href='rendering-unicode-text-with-pango-and.html' rel='canonical'/>
<link rel="alternate" type="application/atom+xml" title="Factor: a practical stack language - Atom" href="http://factor-language.blogspot.com/feeds/posts/default" />
<link rel="alternate" type="application/rss+xml" title="Factor: a practical stack language - RSS" href="http://factor-language.blogspot.com/feeds/posts/default?alt=rss" />
<link rel="service.post" type="application/atom+xml" title="Factor: a practical stack language - Atom" href="https://www.blogger.com/feeds/17087850/posts/default" />

<link rel="alternate" type="application/atom+xml" title="Factor: a practical stack language - Atom" href="http://factor-language.blogspot.com/feeds/7405626662862773190/comments/default" />
<!--Can't find substitution for tag [blog.ieCssRetrofitLinks]-->
<link href='http://factorcode.org/pango-bounds.png' rel='image_src'/>
<meta content='http://factor-language.blogspot.com/2009/03/rendering-unicode-text-with-pango-and.html' property='og:url'/>
<meta content='Rendering Unicode text with Pango and Cairo' property='og:title'/>
<meta content='I implemented a Pango backend for text rendering in the Factor UI. This means that new_ui  now works on Windows and X11 (well, not quite; I ...' property='og:description'/>
<meta content='https://lh3.googleusercontent.com/blogger_img_proxy/AAOd8MxPjI3TWCM8_TNGXDfknQXCpnVbmN9-hr5UqljeT6phh3kr4msFLTApDry4qgcLDKuzRxQ86x9otpxgT7V1ik1X6mHaVZNdeKdL=w1200-h630-p-k-no-nu' property='og:image'/>
<title>Factor: a practical stack language: Rendering Unicode text with Pango and Cairo</title>
<style id='page-skin-1' type='text/css'><!--
/*
-----------------------------------------------
Blogger Template Style
Name:     Stretch Denim Light
Designer: Darren Delaye
URL:      www.DarrenDelaye.com
Date:     11 Jul 2006
-----------------------------------------------
*/
body {
background: #ffffff;
margin: 0;
padding: 0px;
font: x-small Verdana, Arial;
text-align: center;
color: #333333;
font-size/* */:/**/small;
font-size: /**/small;
}
a:link {
color: #336699;
}
a:visited {
color: #336699;
}
a img {
border-width: 0;
}
#outer-wrapper {
font: normal normal 100% Verdana, Arial, Sans-serif;;
}
/* Header
----------------------------------------------- */
#header-wrapper {
margin:0;
padding: 0;
background-color: #c4e1ff;
text-align: left;
}
#header {
margin: 0 2%;
background-color: #c4e1ff;
color: #003366;
padding: 0;
font: normal normal 210% Verdana, Arial, Sans-serif;;
position: relative;
}
h1.title {
padding-top: 38px;
margin: 0 1% .1em;
line-height: 1.2em;
font-size: 100%;
}
h1.title a, h1.title a:visited {
color: #003366;
text-decoration: none;
}
#header .description {
display: block;
margin: 0 1%;
padding: 0 0 40px;
line-height: 1.4em;
font-size: 50%;
}
/* Content
----------------------------------------------- */
.clear {
clear: both;
}
#content-wrapper {
margin: 0 2%;
padding: 0 0 15px;
text-align: left;
background-color: #ffffff;
border: 1px solid #ffffff;
border-top: 0;
}
#main-wrapper {
margin-left: 1%;
width: 64%;
float: left;
background-color: #ffffff;
display: inline;       /* fix for doubling margin in IE */
word-wrap: break-word; /* fix for long text breaking sidebar float in IE */
overflow: hidden;      /* fix for long non-text content breaking IE sidebar float */
}
#sidebar-wrapper {
margin-right: 1%;
width: 29%;
float: right;
background-color: #ffffff;
display: inline;       /* fix for doubling margin in IE */
word-wrap: break-word; /* fix for long text breaking sidebar float in IE */
overflow: hidden;      /* fix for long non-text content breaking IE sidebar float */
}
/* Headings
----------------------------------------------- */
h2, h3 {
margin: 0;
}
/* Posts
----------------------------------------------- */
.date-header {
margin: 1.5em 0 0;
font-weight: normal;
color: #999999;
font-size: 100%;
}
.post {
margin: 0 0 1.5em;
padding-bottom: 1.5em;
}
.post-title {
margin: 0;
padding: 0;
font-size: 125%;
font-weight: bold;
line-height: 1.1em;
}
.post-title a, .post-title a:visited, .post-title strong {
text-decoration: none;
color: #333333;
font-weight: bold;
}
.post div {
margin: 0 0 .75em;
line-height: 1.3em;
}
.post-footer {
margin: -.25em 0 0;
color: #333333;
font-size: 87%;
}
.post-footer .span {
margin-right: .3em;
}
.post img, table.tr-caption-container {
padding: 4px;
border: 1px solid #ffffff;
}
.tr-caption-container img {
border: none;
padding: 0;
}
.post blockquote {
margin: 1em 20px;
}
.post blockquote p {
margin: .75em 0;
}
/* Comments
----------------------------------------------- */
#comments h4 {
margin: 1em 0;
color: #999999;
}
#comments h4 strong {
font-size: 110%;
}
#comments-block {
margin: 1em 0 1.5em;
line-height: 1.3em;
}
#comments-block dt {
margin: .5em 0;
}
#comments-block dd {
margin: .25em 0 0;
}
#comments-block dd.comment-footer {
margin: -.25em 0 2em;
line-height: 1.4em;
font-size: 78%;
}
#comments-block dd p {
margin: 0 0 .75em;
}
.deleted-comment {
font-style:italic;
color:gray;
}
.feed-links {
clear: both;
line-height: 2.5em;
}
#blog-pager-newer-link {
float: left;
}
#blog-pager-older-link {
float: right;
}
#blog-pager {
text-align: center;
}
/* Sidebar Content
----------------------------------------------- */
.sidebar h2 {
margin: 1.6em 0 .5em;
padding: 4px 5px;
background-color: #ffffff;
font-size: 100%;
color: #333333;
}
.sidebar ul {
margin: 0;
padding: 0;
list-style: none;
}
.sidebar li {
margin: 0;
padding-top: 0;
padding-right: 0;
padding-bottom: .5em;
padding-left: 15px;
text-indent: -15px;
line-height: 1.5em;
}
.sidebar {
color: #333333;
line-height:1.3em;
}
.sidebar .widget {
margin-bottom: 1em;
}
.sidebar .widget-content {
margin: 0 5px;
}
/* Profile
----------------------------------------------- */
.profile-img {
float: left;
margin-top: 0;
margin-right: 5px;
margin-bottom: 5px;
margin-left: 0;
padding: 4px;
border: 1px solid #ffffff;
}
.profile-data {
margin:0;
text-transform:uppercase;
letter-spacing:.1em;
font-weight: bold;
line-height: 1.6em;
font-size: 78%;
}
.profile-datablock {
margin:.5em 0 .5em;
}
.profile-textblock {
margin: 0.5em 0;
line-height: 1.6em;
}
/* Footer
----------------------------------------------- */
#footer {
clear: both;
text-align: center;
color: #333333;
}
#footer .widget {
margin:.5em;
padding-top: 20px;
font-size: 85%;
line-height: 1.5em;
text-align: left;
}
/** Page structure tweaks for layout editor wireframe */
body#layout #header {
width: 750px;
}

--></style>
<link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=17087850&amp;zx=107902e8-e226-40c6-bb3f-e93edf539d65' media='none' onload='if(media!=&#39;all&#39;)media=&#39;all&#39;' rel='stylesheet'/><noscript><link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=17087850&amp;zx=107902e8-e226-40c6-bb3f-e93edf539d65' rel='stylesheet'/></noscript>
<meta name='google-adsense-platform-account' content='ca-host-pub-1556223355139109'/>
<meta name='google-adsense-platform-domain' content='blogspot.com'/>

</head>
<body>
<div class='navbar section' id='navbar'><div class='widget Navbar' data-version='1' id='Navbar1'><script type="text/javascript">
    function setAttributeOnload(object, attribute, val) {
      if(window.addEventListener) {
        window.addEventListener('load',
          function(){ object[attribute] = val; }, false);
      } else {
        window.attachEvent('onload', function(){ object[attribute] = val; });
      }
    }
  </script>
<div id="navbar-iframe-container"></div>
<script type="text/javascript" src="https://apis.google.com/js/platform.js"></script>
<script type="text/javascript">
      gapi.load("gapi.iframes:gapi.iframes.style.bubble", function() {
        if (gapi.iframes && gapi.iframes.getContext) {
          gapi.iframes.getContext().openChild({
              url: 'https://www.blogger.com/navbar.g?targetBlogID\x3d17087850\x26blogName\x3dFactor:+a+practical+stack+language\x26publishMode\x3dPUBLISH_MODE_BLOGSPOT\x26navbarType\x3dBLUE\x26layoutType\x3dLAYOUTS\x26searchRoot\x3dhttps://factor-language.blogspot.com/search\x26blogLocale\x3den_US\x26v\x3d2\x26homepageUrl\x3dhttp://factor-language.blogspot.com/\x26targetPostID\x3d7405626662862773190\x26blogPostOrPageUrl\x3dhttp://factor-language.blogspot.com/2009/03/rendering-unicode-text-with-pango-and.html\x26vt\x3d-9102118634077756787',
              where: document.getElementById("navbar-iframe-container"),
              id: "navbar-iframe"
          });
        }
      });
    </script><script type="text/javascript">
(function() {
var script = document.createElement('script');
script.type = 'text/javascript';
script.src = '//pagead2.googlesyndication.com/pagead/js/google_top_exp.js';
var head = document.getElementsByTagName('head')[0];
if (head) {
head.appendChild(script);
}})();
</script>
</div></div>
<div id='outer-wrapper'><div id='wrap2'>
<!-- skip links for text browsers -->
<span id='skiplinks' style='display:none;'>
<a href='rendering-unicode-text-with-pango-and.html#main'>skip to main </a> |
      <a href='rendering-unicode-text-with-pango-and.html#sidebar'>skip to sidebar</a>
</span>
<div id='header-wrapper'>
<div class='header section' id='header'><div class='widget Header' data-version='1' id='Header1'>
<div id='header-inner'>
<div class='titlewrapper'>
<h1 class='title'>
<a href='../../index.html'>
Factor: a practical stack language
</a>
</h1>
</div>
<div class='descriptionwrapper'>
<p class='description'><span><a href="http://factorcode.org/slava">Slava Pestov</a>'s weblog, primarily about <a href="http://factorcode.org">Factor</a>.</span></p>
</div>
</div>
</div></div>
</div>
<div id='content-wrapper'>
<div id='crosscol-wrapper' style='text-align:center'>
<div class='crosscol no-items section' id='crosscol'></div>
</div>
<div id='main-wrapper'>
<div class='main section' id='main'><div class='widget Blog' data-version='1' id='Blog1'>
<div class='blog-posts hfeed'>

          <div class="date-outer">
        
<h2 class='date-header'><span>Tuesday, March 03, 2009</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry uncustomized-post-template' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='http://factorcode.org/pango-bounds.png' itemprop='image_url'/>
<meta content='17087850' itemprop='blogId'/>
<meta content='7405626662862773190' itemprop='postId'/>
<a name='7405626662862773190'></a>
<h3 class='post-title entry-title' itemprop='name'>
Rendering Unicode text with Pango and Cairo
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-7405626662862773190' itemprop='description articleBody'>
I implemented a Pango backend for text rendering in the Factor UI. This means that <code>new_ui</code> now works on Windows and X11 (well, not quite; I have to fix an unrelated bug in the X11 backend), and so it's almost ready to merge.<br /><br />My main reference for Pango was the <a href="http://library.gnome.org/devel/pango/unstable/index.html">API documentation</a> on gnome.org. Conceptually, Pango is quite similar to Core Text, but there are some important differences I will outline below. Pango supports two primary rendering backends; Xft and Cairo. I use the Cairo backend to render to a Cairo offscreen surface, and make an OpenGL texture out of it.<br /><br /><h3>Cairo offscreen surfaces and OpenGL</h3><br />When I wrote the code to create an offscreen Cairo surface, and wrap the result in a Factor bitmap <code>image</code> object, the code turned out to look almost identical to a similar utility I cooked up for Core Graphics. So as any self-respecting programmer, I factored this duplication out into a <code>images.memory</code> vocabulary.<br /><br />First, we have some code to allocate unmanaged memory for the bitmap data. This memory is unmanaged because Cairo (and Core Graphics) retain a pointer to it, and so it must not be moved by a GC:<br /><pre><font color="#000000"><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>bitmap-size</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>dim</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>n</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> product <font color="#006666">&quot;</font><font color="#006666">uint</font><font color="#006666">&quot;</font> heap-size * <font color="#000000"><strong>;</strong></font><br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>malloc-bitmap-data</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>dim</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>alien</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> bitmap-size <font color="#ff0000">1</font> calloc &amp;free <font color="#000000"><strong>;</strong></font><br /></font></pre><br />Note that destructors are used to ensure the memory is deallocated later. Now, we have some code copy data out of the unmanaged memory and into a Factor byte array, and wrap it in a bitmap image object:<br /><pre><font color="#000000"><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>bitmap-data</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>alien</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>dim</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>data</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> bitmap-size memory&gt;byte-array <font color="#000000"><strong>;</strong></font><br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>&lt;bitmap-image&gt;</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>alien</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>dim</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>image</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#006633">[</font> bitmap-data <font color="#006633">]</font> keep<br />    &lt;image&gt;<br />        swap &gt;&gt;dim<br />        swap &gt;&gt;bitmap <font color="#000000"><strong>;</strong></font><br /></font></pre><br />Putting everything together into a combinator:<br /><pre><font color="#000000"><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>make-memory-bitmap</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>dim</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>quot</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>image</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    '<font color="#006633">[</font><br />        <font color="#006633">[</font> malloc-bitmap-data <font color="#006633">]</font> keep _ <font color="#006633">[</font> &lt;bitmap-image&gt; <font color="#006633">]</font> 2bi<br />    <font color="#006633">]</font> with-destructors <font color="#000000"><strong>;</strong></font> inline<br /></font></pre><br />So the quotation receives the image dimensions and a pointer to some unmanaged memory.<br /><br />On the Cairo side, I have a word to create an offscreen bitmap:<br /><pre><font color="#000000"><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>width&gt;stride</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>width</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>stride</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> <font color="#006666">&quot;</font><font color="#006666">uint</font><font color="#006666">&quot;</font> heap-size * <font color="#000000"><strong>;</strong></font> inline<br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>&lt;image-surface&gt;</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>data</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>dim</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>surface</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#006633">[</font> CAIRO_FORMAT_ARGB32 <font color="#006633">]</font> dip first2 over width&gt;stride<br />    cairo_image_surface_create_for_data<br />    dup check-surface <font color="#000000"><strong>;</strong></font><br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>&lt;cairo&gt;</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>surface</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>cairo</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> cairo_create dup check-cairo <font color="#000000"><strong>;</strong></font> inline<br /></font></pre><br />And then I use <code>make-memory-image</code> together with this word to define a new <code>make-bitmap-image</code> combinator:<br /><pre><font color="#000000"><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>make-bitmap-image</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>dim</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>quot</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>image</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    '<font color="#006633">[</font><br />        &lt;image-surface&gt; &amp;cairo_surface_destroy<br />        &lt;cairo&gt; &amp;cairo_destroy<br />        @<br />    <font color="#006633">]</font> make-memory-bitmap<br />    BGRA &gt;&gt;component-order <font color="#000000"><strong>;</strong></font> inline<br /></font></pre><br />This combinator makes the Cairo binding very pleasant to use. Once Factor's image library supports some more formats -- PNG comes to mind -- it will be possible to render some graphics in a web app and serve it up as a PNG to the client. Of course Cairo can write PNGs already, so alternatively someone could write a high-level wrapper for those APIs instead.<br /><br />So the Pango text backend makes Pango calls inside a <code>make-bitmap-image</code>, then passes the result to the OpenGL texture caching code I talked about last time.<br /><h3>Fixed-point and floating-point numbers</h3><br />Pango uses fixed-point arithmetic for sub-pixel co-ordinates. I convert everything to and from floats when calling Pango using a pair of words:<br /><pre><font color="#000000">CONSTANT: PANGO_SCALE <font color="#ff0000">1024</font><br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>pango&gt;float</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>n</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>x</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> PANGO_SCALE /f <font color="#000000"><strong>;</strong></font> inline<br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>float&gt;pango</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>x</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>n</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> PANGO_SCALE * &gt;integer <font color="#000000"><strong>;</strong></font> inline<br /></font></pre><br />For example, here is some code to convert a fixed-point <code>PangoRectangle</code> into a Factor <code>rect</code> type:<br /><pre><font color="#000000">C-STRUCT: PangoRectangle<br />    <font color="#006633">{</font> <font color="#006666">&quot;</font><font color="#006666">int</font><font color="#006666">&quot;</font> <font color="#006666">&quot;</font><font color="#006666">x</font><font color="#006666">&quot;</font> <font color="#006633">}</font><br />    <font color="#006633">{</font> <font color="#006666">&quot;</font><font color="#006666">int</font><font color="#006666">&quot;</font> <font color="#006666">&quot;</font><font color="#006666">y</font><font color="#006666">&quot;</font> <font color="#006633">}</font><br />    <font color="#006633">{</font> <font color="#006666">&quot;</font><font color="#006666">int</font><font color="#006666">&quot;</font> <font color="#006666">&quot;</font><font color="#006666">width</font><font color="#006666">&quot;</font> <font color="#006633">}</font><br />    <font color="#006633">{</font> <font color="#006666">&quot;</font><font color="#006666">int</font><font color="#006666">&quot;</font> <font color="#006666">&quot;</font><font color="#006666">height</font><font color="#006666">&quot;</font> <font color="#006633">}</font> <font color="#000000"><strong>;</strong></font><br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>PangoRectangle&gt;rect</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>PangoRectangle</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>rect</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#006633">[</font> <font color="#006633">[</font> PangoRectangle-x pango&gt;float <font color="#006633">]</font> <font color="#006633">[</font> PangoRectangle-y pango&gt;float <font color="#006633">]</font> bi 2array <font color="#006633">]</font><br />    <font color="#006633">[</font> <font color="#006633">[</font> PangoRectangle-width pango&gt;float <font color="#006633">]</font> <font color="#006633">[</font> PangoRectangle-height pango&gt;float <font color="#006633">]</font> bi 2array <font color="#006633">]</font> bi<br />    &lt;rect&gt; <font color="#000000"><strong>;</strong></font><br /></font></pre><br /><h3>UTF8 strings and string offsets</h3><br />The documentation for a few functions, such as <code>pango_layout_line_x_to_index()</code>, uses the following phrase: "the byte index for the grapheme in which the user clicked." What they really mean is the index of the first code point comprising the grapheme the user clicked, inside the UTF8-encoded string that you passed in when creating the layout.<br /><br />This works well in languages such as C and Ruby 1.8 where a string is just an array of UTF8-encoded bytes, but in Factor, strings are an abstract sequence of Unicode code points with the actual internal encoding hidden from the developer. The Factor FFI takes care of encoding and decoding strings for you, but in this case, I want to convert code point indices to byte indices and this requires some work.<br /><br />Consider a Unicode string such as "παν語". This string has 4 Unicode code points, so in Factor, it is a sequence of length 4. However, the UTF8 encoding of this string has 9 bytes:<br /><table><tr><td>π</td><td>2 bytes</td></tr><tr><td>α</td><td>2 bytes</td></tr><tr><td>ν</td><td>2 bytes</td></tr><tr><td>語</td><td>3 bytes</td></tr></table><br />So for example, byte index 4 corresponds to string index 2. To convert from a string index to a byte index, it suffices to take the head of the string, and UTF8 encode it, and look and the byte length of the result. Going in the other direction requires building a mapping from byte indices to string indices and doing a binary search on it. Here is the Factor code:<br /><pre><font color="#000000"><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>code-point-length</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>n</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>x</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    log2 <font color="#006633">{</font><br />        <font color="#006633">{</font> <font color="#006633">[</font> dup <font color="#ff0000">0</font> <font color="#ff0000">7</font> between? <font color="#006633">]</font> <font color="#006633">[</font> <font color="#ff0000">1</font> <font color="#006633">]</font> <font color="#006633">}</font><br />        <font color="#006633">{</font> <font color="#006633">[</font> dup <font color="#ff0000">8</font> <font color="#ff0000">11</font> between? <font color="#006633">]</font> <font color="#006633">[</font> <font color="#ff0000">2</font> <font color="#006633">]</font> <font color="#006633">}</font><br />        <font color="#006633">{</font> <font color="#006633">[</font> dup <font color="#ff0000">12</font> <font color="#ff0000">16</font> between? <font color="#006633">]</font> <font color="#006633">[</font> <font color="#ff0000">3</font> <font color="#006633">]</font> <font color="#006633">}</font><br />        <font color="#006633">{</font> <font color="#006633">[</font> dup <font color="#ff0000">17</font> <font color="#ff0000">21</font> between? <font color="#006633">]</font> <font color="#006633">[</font> <font color="#ff0000">4</font> <font color="#006633">]</font> <font color="#006633">}</font><br />    <font color="#006633">}</font> cond nip <font color="#000000"><strong>;</strong></font><br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>code-point-offsets</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>string</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>indices</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#ff0000">0</font> <font color="#006633">[</font> code-point-length + <font color="#006633">]</font> accumulate swap suffix <font color="#000000"><strong>;</strong></font><br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>utf8-index&gt;</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>n</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>string</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>n</strong></font><font color="#793b1c"><strong>'</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    code-point-offsets natural-search drop <font color="#000000"><strong>;</strong></font><br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>&gt;utf8-index</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>n</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>string</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>n</strong></font><font color="#793b1c"><strong>'</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    code-point-offsets nth <font color="#000000"><strong>;</strong></font><br /></font></pre><br />Note that <code>code-point-length</code> could've been written as <code>1string utf8 encode length</code>, but this implementation is slightly more efficient.<br /><h3>Font descriptions</h3><br />Pango has a pretty elaborate set of APIs for working with fonts. At this point, I only need the bare minimum, so I'm working with the <code>PangoFontDescription</code> type. Font descriptions are allocated and deallocated using a pair of functions:<br /><pre><font color="#000000">FUNCTION: PangoFontDescription*<br />pango_font_description_new <font color="#6600cc">( </font><font color="#6600cc">)</font> <font color="#000000"><strong>;</strong></font><br /><br />FUNCTION: void<br />pango_font_description_free <font color="#6600cc">( </font><font color="#793b1c"><strong>PangoFontDescription</strong></font><font color="#793b1c"><strong>*</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>desc</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> <font color="#000000"><strong>;</strong></font><br /><br />DESTRUCTOR: pango_font_description_free<br /></font></pre><br />Unlike Core Text, which uses Apple's Core Foundation for memory management and thus every object is reference counted with <code>CFRetain()</code> and <code>CFRelease()</code> functions used to manage the reference count, Pango takes a more ad-hoc approach. Some objects are reference counted using GLib's <code>gobject</code> support, others have their own refcounting, and others still just have a deallocation function without a reference count.<br /><br />Here is some code to create a <code>PangoFontDescription</code> from a Factor <code>font</code> instance:<br /><pre><font color="#000000">MEMO: (cache-font-description) <font color="#6600cc">( </font><font color="#793b1c"><strong>font</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>description</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#006633">[</font><br />        <font color="#006633">[</font> pango_font_description_new |pango_font_description_free <font color="#006633">]</font> dip <font color="#006633">{</font><br />            <font color="#006633">[</font> name&gt;&gt; pango_font_description_set_family <font color="#006633">]</font><br />            <font color="#006633">[</font> size&gt;&gt; float&gt;pango pango_font_description_set_size <font color="#006633">]</font><br />            <font color="#006633">[</font> bold?&gt;&gt; PANGO_WEIGHT_BOLD PANGO_WEIGHT_NORMAL ? pango_font_description_set_weight <font color="#006633">]</font><br />            <font color="#006633">[</font> italic?&gt;&gt; PANGO_STYLE_ITALIC PANGO_STYLE_NORMAL ? pango_font_description_set_style <font color="#006633">]</font><br />            <font color="#006633">[</font> drop <font color="#006633">]</font><br />        <font color="#006633">}</font> 2cleave<br />    <font color="#006633">]</font> with-destructors <font color="#000000"><strong>;</strong></font><br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>cache-font-description</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>font</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>description</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    strip-font-colors (cache-font-description) <font color="#000000"><strong>;</strong></font><br /></font></pre><br />Some things to note about the above code:<br /><ul><li>I'm using memoization to cache font descriptions</li><li>I use an on-error destructor (<code>|<i>foo</i></code>) to ensure that the font description is deallocated if anything inside the block fails</li><li>Since Factor font instances store foreground and background colors, whereas Pango font descriptions do not, I don't want to pollute the cache with lots of duplicates where only the keys differ in color, so I strip the colors out first.</li><li>Just like Core Text, Pango offers a lot more functionality than Factor's <code>font</code> objects can represent. I will look into exposing more of this functionality in a cross-platform manner over time.</li></ul><br />Unlike Core Text, where font objects can be interrogated for metrics information, Pango's support for font metrics seems pretty simple in comparison; only getting the ascent and descent is supported, and the values reported here don't seem to match the text as it is actually rendered on-screen. Because of this, I only ever get metrics information from text layouts, and not from the fonts themselves, so creating font descriptions is the only thing I need to do here.<br /><h3>Layouts</h3><br />Just as with Core Text, Pango has a data type representing a set of glyphs which have been laid out and positioned; you never draw strings directly. This recognizes the fact that glyph selection when rendering Unicode is a complex process and should be done ahead of time. Whereas in Core Text, the fundamental data type for this is the <code>CTLine</code>, Pango calls it a <code>PangoLayout</code>. Unlike Core Text, a <code>PangoLayout</code> can contain multiple lines of text, so it is more like a <code>CTParagraph</code> than a <code>CTLine</code>, but Factor's UI only renders single lines at a time so far.<br /><br />The Pango backend uses a tuple to store the Pango layout, a bitmap rendering, and several related values:<br /><pre>TUPLE: layout font string layout metrics ink-rect logical-rect image disposed ;</pre><br /><br />The first step is fill in the <code>layout</code> slot, which stores a pointer to a <code>PangoLayout</code>.<br /><br />Pango layouts can be created by calling <code>pango_layout_new()</code>, however when using the Cairo backend it is better to use <code>pango_cairo_create_layout()</code> instead. Once a layout has been created, you can set the text to render, and the font to render it with, by calling <code>pango_layout_set_text()</code> and <code>pango_layout_set_font_description()</code>.<br /><pre><font color="#000000">FUNCTION: PangoLayout*<br />pango_cairo_create_layout <font color="#6600cc">( </font><font color="#793b1c"><strong>cairo_t</strong></font><font color="#793b1c"><strong>*</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>cr</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> <font color="#000000"><strong>;</strong></font><br /><br />FUNCTION: void<br />pango_layout_set_text <font color="#6600cc">( </font><font color="#793b1c"><strong>PangoLayout</strong></font><font color="#793b1c"><strong>*</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>layout</strong></font><font color="#793b1c"><strong>,</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>char</strong></font><font color="#793b1c"><strong>*</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>text</strong></font><font color="#793b1c"><strong>,</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>int</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>length</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> <font color="#000000"><strong>;</strong></font><br /><br />FUNCTION: void<br />pango_layout_set_font_description <font color="#6600cc">( </font><font color="#793b1c"><strong>PangoLayout</strong></font><font color="#793b1c"><strong>*</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>layout</strong></font><font color="#793b1c"><strong>,</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>PangoFontDescription</strong></font><font color="#793b1c"><strong>*</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>desc</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> <font color="#000000"><strong>;</strong></font><br /></font></pre><br />Unfortunately, <code>pango_layout_set_text()</code> takes a null-terminated UTF8 string, so to avoid problems if the user accidentally passes in a string containing embedded nulls, I substitute all nulls for a zero-width non-breaking space.<br /><br />Here is the Factor code to create a Pango layout and set the text and font:<br /><pre><font color="#000000"><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>set-layout-font</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>font</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>layout</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    swap cache-font-description pango_layout_set_font_description <font color="#000000"><strong>;</strong></font><br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>set-layout-text</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>str</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>layout</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#000000"><strong>#! </strong></font><font color="#000000"><em>Replace</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>nulls</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>with</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>something</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>else</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>since</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>Pango</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>uses</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>null-terminated</em></font><br />    <font color="#000000"><strong>#! </strong></font><font color="#000000"><em>strings</em></font><br />    swap<br />    dup selection? <font color="#006633">[</font> string&gt;&gt; <font color="#006633">]</font> when<br />    <font color="#006633">{</font> <font color="#006633">{</font> <font color="#ff0000">0</font> <font color="#003333">CHAR:</font><font color="#003333"> </font><font color="#003333">zero-width-no-break-space</font> <font color="#006633">}</font> <font color="#006633">}</font> substitute<br />    <font color="#ff0000">-1</font> pango_layout_set_text <font color="#000000"><strong>;</strong></font><br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>&lt;PangoLayout&gt;</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>text</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>font</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>layout</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    dummy-cairo pango_cairo_create_layout |g_object_unref<br />    <font color="#006633">[</font> set-layout-font <font color="#006633">]</font> keep<br />    <font color="#006633">[</font> set-layout-text <font color="#006633">]</font> keep <font color="#000000"><strong>;</strong></font><br /></font></pre><br /><h3>Font metrics</h3><br />Last time I blogged about how Core Text makes a distinction between <a href="../02/metric-bounds-versus-image-bounds.html">image bounds and metric bounds</a>. A similar situation exists in Pango; they're called ink and logical bounds. To get both bounds from a layout, use the <code>pango_layout_get_extents()</code> function.<br /><pre><font color="#000000">FUNCTION: void<br />pango_layout_get_extents <font color="#6600cc">( </font><font color="#793b1c"><strong>PangoLayout</strong></font><font color="#793b1c"><strong>*</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>layout</strong></font><font color="#793b1c"><strong>,</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>PangoRectangle</strong></font><font color="#793b1c"><strong>*</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>ink_rect</strong></font><font color="#793b1c"><strong>,</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>PangoRectangle</strong></font><font color="#793b1c"><strong>*</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>logical_rect</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> <font color="#000000"><strong>;</strong></font><br /></font></pre><br />I showed the code to convert a <code>PangoRectangle</code> into a Factor <code>rect</code> above.<br /><br />To compute the ascent and descent, it suffices to compute one of them, since their sum is the height of the logical bounds. Since a Pango layout can contain multiple lines, getting a baseline involves getting an iterator, which iterates over lines, first.<br /><pre><font color="#000000">FUNCTION: PangoLayoutIter*<br />pango_layout_get_iter <font color="#6600cc">( </font><font color="#793b1c"><strong>PangoLayout</strong></font><font color="#793b1c"><strong>*</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>layout</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> <font color="#000000"><strong>;</strong></font><br /></font></pre><br />Now, the baseline of the first line can be obtained from the iterator:<br /><pre><font color="#000000">FUNCTION: int<br />pango_layout_iter_get_baseline <font color="#6600cc">( </font><font color="#793b1c"><strong>PangoLayoutIter</strong></font><font color="#793b1c"><strong>*</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>iter</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> <font color="#000000"><strong>;</strong></font><br /></font></pre><br />Iterators must be deallocated using a special function.<br /><pre><font color="#000000">FUNCTION: void<br />pango_layout_iter_free <font color="#6600cc">( </font><font color="#793b1c"><strong>PangoLayoutIter</strong></font><font color="#793b1c"><strong>*</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>iter</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font> <font color="#000000"><strong>;</strong></font><br /></font></pre><br />Here is the Factor code that puts it all together:<br /><pre><font color="#000000"><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>layout-baseline</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>layout</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>baseline</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    pango_layout_get_iter &amp;pango_layout_iter_free<br />    pango_layout_iter_get_baseline<br />    pango&gt;float <font color="#000000"><strong>;</strong></font><br /></font></pre><br />Since I only ever create single-line layouts, the descent is easy to compute; it is the height of the logical bounds minus the ascent.<br /><br />The other two relevant metrics are the <a href="../02/font-metrics-and-baseline-alignment.html">x-height and cap-height metrics</a> that I talked about in an earlier post. Pango doesn't provide a way to get these from the font itself, so I just measure them by hand:<br /><pre><font color="#000000"><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>glyph-height</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>font</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>string</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>y</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    swap &lt;PangoLayout&gt; &amp;g_object_unref layout-extents drop dim&gt;&gt; second <font color="#000000"><strong>;</strong></font><br /><br />MEMO: missing-font-metrics <font color="#6600cc">( </font><font color="#793b1c"><strong>font</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>metrics</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#000000"><strong>#! </strong></font><font color="#000000"><em>Pango</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>doesn't</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>provide</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>x-height</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>and</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>cap-height</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>but</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>Core</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>Text</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>does,</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>so</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>we</em></font><br />    <font color="#000000"><strong>#! </strong></font><font color="#000000"><em>simulate</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>them</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>on</em></font><font color="#000000"><em> </em></font><font color="#000000"><em>Pango.</em></font><br />    <font color="#006633">[</font><br />        <font color="#006633">[</font> metrics new <font color="#006633">]</font> dip<br />        cache-font-description<br />        <font color="#006633">[</font> <font color="#006666">&quot;</font><font color="#006666">x</font><font color="#006666">&quot;</font> glyph-height &gt;&gt;x-height <font color="#006633">]</font><br />        <font color="#006633">[</font> <font color="#006666">&quot;</font><font color="#006666">Y</font><font color="#006666">&quot;</font> glyph-height &gt;&gt;cap-height <font color="#006633">]</font> bi<br />    <font color="#006633">]</font> with-destructors <font color="#000000"><strong>;</strong></font><br /></font></pre><br /><h3>Rendering a layout</h3><br />There are several steps involved in rendering text to a bitmap:<br /><ul><li>Filling the background with the background color</li><li>Filling the selection rectangle, if one is set</li><li>Setting the foreground color</li><li>Setting the text position</li><li>Rendering the text layout</li></ul><br />The only interesting part is setting the text position. In Core Text, text is drawn with the intersection of the baseline and the caret at the origin. Pango works differently here; the origin is the top-left corner of the text's logical bounds. Here is a screenshot illustrating the ink and logical bounds:<br /><img src="http://factorcode.org/pango-bounds.png"><br />So we want to position the text so that the upper-left corner is at the origin relative to the logical bounds. Here is the Factor code to subtract the logical origin from the image origin:<br /><pre><font color="#000000"><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>text-position</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>layout</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>loc</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    <font color="#006633">[</font> logical-rect&gt;&gt; <font color="#006633">]</font> <font color="#006633">[</font> ink-rect&gt;&gt; <font color="#006633">]</font> bi <font color="#006633">[</font> loc&gt;&gt; <font color="#006633">]</font> bi@ v- <font color="#000000"><strong>;</strong></font><br /><br /><font color="#000000"><strong>:</strong></font><font color="#000000"><strong> </strong></font><font color="#000000"><strong>set-text-position</strong></font> <font color="#6600cc">( </font><font color="#793b1c"><strong>cr</strong></font><font color="#793b1c"><strong> </strong></font><font color="#793b1c"><strong>loc</strong></font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">--</font><font color="#793b1c"><strong> </strong></font><font color="#6600cc">)</font><br />    first2 cairo_move_to <font color="#000000"><strong>;</strong></font><br /></font></pre><br /><h3>Conclusion</h3><br />Implementing Unicode text rendering via Core Text and Pango (and putting a cross-platform abstraction layer on top) was a fair amount of work, but now I've achieved one of my big goals for Factor 1.0, Unicode text rendering. There are still a few missing details before the Factor UI is truly Unicode-perfect, but this is an important step. Along with Daniel Ehrenberg's <a href="http://docs.factorcode.org/content/article-unicode.html">Unicode vocabulary</a> and the large number of <a href="http://docs.factorcode.org/content/vocab-io.encodings.html">I/O encodings</a> supported, Factor's Unicode support is better than most other languages, especially non-mainstream ones, and that is quite an accomplishment for a small team and a few years of work.
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'>
<span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://factor-language.blogspot.com/2009/03/rendering-unicode-text-with-pango-and.html' itemprop='url'/>
<a class='timestamp-link' href='rendering-unicode-text-with-pango-and.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2009-03-03T13:27:00-05:00'>1:27 PM</abbr></a>
</span>
<span class='post-comment-link'>
</span>
<span class='post-icons'>
<span class='item-action'>
<a href='https://www.blogger.com/email-post.g?blogID=17087850&postID=7405626662862773190' title='Email Post'>
<img alt='' class='icon-action' height='13' src='https://resources.blogblog.com/img/icon18_email.gif' width='18'/>
</a>
</span>
<span class='item-control blog-admin pid-561774689'>
<a href='https://www.blogger.com/post-edit.g?blogID=17087850&postID=7405626662862773190&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7405626662862773190&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7405626662862773190&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7405626662862773190&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7405626662862773190&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=17087850&postID=7405626662862773190&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a>
</div>
</div>
<div class='post-footer-line post-footer-line-2'>
<span class='post-labels'>
</span>
</div>
<div class='post-footer-line post-footer-line-3'>
<span class='post-location'>
</span>
</div>
</div>
</div>
<div class='comments' id='comments'>
<a name='comments'></a>
<h4>1 comment:</h4>
<div id='Blog1_comments-block-wrapper'>
<dl class='avatar-comment-indent' id='comments-block'>
<dt class='comment-author ' id='c3042811075359781502'>
<a name='c3042811075359781502'></a>
<div class="avatar-image-container avatar-stock"><span dir="ltr"><img src="http://resources.blogblog.com/img/blank.gif" width="35" height="35" alt="" title="Anonymous">

</span></div>
Anonymous
said...
</dt>
<dd class='comment-body' id='Blog1_cmt-3042811075359781502'>
<p>
How about render unicode text of a font to svg file? here is a python script:<BR/><BR/>http://code.google.com/p/fontindustry/downloads/list
</p>
</dd>
<dd class='comment-footer'>
<span class='comment-timestamp'>
<a href='http://factor-language.blogspot.com/2009/03/rendering-unicode-text-with-pango-and.html?showComment=1236250980000#c3042811075359781502' title='comment permalink'>
6:03 AM
</a>
<span class='item-control blog-admin pid-772668958'>
<a class='comment-delete' href='https://www.blogger.com/delete-comment.g?blogID=17087850&postID=3042811075359781502' title='Delete Comment'>
<img src='https://resources.blogblog.com/img/icon_delete13.gif'/>
</a>
</span>
</span>
</dd>
</dl>
</div>
<p class='comment-footer'>
<a href='https://www.blogger.com/comment.g?blogID=17087850&postID=7405626662862773190' onclick=''>Post a Comment</a>
</p>
</div>
</div>

        </div></div>
      
</div>
<div class='blog-pager' id='blog-pager'>
<span id='blog-pager-newer-link'>
<a class='blog-pager-newer-link' href='better-static-safety-for-higher-order.html' id='Blog1_blog-pager-newer-link' title='Newer Post'>Newer Post</a>
</span>
<span id='blog-pager-older-link'>
<a class='blog-pager-older-link' href='../02/metric-bounds-versus-image-bounds.html' id='Blog1_blog-pager-older-link' title='Older Post'>Older Post</a>
</span>
<a class='home-link' href='../../index.html'>Home</a>
</div>
<div class='clear'></div>
<div class='post-feeds'>
<div class='feed-links'>
Subscribe to:
<a class='feed-link' href='http://factor-language.blogspot.com/feeds/7405626662862773190/comments/default' target='_blank' type='application/atom+xml'>Post Comments (Atom)</a>
</div>
</div>
</div></div>
</div>
<div id='sidebar-wrapper'>
<div class='sidebar section' id='sidebar'><div class='widget BlogArchive' data-version='1' id='BlogArchive1'>
<h2>Older Posts</h2>
<div class='widget-content'>
<div id='ArchiveList'>
<div id='BlogArchive1_ArchiveList'>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2010/index.html'>
2010
</a>
<span class='post-count' dir='ltr'>(18)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2010/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2010/07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2010/05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2010/04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2010/03/index.html'>
March
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2010/02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2010/01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='../index.html'>
2009
</a>
<span class='post-count' dir='ltr'>(35)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../08/index.html'>
August
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='index.html'>
March
</a>
<span class='post-count' dir='ltr'>(2)</span>
<ul class='posts'>
<li><a href='better-static-safety-for-higher-order.html'>Better static safety for higher-order code</a></li>
<li><a href='rendering-unicode-text-with-pango-and.html'>Rendering Unicode text with Pango and Cairo</a></li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(6)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2008/index.html'>
2008
</a>
<span class='post-count' dir='ltr'>(96)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2008/12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2008/11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2008/10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2008/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2008/08/index.html'>
August
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2008/07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2008/06/index.html'>
June
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2008/05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(6)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2008/04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(13)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2008/03/index.html'>
March
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2008/02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(17)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2008/01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2007/index.html'>
2007
</a>
<span class='post-count' dir='ltr'>(141)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2007/12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2007/11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(13)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2007/10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(10)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2007/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(15)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2007/08/index.html'>
August
</a>
<span class='post-count' dir='ltr'>(21)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2007/07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2007/06/index.html'>
June
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2007/05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2007/04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2007/03/index.html'>
March
</a>
<span class='post-count' dir='ltr'>(9)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2007/02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2007/01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(15)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2006/index.html'>
2006
</a>
<span class='post-count' dir='ltr'>(207)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2006/12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(23)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2006/11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(30)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2006/10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(25)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2006/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(22)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2006/08/index.html'>
August
</a>
<span class='post-count' dir='ltr'>(26)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2006/07/index.html'>
July
</a>
<span class='post-count' dir='ltr'>(23)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2006/06/index.html'>
June
</a>
<span class='post-count' dir='ltr'>(11)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2006/05/index.html'>
May
</a>
<span class='post-count' dir='ltr'>(15)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2006/04/index.html'>
April
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2006/03/index.html'>
March
</a>
<span class='post-count' dir='ltr'>(11)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2006/02/index.html'>
February
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2006/01/index.html'>
January
</a>
<span class='post-count' dir='ltr'>(12)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2005/index.html'>
2005
</a>
<span class='post-count' dir='ltr'>(23)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2005/12/index.html'>
December
</a>
<span class='post-count' dir='ltr'>(11)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2005/11/index.html'>
November
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2005/10/index.html'>
October
</a>
<span class='post-count' dir='ltr'>(6)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='../../2005/09/index.html'>
September
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class='clear'></div>
</div>
</div><div class='widget Feed' data-version='1' id='Feed2'>
<h2>Recent Factor Commits</h2>
<div class='widget-content' id='Feed2_feedItemListDisplay'>
<span style='filter: alpha(25); opacity: 0.25;'>
<a href='http://gitweb.factorcode.org/gitweb.cgi?p=factor.git;a=atom'>Loading...</a>
</span>
</div>
<div class='clear'></div>
</div><div class='widget Feed' data-version='1' id='Feed1'>
<h2>Planet Factor</h2>
<div class='widget-content' id='Feed1_feedItemListDisplay'>
<span style='filter: alpha(25); opacity: 0.25;'>
<a href='http://planet.factorcode.org/feed.xml'>Loading...</a>
</span>
</div>
<div class='clear'></div>
</div><div class='widget LinkList' data-version='1' id='LinkList1'>
<h2>Links</h2>
<div class='widget-content'>
<ul>
<li><a href='http://twitter.com/slava_pestov'>@slava_pestov</a></li>
<li><a href='http://factorcode.org/slava/'>My home page</a></li>
<li><a href='http://factorcode.org/'>Factor programming language</a></li>
<li><a href='http://concatenative.org/'>Concatenative language wiki</a></li>
<li><a href='http://planet.factorcode.org/'>Planet Factor</a></li>
</ul>
<div class='clear'></div>
</div>
</div></div>
</div>
<!-- spacer for skins that want sidebar and main to be the same height-->
<div class='clear'>&#160;</div>
</div>
<!-- end content-wrapper -->
<div id='footer-wrapper'>
<div class='footer no-items section' id='footer'></div>
</div>
</div></div>
<!-- end outer-wrapper -->

<script type="text/javascript" src="https://www.blogger.com/static/v1/widgets/940443484-widgets.js"></script>
<script type='text/javascript'>
window['__wavt'] = 'AOuZoY7MmzRWto2iWVLHEWfcGMijbAbVJg:1693932852355';_WidgetManager._Init('//www.blogger.com/rearrange?blogID\x3d17087850','//factor-language.blogspot.com/2009/03/rendering-unicode-text-with-pango-and.html','17087850');
_WidgetManager._SetDataContext([{'name': 'blog', 'data': {'blogId': '17087850', 'title': 'Factor: a practical stack language', 'url': 'http://factor-language.blogspot.com/2009/03/rendering-unicode-text-with-pango-and.html', 'canonicalUrl': 'http://factor-language.blogspot.com/2009/03/rendering-unicode-text-with-pango-and.html', 'homepageUrl': 'http://factor-language.blogspot.com/', 'searchUrl': 'http://factor-language.blogspot.com/search', 'canonicalHomepageUrl': 'http://factor-language.blogspot.com/', 'blogspotFaviconUrl': 'http://factor-language.blogspot.com/favicon.ico', 'bloggerUrl': 'https://www.blogger.com', 'hasCustomDomain': false, 'httpsEnabled': true, 'enabledCommentProfileImages': true, 'gPlusViewType': 'FILTERED_POSTMOD', 'adultContent': false, 'analyticsAccountNumber': '', 'encoding': 'UTF-8', 'locale': 'en-US', 'localeUnderscoreDelimited': 'en', 'languageDirection': 'ltr', 'isPrivate': false, 'isMobile': false, 'isMobileRequest': false, 'mobileClass': '', 'isPrivateBlog': false, 'isDynamicViewsAvailable': true, 'feedLinks': '\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Factor: a practical stack language - Atom\x22 href\x3d\x22http://factor-language.blogspot.com/feeds/posts/default\x22 /\x3e\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/rss+xml\x22 title\x3d\x22Factor: a practical stack language - RSS\x22 href\x3d\x22http://factor-language.blogspot.com/feeds/posts/default?alt\x3drss\x22 /\x3e\n\x3clink rel\x3d\x22service.post\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Factor: a practical stack language - Atom\x22 href\x3d\x22https://www.blogger.com/feeds/17087850/posts/default\x22 /\x3e\n\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Factor: a practical stack language - Atom\x22 href\x3d\x22http://factor-language.blogspot.com/feeds/7405626662862773190/comments/default\x22 /\x3e\n', 'meTag': '', 'adsenseHostId': 'ca-host-pub-1556223355139109', 'adsenseHasAds': false, 'adsenseAutoAds': false, 'boqCommentIframeForm': true, 'loginRedirectParam': '', 'view': '', 'dynamicViewsCommentsSrc': '//www.blogblog.com/dynamicviews/4224c15c4e7c9321/js/comments.js', 'dynamicViewsScriptSrc': '//www.blogblog.com/dynamicviews/591781cadcbb8744', 'plusOneApiSrc': 'https://apis.google.com/js/platform.js', 'disableGComments': true, 'interstitialAccepted': false, 'sharing': {'platforms': [{'name': 'Get link', 'key': 'link', 'shareMessage': 'Get link', 'target': ''}, {'name': 'Facebook', 'key': 'facebook', 'shareMessage': 'Share to Facebook', 'target': 'facebook'}, {'name': 'BlogThis!', 'key': 'blogThis', 'shareMessage': 'BlogThis!', 'target': 'blog'}, {'name': 'Twitter', 'key': 'twitter', 'shareMessage': 'Share to Twitter', 'target': 'twitter'}, {'name': 'Pinterest', 'key': 'pinterest', 'shareMessage': 'Share to Pinterest', 'target': 'pinterest'}, {'name': 'Email', 'key': 'email', 'shareMessage': 'Email', 'target': 'email'}], 'disableGooglePlus': true, 'googlePlusShareButtonWidth': 0, 'googlePlusBootstrap': '\x3cscript type\x3d\x22text/javascript\x22\x3ewindow.___gcfg \x3d {\x27lang\x27: \x27en\x27};\x3c/script\x3e'}, 'hasCustomJumpLinkMessage': false, 'jumpLinkMessage': 'Read more', 'pageType': 'item', 'postId': '7405626662862773190', 'postImageUrl': 'http://factorcode.org/pango-bounds.png', 'pageName': 'Rendering Unicode text with Pango and Cairo', 'pageTitle': 'Factor: a practical stack language: Rendering Unicode text with Pango and Cairo'}}, {'name': 'features', 'data': {}}, {'name': 'messages', 'data': {'edit': 'Edit', 'linkCopiedToClipboard': 'Link copied to clipboard!', 'ok': 'Ok', 'postLink': 'Post Link'}}, {'name': 'template', 'data': {'isResponsive': false, 'isAlternateRendering': false, 'isCustom': false}}, {'name': 'view', 'data': {'classic': {'name': 'classic', 'url': '?view\x3dclassic'}, 'flipcard': {'name': 'flipcard', 'url': '?view\x3dflipcard'}, 'magazine': {'name': 'magazine', 'url': '?view\x3dmagazine'}, 'mosaic': {'name': 'mosaic', 'url': '?view\x3dmosaic'}, 'sidebar': {'name': 'sidebar', 'url': '?view\x3dsidebar'}, 'snapshot': {'name': 'snapshot', 'url': '?view\x3dsnapshot'}, 'timeslide': {'name': 'timeslide', 'url': '?view\x3dtimeslide'}, 'isMobile': false, 'title': 'Rendering Unicode text with Pango and Cairo', 'description': 'I implemented a Pango backend for text rendering in the Factor UI. This means that new_ui  now works on Windows and X11 (well, not quite; I ...', 'featuredImage': 'https://lh3.googleusercontent.com/blogger_img_proxy/AAOd8MxPjI3TWCM8_TNGXDfknQXCpnVbmN9-hr5UqljeT6phh3kr4msFLTApDry4qgcLDKuzRxQ86x9otpxgT7V1ik1X6mHaVZNdeKdL', 'url': 'http://factor-language.blogspot.com/2009/03/rendering-unicode-text-with-pango-and.html', 'type': 'item', 'isSingleItem': true, 'isMultipleItems': false, 'isError': false, 'isPage': false, 'isPost': true, 'isHomepage': false, 'isArchive': false, 'isLabelSearch': false, 'postId': 7405626662862773190}}]);
_WidgetManager._RegisterWidget('_NavbarView', new _WidgetInfo('Navbar1', 'navbar', document.getElementById('Navbar1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_HeaderView', new _WidgetInfo('Header1', 'header', document.getElementById('Header1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogView', new _WidgetInfo('Blog1', 'main', document.getElementById('Blog1'), {'cmtInteractionsEnabled': false, 'lightboxEnabled': true, 'lightboxModuleUrl': 'https://www.blogger.com/static/v1/jsbin/1333563935-lbx.js', 'lightboxCssUrl': 'https://www.blogger.com/static/v1/v-css/3268905543-lightbox_bundle.css'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogArchiveView', new _WidgetInfo('BlogArchive1', 'sidebar', document.getElementById('BlogArchive1'), {'languageDirection': 'ltr', 'loadingMessage': 'Loading\x26hellip;'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_FeedView', new _WidgetInfo('Feed2', 'sidebar', document.getElementById('Feed2'), {'title': 'Recent Factor Commits', 'showItemDate': true, 'showItemAuthor': true, 'feedUrl': 'http://gitweb.factorcode.org/gitweb.cgi?p\x3dfactor.git;a\x3datom', 'numItemsShow': 5, 'loadingMsg': 'Loading...', 'openLinksInNewWindow': false, 'useFeedWidgetServ': 'true'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_FeedView', new _WidgetInfo('Feed1', 'sidebar', document.getElementById('Feed1'), {'title': 'Planet Factor', 'showItemDate': true, 'showItemAuthor': false, 'feedUrl': 'http://planet.factorcode.org/feed.xml', 'numItemsShow': 5, 'loadingMsg': 'Loading...', 'openLinksInNewWindow': false, 'useFeedWidgetServ': 'true'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_LinkListView', new _WidgetInfo('LinkList1', 'sidebar', document.getElementById('LinkList1'), {}, 'displayModeFull'));
</script>
</body>
</html>